<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">

<link rel="icon" href="/favicon.ico" type="image/x-icon"> 
<title>D2L--ç¬¬ä¹ç« ç°ä»£å¾ªç¯ç¥ç»ç½‘ç»œ | Li&#39;s Bioinfo-Blog</title>
<meta name="keywords" content="æ·±åº¦å­¦ä¹ , D2L">
<meta name="description" content="1. é—¨æ§å¾ªç¯å•å…ƒ(GRU)

ä¼ ç»Ÿçš„RNNåœ¨å¤„ç†é•¿åºåˆ—æ—¶ä¼šé‡åˆ°æ¢¯åº¦æ¶ˆå¤±æˆ–æ¢¯åº¦çˆ†ç‚¸çš„é—®é¢˜ã€‚ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œå¼•å…¥äº†é—¨æ§æœºåˆ¶çš„å˜ç§ï¼Œå¦‚é•¿çŸ­æ—¶è®°å¿†ç½‘ç»œï¼ˆLSTM, long short-term memoryï¼‰å’Œé—¨æ§å¾ªç¯å•å…ƒï¼ˆGRU, gated recurrent unitï¼‰ã€‚GRUæ˜¯LSTMçš„ä¸€ä¸ªç®€åŒ–ç‰ˆæœ¬ï¼Œå®ƒé€šè¿‡åˆå¹¶æŸäº›é—¨å¹¶å‡å°‘å‚æ•°æ•°é‡æ¥æé«˜æ•ˆç‡ã€‚">
<meta name="author" content="Lishensuo">
<link rel="canonical" href="https://lishensuo.github.io/en/posts/bioinfo/712d2l-%E7%AC%AC%E4%B9%9D%E7%AB%A0%E7%8E%B0%E4%BB%A3%E5%BE%AA%E7%8E%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.9e4de5e3ba61ea358168341aa7cdf70abfaafb7c697dfe8624af3ddff9a35c2f.css" integrity="sha256-nk3l47ph6jWBaDQap833Cr&#43;q&#43;3xpff6GJK893/mjXC8=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.555af97124d54bb1457985dd081b8f5616a48103aafeb30ac89fde835d65aa6c.js" integrity="sha256-VVr5cSTVS7FFeYXdCBuPVhakgQOq/rMKyJ/eg11lqmw="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://lishensuo.github.io/img/Q.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://lishensuo.github.io/img/Q.gif">
<link rel="icon" type="image/png" sizes="32x32" href="https://lishensuo.github.io/img/Q.gif">
<link rel="apple-touch-icon" href="https://lishensuo.github.io/Q.gif">
<link rel="mask-icon" href="https://lishensuo.github.io/Q.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://lishensuo.github.io/en/posts/bioinfo/712d2l-%E7%AC%AC%E4%B9%9D%E7%AB%A0%E7%8E%B0%E4%BB%A3%E5%BE%AA%E7%8E%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="D2L--ç¬¬ä¹ç« ç°ä»£å¾ªç¯ç¥ç»ç½‘ç»œ" />
<meta property="og:description" content="1. é—¨æ§å¾ªç¯å•å…ƒ(GRU)

ä¼ ç»Ÿçš„RNNåœ¨å¤„ç†é•¿åºåˆ—æ—¶ä¼šé‡åˆ°æ¢¯åº¦æ¶ˆå¤±æˆ–æ¢¯åº¦çˆ†ç‚¸çš„é—®é¢˜ã€‚ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œå¼•å…¥äº†é—¨æ§æœºåˆ¶çš„å˜ç§ï¼Œå¦‚é•¿çŸ­æ—¶è®°å¿†ç½‘ç»œï¼ˆLSTM, long short-term memoryï¼‰å’Œé—¨æ§å¾ªç¯å•å…ƒï¼ˆGRU, gated recurrent unitï¼‰ã€‚GRUæ˜¯LSTMçš„ä¸€ä¸ªç®€åŒ–ç‰ˆæœ¬ï¼Œå®ƒé€šè¿‡åˆå¹¶æŸäº›é—¨å¹¶å‡å°‘å‚æ•°æ•°é‡æ¥æé«˜æ•ˆç‡ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://lishensuo.github.io/en/posts/bioinfo/712d2l-%E7%AC%AC%E4%B9%9D%E7%AB%A0%E7%8E%B0%E4%BB%A3%E5%BE%AA%E7%8E%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-08-11T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2024-08-11T00:00:00&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="D2L--ç¬¬ä¹ç« ç°ä»£å¾ªç¯ç¥ç»ç½‘ç»œ"/>
<meta name="twitter:description" content="1. é—¨æ§å¾ªç¯å•å…ƒ(GRU)

ä¼ ç»Ÿçš„RNNåœ¨å¤„ç†é•¿åºåˆ—æ—¶ä¼šé‡åˆ°æ¢¯åº¦æ¶ˆå¤±æˆ–æ¢¯åº¦çˆ†ç‚¸çš„é—®é¢˜ã€‚ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œå¼•å…¥äº†é—¨æ§æœºåˆ¶çš„å˜ç§ï¼Œå¦‚é•¿çŸ­æ—¶è®°å¿†ç½‘ç»œï¼ˆLSTM, long short-term memoryï¼‰å’Œé—¨æ§å¾ªç¯å•å…ƒï¼ˆGRU, gated recurrent unitï¼‰ã€‚GRUæ˜¯LSTMçš„ä¸€ä¸ªç®€åŒ–ç‰ˆæœ¬ï¼Œå®ƒé€šè¿‡åˆå¹¶æŸäº›é—¨å¹¶å‡å°‘å‚æ•°æ•°é‡æ¥æé«˜æ•ˆç‡ã€‚"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "åˆ†ç±»",
      "item": "https://lishensuo.github.io/en/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ“– ç”Ÿä¿¡æ•°æ®åˆ†æ--åˆ†ææµç¨‹ï¼Œå·¥å…·åŒ…ç­‰",
      "item": "https://lishensuo.github.io/en/posts/bioinfo/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "D2L--ç¬¬ä¹ç« ç°ä»£å¾ªç¯ç¥ç»ç½‘ç»œ",
      "item": "https://lishensuo.github.io/en/posts/bioinfo/712d2l-%E7%AC%AC%E4%B9%9D%E7%AB%A0%E7%8E%B0%E4%BB%A3%E5%BE%AA%E7%8E%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "D2L--ç¬¬ä¹ç« ç°ä»£å¾ªç¯ç¥ç»ç½‘ç»œ",
  "name": "D2L--ç¬¬ä¹ç« ç°ä»£å¾ªç¯ç¥ç»ç½‘ç»œ",
  "description": "1. é—¨æ§å¾ªç¯å•å…ƒ(GRU) ä¼ ç»Ÿçš„RNNåœ¨å¤„ç†é•¿åºåˆ—æ—¶ä¼šé‡åˆ°æ¢¯åº¦æ¶ˆå¤±æˆ–æ¢¯åº¦çˆ†ç‚¸çš„é—®é¢˜ã€‚ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œå¼•å…¥äº†é—¨æ§æœºåˆ¶çš„å˜ç§ï¼Œå¦‚é•¿çŸ­æ—¶è®°å¿†ç½‘ç»œï¼ˆLSTM, long short-term memoryï¼‰å’Œé—¨æ§å¾ªç¯å•å…ƒï¼ˆGRU, gated recurrent unitï¼‰ã€‚GRUæ˜¯LSTMçš„ä¸€ä¸ªç®€åŒ–ç‰ˆæœ¬ï¼Œå®ƒé€šè¿‡åˆå¹¶æŸäº›é—¨å¹¶å‡å°‘å‚æ•°æ•°é‡æ¥æé«˜æ•ˆç‡ã€‚\n",
  "keywords": [
    "æ·±åº¦å­¦ä¹ ", "D2L"
  ],
  "articleBody": "1. é—¨æ§å¾ªç¯å•å…ƒ(GRU) ä¼ ç»Ÿçš„RNNåœ¨å¤„ç†é•¿åºåˆ—æ—¶ä¼šé‡åˆ°æ¢¯åº¦æ¶ˆå¤±æˆ–æ¢¯åº¦çˆ†ç‚¸çš„é—®é¢˜ã€‚ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œå¼•å…¥äº†é—¨æ§æœºåˆ¶çš„å˜ç§ï¼Œå¦‚é•¿çŸ­æ—¶è®°å¿†ç½‘ç»œï¼ˆLSTM, long short-term memoryï¼‰å’Œé—¨æ§å¾ªç¯å•å…ƒï¼ˆGRU, gated recurrent unitï¼‰ã€‚GRUæ˜¯LSTMçš„ä¸€ä¸ªç®€åŒ–ç‰ˆæœ¬ï¼Œå®ƒé€šè¿‡åˆå¹¶æŸäº›é—¨å¹¶å‡å°‘å‚æ•°æ•°é‡æ¥æé«˜æ•ˆç‡ã€‚\n1.1 é—¨æ§éšè—çŠ¶æ€ ï¼ˆ1ï¼‰é‡ç½®é—¨ä¸æ›´æ–°é—¨\né€šè¿‡æ”¯æŒå¯¹éšçŠ¶æ€çš„é—¨æ§ï¼Œæ¨¡å‹å¯ä»¥å­¦ä¹ åºåˆ—ä¸­ç›¸å¯¹é‡è¦çš„è¯å…ƒï¼Œè·³è¿‡ä¸å¤ªç›¸å…³çš„è¯å…ƒã€‚GRUåŒ…æ‹¬äº†ä¸¤ä¸ªé—¨æ§å•å…ƒï¼š\né‡ç½®é—¨ï¼šå†³å®šä¸Šä¸€æ—¶åˆ»çš„éšè—çŠ¶æ€(Htâˆ’1)æœ‰å¤šå°‘ä¿¡æ¯éœ€è¦è¢«â€œé‡ç½®â€æˆ–å¿½ç•¥ï¼Œè®¡ç®—å€™é€‰éšçŠ¶æ€; æ›´æ–°é—¨ï¼šå†³å®šå¤šå°‘æ—§çŠ¶æ€(Ht-1)åº”è¯¥è¢«ä¿ç•™ï¼Œå¤šå°‘æ–°çŠ¶æ€(å³ä¸Šé¢çš„å€™é€‰éšçŠ¶æ€ï¼ŒåŒ…æ‹¬æ–°è¾“å…¥çš„Xt)åº”è¯¥è¢«æ·»åŠ åˆ°å½“å‰çŠ¶æ€ä¸­ã€‚ è®¡ç®—ä¸Šè¿°ä¸¤ä¸ªé—¨æ§å•å…ƒçš„æ–¹å¼ä¸RNNä¸­Htçš„è®¡ç®—å…¬å¼åŸºæœ¬ä¸€è‡´ï¼Œåªæ˜¯æ¿€æ´»å‡½æ•°é€‰æ‹©ä¸åŒã€‚è¿™é‡Œä½¿ç”¨çš„Sigmoidï¼Œä½¿å¾—è½¬æ¢ä¸º0~1èŒƒå›´ï¼Œæ–¹ä¾¿åç»­çš„æ§åˆ¶æ“ä½œã€‚ ï¼ˆ2ï¼‰å€™é€‰éšçŠ¶æ€\nå¯é€šè¿‡é‡ç½®é—¨ï¼Œæ¥æ§åˆ¶ç”Ÿæˆå€™é€‰éšçŠ¶æ€ã€‚ Rt = 1æ—¶ï¼Œå°±æ˜¯åŸºæœ¬çš„RNNå±‚ï¼ˆåŒ…å«Ht-1ä¸Xtï¼‰ï¼› Rt = 0æ—¶ï¼Œä¸Šä¸€æ­¥çš„éšçŠ¶æ€ä¼šè¢«é‡ç½®/å¿½ç•¥ï¼Œä»…è€ƒè™‘Xtè¾“å…¥ã€‚ ï¼ˆ3ï¼‰éšçŠ¶æ€\næ›´æ–°é—¨å¯ä»¥æ§åˆ¶æœ€ç»ˆéšçŠ¶æ€çš„è¾“å‡ºï¼Œç”¨äºé¢„æµ‹Ot Zt = 0æ—¶ï¼Œä¼šå…¨éƒ¨ä½¿ç”¨ä¸Šè¿°çš„å€™é€‰éšçŠ¶æ€ï¼ˆåŒ…å«Xtï¼‰ Zt = 1æ—¶ï¼Œä¼šä¸¢å¼ƒå€™é€‰éšçŠ¶æ€ï¼Œç›´æ¥ç»§æ‰¿å‰ä¸€éšè—çŠ¶æ€çš„Ht-1 è‹¥æ•´ä¸ªå­åºåˆ—çš„æ‰€æœ‰æ—¶é—´æ­¥çš„æ›´æ–°é—¨éƒ½æ¥è¿‘1ï¼Œåˆ™åºåˆ—èµ·å§‹æ—¶é—´æ­¥çš„éšçŠ¶æ€å°†å¾ˆå®¹æ˜“ä¿ç•™ã€å¹¶ä¼ é€’åˆ°åºåˆ—ç»“æŸã€‚ ç»¼ä¸Šï¼Œ\né‡ç½®é—¨å¯ä»¥æ§åˆ¶å¤šå¤§ç¨‹åº¦è·å¾—ä¸Šä¸€æ­¥éª¤çš„éšçŠ¶æ€ï¼Œæœ‰åŠ©äºæ•è·åºåˆ—ä¸­çš„çŸ­æœŸä¾èµ–å…³ç³»ã€‚ æ›´æ–°é—¨å¯ä»¥æ§åˆ¶å¤šå¤§ç¨‹åº¦å­¦ä¹ å½“å‰æ­¥éª¤(Xt)çš„è§‚æµ‹ï¼Œæœ‰åŠ©äºæ•è·åºåˆ—ä¸­çš„é•¿æœŸä¾èµ–å…³ç³»ã€‚ 1.2 ä»é›¶å¼€å§‹å®ç° åŠ è½½æ•°æ® 1 2 3 4 5 6 import torch from torch import nn from d2l import torch as d2l batch_size, num_steps = 32, 35 train_iter, vocab = d2l.load_data_time_machine(batch_size, num_steps) ï¼ˆ1ï¼‰åˆå§‹åŒ–æ¨¡å‹å‚æ•°\nä¸RNNç›¸æ¯”ï¼Œå¤šäº†æ›´æ–°é—¨ä¸é‡ç½®é—¨çš„æ¨¡å‹å‚æ•° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 def get_params(vocab_size, num_hiddens, device): num_inputs = num_outputs = vocab_size def normal(shape): return torch.randn(size=shape, device=device)*0.01 def three(): return (normal((num_inputs, num_hiddens)), normal((num_hiddens, num_hiddens)), torch.zeros(num_hiddens, device=device)) W_xz, W_hz, b_z = three() # æ›´æ–°é—¨å‚æ•° W_xr, W_hr, b_r = three() # é‡ç½®é—¨å‚æ•° W_xh, W_hh, b_h = three() # å€™é€‰éšçŠ¶æ€å‚æ•° # è¾“å‡ºå±‚å‚æ•° W_hq = normal((num_hiddens, num_outputs)) b_q = torch.zeros(num_outputs, device=device) # é™„åŠ æ¢¯åº¦ params = [W_xz, W_hz, b_z, W_xr, W_hr, b_r, W_xh, W_hh, b_h, W_hq, b_q] for param in params: param.requires_grad_(True) return params ï¼ˆ2ï¼‰å®šä¹‰æ¨¡å‹\néšçŠ¶æ€åˆå§‹åŒ–å‡½æ•°ï¼Œä¸ä¹‹å‰RNNä¸€æ · 1 2 def init_gru_state(batch_size, num_hiddens, device): return (torch.zeros((batch_size, num_hiddens), device=device), ) å®šä¹‰GRUæ¨¡å‹çš„ä¼ æ’­, @è¡¨ç¤ºæŒ‰å…ƒç´ ç›¸ä¹˜çš„çŸ©é˜µä¹˜æ³• 1 2 3 4 5 6 7 8 9 10 11 12 def gru(inputs, state, params): W_xz, W_hz, b_z, W_xr, W_hr, b_r, W_xh, W_hh, b_h, W_hq, b_q = params H, = state outputs = [] for X in inputs: Z = torch.sigmoid((X @ W_xz) + (H @ W_hz) + b_z) #æ›´æ–°é—¨ R = torch.sigmoid((X @ W_xr) + (H @ W_hr) + b_r) #é‡ç½®é—¨ H_tilda = torch.tanh((X @ W_xh) + ((R * H) @ W_hh) + b_h) #å€™é€‰éšçŠ¶æ€ H = Z * H + (1 - Z) * H_tilda Y = H @ W_hq + b_q outputs.append(Y) return torch.cat(outputs, dim=0), (H,) è®­ç»ƒé¢„æµ‹ï¼Œä¸RNNä»£ç åŸºæœ¬ä¸€è‡´ 1 2 3 4 5 6 7 8 9 10 vocab_size, num_hiddens, device = len(vocab), 256, d2l.try_gpu() num_epochs, lr = 500, 1 # å®šä¹‰æ¨¡å‹ model = d2l.RNNModelScratch(len(vocab), num_hiddens, device, get_params, init_gru_state, gru) # è®­ç»ƒ d2l.train_ch8(model, train_iter, vocab, lr, num_epochs, device) # perplexity 1.1, 23869.1 tokens/sec on cuda:0 # time traveller for so it will be convenient to speak of himwas e # traveller afweryhin ing sfor the three dimensions of space 1.3 ç®€æ´å®ç° ç›´æ¥é€šè¿‡torchçš„nn.GRU()å®šä¹‰é—¨æ§ç¥ç»å•å…ƒ 1 2 3 4 5 6 7 8 9 10 11 num_inputs = vocab_size gru_layer = nn.GRU(num_inputs, num_hiddens) model = d2l.RNNModel(gru_layer, len(vocab)) model = model.to(device) d2l.train_ch8(model, train_iter, vocab, lr, num_epochs, device) # perplexity 1.0, 132652.9 tokens/sec on cuda:0 # time travelleryou can show black is white by argument said filby # travelleryou can show black is white by argument said filby 2. é•¿çŸ­æœŸè®°å¿†ç½‘ç»œ(LSTM) LSTMä¸GRUè¾ƒä¸ºç±»ä¼¼ï¼Œå…¶è¢«æ—©æå‡º20å¹´ï¼Œè®¾è®¡æ›´åŠ å¤æ‚ä¸€ç‚¹\n2.1 é—¨æ§è®°å¿†å…ƒ é™¤äº†éšçŠ¶æ€ä»¥å¤–ï¼ŒLSTMåˆæå‡ºäº†è®°å¿†å…ƒçš„æ¦‚å¿µã€‚å®ƒä¸éšçŠ¶æ€çš„å½¢çŠ¶ç›¸åŒï¼Œè®¾è®¡ç›®çš„æ˜¯ç”¨äºè®°å½•æ›´å¤šçš„ä¿¡æ¯ã€‚ ï¼ˆ1ï¼‰è¾“å…¥é—¨ã€è¾“å‡ºé—¨å’Œè¾“å‡ºé—¨\nå…±æœ‰ä¸‰ä¸ªé—¨è¢«æå‡ºç”¨äºæ§åˆ¶è®°å¿†å…ƒï¼š è¾“å‡ºé—¨ç”¨æ¥æ§åˆ¶ä»è®°å¿†å…ƒè¾“å‡ºåˆ°éšçŠ¶æ€ï¼› è¾“å…¥é—¨ç”¨æ¥æ§åˆ¶å¦‚ä½•ä»ä¸Šä¸€æ­¥çš„éšçŠ¶æ€ä»¥åŠå½“å‰çš„è§‚æµ‹ä¸­å­¦ä¹ è®°å¿†å…ƒï¼› é—å¿˜é—¨ç”¨æ¥æ§åˆ¶å¤šå¤§ç¨‹åº¦ç»§æ‰¿ä¸Šä¸€æ­¥çš„è®°å¿†å…ƒã€‚ è¿™ä¸‰ä¸ªé—¨çš„è®¡ç®—æ–¹å¼ä¸ä¹‹å‰éƒ½ç±»ä¼¼ ï¼ˆ2ï¼‰å€™é€‰è®°å¿†å…ƒ\nå€™é€‰è®°å¿†å…ƒçš„è®¡ç®—æ–¹å¼ä¸ä¸Šè¿°ä¹Ÿç±»ä¼¼ï¼Œåªæ˜¯æ¿€æ´»å‡½æ•°ä¸ºtanhï¼Œå› æ­¤å˜æ¢åçš„èŒƒå›´æ˜¯(-1, 1) ï¼ˆ3ï¼‰è®°å¿†å…ƒ\nå¦‚ä¸‹å›¾ï¼Œè®¡ç®—å½“å‰æ—¶é—´æ­¥çš„è®°å¿†å…ƒåŸºäºä¸¤ä¸ªé—¨çš„æ§åˆ¶ï¼› è¾“å…¥é—¨Itæ§åˆ¶å¤šå¤§ç¨‹åº¦æ¥è‡ªäºä¸Šè¿°è®¡ç®—çš„å€™é€‰è®°å¿†å…ƒï¼› é—å¿˜é—¨Ftæ§åˆ¶å¤šå¤§ç¨‹åº¦æ¥è‡ªäºä¸Šä¸€æ—¶é—´æ­¥çš„è®°å¿†å…ƒï¼› ï¼ˆ4ï¼‰éšçŠ¶æ€\nåŸºäºä¸Šè¿°çš„è®¡ç®—ï¼Œæœ€ç»ˆé€šè¿‡è¾“å‡ºé—¨Otå†³å®šå¤šå¤§ç¨‹åº¦å°†è®°å¿†å…ƒè¾“å‡ºä½œä¸ºéšçŠ¶æ€ 2.2 ä»é›¶å¼€å§‹å®ç° åŠ è½½æ•°æ® 1 2 3 4 5 6 import torch from torch import nn from d2l import torch as d2l batch_size, num_steps = 32, 35 train_iter, vocab = d2l.load_data_time_machine(batch_size, num_steps) ï¼ˆ1ï¼‰åˆå§‹åŒ–æ¨¡å‹å‚æ•°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 def get_lstm_params(vocab_size, num_hiddens, device): num_inputs = num_outputs = vocab_size def normal(shape): return torch.randn(size=shape, device=device)*0.01 def three(): return (normal((num_inputs, num_hiddens)), normal((num_hiddens, num_hiddens)), torch.zeros(num_hiddens, device=device)) #ä¸GRUç›¸æ¯”ï¼Œåœ¨æ•°é‡ä¸Šå¤šäº†ä¸€ç»„é—¨å‚æ•° W_xi, W_hi, b_i = three() # è¾“å…¥é—¨å‚æ•° W_xf, W_hf, b_f = three() # é—å¿˜é—¨å‚æ•° W_xo, W_ho, b_o = three() # è¾“å‡ºé—¨å‚æ•° W_xc, W_hc, b_c = three() # å€™é€‰è®°å¿†å…ƒå‚æ•° # è¾“å‡ºå±‚å‚æ•° W_hq = normal((num_hiddens, num_outputs)) b_q = torch.zeros(num_outputs, device=device) # é™„åŠ æ¢¯åº¦ params = [W_xi, W_hi, b_i, W_xf, W_hf, b_f, W_xo, W_ho, b_o, W_xc, W_hc, b_c, W_hq, b_q] for param in params: param.requires_grad_(True) return params ï¼ˆ2ï¼‰å®šä¹‰æ¨¡å‹\nåˆå§‹åŒ–éšçŠ¶æ€ä»¥åŠè®°å¿†å…ƒï¼ŒäºŒè€…çš„å½¢çŠ¶ç›¸åŒ 1 2 3 def init_lstm_state(batch_size, num_hiddens, device): return (torch.zeros((batch_size, num_hiddens), device=device), torch.zeros((batch_size, num_hiddens), device=device)) å‚ç…§ä¸Šè¿°æ€è·¯ï¼Œå®šä¹‰LSTMçš„å‰å‘ä¼ æ’­æ–¹å¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 def lstm(inputs, state, params): [W_xi, W_hi, b_i, W_xf, W_hf, b_f, W_xo, W_ho, b_o, W_xc, W_hc, b_c, W_hq, b_q] = params (H, C) = state #éšçŠ¶æ€+è®°å¿†å…ƒ outputs = [] for X in inputs: I = torch.sigmoid((X @ W_xi) + (H @ W_hi) + b_i) F = torch.sigmoid((X @ W_xf) + (H @ W_hf) + b_f) O = torch.sigmoid((X @ W_xo) + (H @ W_ho) + b_o) C_tilda = torch.tanh((X @ W_xc) + (H @ W_hc) + b_c) #å€™é€‰è®°å¿†å…ƒ C = F * C + I * C_tilda #è®°å¿†å…ƒ H = O * torch.tanh(C) #éšçŠ¶æ€ Y = (H @ W_hq) + b_q #é¢„æµ‹è¾“å‡º outputs.append(Y) return torch.cat(outputs, dim=0), (H, C) ï¼ˆ3ï¼‰è®­ç»ƒå’Œé¢„æµ‹\n1 2 3 4 5 6 7 8 9 10 vocab_size, num_hiddens, device = len(vocab), 256, d2l.try_gpu() num_epochs, lr = 500, 1 model = d2l.RNNModelScratch(len(vocab), num_hiddens, device, get_lstm_params, init_lstm_state, lstm) d2l.train_ch8(model, train_iter, vocab, lr, num_epochs, device) # perplexity 1.1, 20088.5 tokens/sec on cuda:0 # time traveller proceeded anyreal body must have extension in fou # traveller and whyon geantating simong and why can thive yor 2.3 ç®€æ´å®ç° åŸºäºtorchçš„nn.LSTM()ï¼Œå¿«é€Ÿå®ç° 1 2 3 4 5 6 7 8 9 10 num_inputs = vocab_size lstm_layer = nn.LSTM(num_inputs, num_hiddens) model = d2l.RNNModel(lstm_layer, len(vocab)) model = model.to(device) d2l.train_ch8(model, train_iter, vocab, lr, num_epochs, device) # perplexity 1.0, 130362.3 tokens/sec on cuda:0 # time traveller with a slight accession ofcheerfulness really thi # travelleryou can show black is white by argument said filby 3. æ·±åº¦RNN å¯¹äºä¹‹å‰å­¦ä¹ çš„RNNï¼Œä»¥åŠæ›´åŠ å¤æ‚çš„GRUã€LSTMï¼Œæœ¬è´¨ä¸Šéƒ½å¯ä»¥ç†è§£ä¸ºå•éšè—å±‚(Ht)çš„MLPã€‚ å¯ä»¥æ­å»ºå…·æœ‰Lä¸ªéšè—å±‚çš„æ·±åº¦å¾ªç¯ç¥ç»ç½‘ç»œï¼Œ æ¯ä¸ªéšçŠ¶æ€éƒ½è¿ç»­åœ°ä¼ é€’åˆ°å½“å‰å±‚çš„ä¸‹ä¸€ä¸ªæ—¶é—´æ­¥å’Œä¸‹ä¸€å±‚çš„å½“å‰æ—¶é—´æ­¥ã€‚ 3.1 ç®€æ´å®ç° åŠ è½½æ•°æ® 1 2 3 4 5 6 import torch from torch import nn from d2l import torch as d2l batch_size, num_steps = 32, 35 train_iter, vocab = d2l.load_data_time_machine(batch_size, num_steps) å¦‚ä¸‹ä»¥LSTMæ¨¡å‹ä¸ºä¾‹ï¼Œä»…éœ€è¦åœ¨nn.LSTM()æ¨¡å‹ä¸­çš„ç¬¬ä¸‰ä¸ªå‚æ•°ä¸­è®¾ç½®å±‚æ•°å³å¯ 1 2 3 4 5 6 7 8 vocab_size, num_hiddens, num_layers = len(vocab), 256, 2 num_inputs = vocab_size device = d2l.try_gpu() # num_layersè®¾ç½®ä¸ºä¸¤å±‚ lstm_layer = nn.LSTM(num_inputs, num_hiddens, num_layers) model = d2l.RNNModel(lstm_layer, len(vocab)) model = model.to(device) 3.2 è®­ç»ƒä¸é¢„æµ‹ 1 2 3 4 5 num_epochs, lr = 500, 2 d2l.train_ch8(model, train_iter, vocab, lr*1.0, num_epochs, device) # perplexity 1.0, 98815.1 tokens/sec on cuda:0 # time travelleryou can show black is white by argument said filby # travelleryou can show black is white by argument said filby 4. åŒå‘RNN 4.1 å®šä¹‰ æœ‰æ—¶ï¼Œåºåˆ—çš„ä¸‹æ–‡ä¹Ÿå¯¹å½“å‰æ­¥çš„é¢„æµ‹æœ‰å¸®åŠ©ï¼Œä¾‹å¦‚æˆ‘__, è¯·ç»™æˆ‘ç‚¹åƒçš„ã€‚\nåŒå‘RNNå¯ä»¥ç†è§£ä¸ºæœ‰ä¸¤ä¸ªéšè—å±‚çš„RNNæ¨¡å‹ï¼Œä½¿ç”¨åºåˆ—ä¸¤ç«¯çš„ä¿¡æ¯é¢„æµ‹è¾“å‡ºã€‚\nå…¶ä¸­ä¸¤å±‚éå†åºåˆ—çš„æ–¹å‘ç›¸åï¼Œåˆ†åˆ«è®¡ç®—å‰å‘ä¸åå‘éšçŠ¶æ€ æœ€åå°†ä¸¤ä¸ªéšçŠ¶æ€ç»“æœåˆå¹¶èµ·æ¥ï¼Œå…±åŒç”¨äºè®¡ç®—Ot åŒå‘RNNæ¨¡å‹çš„è®¡ç®—é€Ÿåº¦è¾ƒæ…¢ï¼Œä¸»è¦åŸå› æ˜¯ç½‘ç»œçš„å‰å‘ä¼ æ’­éœ€è¦åœ¨åŒå‘å±‚ä¸­è¿›è¡Œå‰å‘å’Œåå‘é€’å½’ï¼Œ å¹¶ä¸”ç½‘ç»œçš„åå‘ä¼ æ’­è¿˜ä¾èµ–äºå‰å‘ä¼ æ’­çš„ç»“æœã€‚ å› æ­¤ï¼Œæ¢¯åº¦æ±‚è§£å°†æœ‰ä¸€ä¸ªéå¸¸é•¿çš„é“¾ã€‚ æ­¤å¤–ï¼ŒåŒå‘RNNæ¨¡å‹çš„åº”ç”¨åœºæ™¯æœ‰é™ï¼Œä¸é€‚åˆç”¨äºä¸‹æ–‡é¢„æµ‹ï¼›å¯ä»¥ç”¨äºå¡«å……ç¼ºå¤±çš„å•è¯ã€è¯å…ƒæ³¨é‡Šï¼Œæœºå™¨ç¿»è¯‘ç­‰ã€‚ 4.2 é”™è¯¯åº”ç”¨ å¦‚ä¸Šï¼ŒåŒå‘RNNåœ¨é¢„æµ‹æ—¶éœ€è¦ç”¨åˆ°è¿‡å»å’Œæœªæ¥çš„æ•°æ®ï¼Œä¸é€‚åˆç”¨äºé¢„æµ‹æœªæ¥è¯å…ƒï¼Œå°½ç®¡æœ‰æ—¶æ¨¡å‹è®­ç»ƒæ€§èƒ½è¾ƒå¥½ã€‚ åœ¨torchä¸­å®ç°ä¹Ÿå¾ˆç®€å•ï¼Œä»…éœ€è¦è®¾ç½®ç›¸åº”çš„å‚æ•°å³å¯ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 import torch from torch import nn from d2l import torch as d2l # åŠ è½½æ•°æ® batch_size, num_steps, device = 32, 35, d2l.try_gpu() train_iter, vocab = d2l.load_data_time_machine(batch_size, num_steps) # é€šè¿‡è®¾ç½®â€œbidirective=Trueâ€æ¥å®šä¹‰åŒå‘LSTMæ¨¡å‹ vocab_size, num_hiddens, num_layers = len(vocab), 256, 2 num_inputs = vocab_size lstm_layer = nn.LSTM(num_inputs, num_hiddens, num_layers, bidirectional=True) model = d2l.RNNModel(lstm_layer, len(vocab)) model = model.to(device) # è®­ç»ƒæ¨¡å‹ num_epochs, lr = 500, 1 d2l.train_ch8(model, train_iter, vocab, lr, num_epochs, device) # perplexity 1.1, 64036.4 tokens/sec on cuda:0 # time travellerererererererererererererererererererererererererer # travellerererererererererererererererererererererererererer 5. æœºå™¨ç¿»è¯‘ä¸æ•°æ®é›† æœºå™¨ç¿»è¯‘æ˜¯å°†ä¸€ç§è¯­è¨€ç¿»è¯‘ä¸ºå¦ä¸€ç§è¯­è¨€ï¼› å¯ä»¥ç†è§£ä¸ºæ˜¯å°†è¾“å…¥åºåˆ—è½¬æ¢æˆè¾“å‡ºåºåˆ—çš„åºåˆ—è½¬æ¢æ¨¡å‹ã€‚ æ¥ä¸‹æ¥çš„åé¢å‡ èŠ‚éƒ½å°†å­¦ä¹ å¦‚ä½•å®ç° 1 2 3 import os import torch from d2l import torch as d2l 5.1 ä¸‹è½½å’Œé¢„å¤„ç† ç¤ºä¾‹æ•°æ®æ˜¯ä¸€ä¸ªâ€™è‹±è¯­â€”æ³•è¯­â€™æ–‡æœ¬æ•°æ®é›†ã€‚ æ¯ä¸€è¡Œéƒ½æ˜¯ç”±åˆ¶è¡¨ç¬¦åˆ†å‰²çš„æ–‡æœ¬åºåˆ—å¯¹ã€‚ æ–‡æœ¬åºåˆ—å¯ä»¥æ˜¯å•è¯ï¼Œå¥å­ï¼Œæ®µè½ï¼ˆåŒ…å«æ ‡ç‚¹ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 #@save d2l.DATA_HUB['fra-eng'] = (d2l.DATA_URL + 'fra-eng.zip', '94646ad1522d915e7b0f9296181140edcf86a4f5') #@save def read_data_nmt(): \"\"\"è½½å…¥â€œè‹±è¯­ï¼æ³•è¯­â€æ•°æ®é›†\"\"\" data_dir = d2l.download_extract('fra-eng') with open(os.path.join(data_dir, 'fra.txt'), 'r', encoding='utf-8') as f: return f.read() raw_text = read_data_nmt() print(raw_text[:20]) # Go.\tVa ! # Hi.\tSalut ! æ–‡æœ¬é¢„å¤„ç†æ“ä½œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 #@save def preprocess_nmt(text): \"\"\"é¢„å¤„ç†â€œè‹±è¯­ï¼æ³•è¯­â€æ•°æ®é›†\"\"\" # è¿”å›é€»è¾‘å€¼ï¼šå­—ç¬¦æ˜¯å¦ä¸ºæ ‡ç‚¹ç¬¦å·ï¼Œä¸”è¯¥å­—ç¬¦å‰æ˜¯å¦æ²¡æœ‰ç©ºæ ¼ def no_space(char, prev_char): return char in set(',.!?') and prev_char != ' ' # ä½¿ç”¨ç©ºæ ¼æ›¿æ¢ä¸é—´æ–­ç©ºæ ¼ # ä½¿ç”¨å°å†™å­—æ¯æ›¿æ¢å¤§å†™å­—æ¯ text = text.replace('\\u202f', ' ').replace('\\xa0', ' ').lower() # åœ¨å•è¯å’Œæ ‡ç‚¹ç¬¦å·ä¹‹é—´æ’å…¥ç©ºæ ¼ out = [' ' + char if i \u003e 0 and no_space(char, text[i - 1]) else char for i, char in enumerate(text)] return ''.join(out) text = preprocess_nmt(raw_text) print(text[:25]) # go .\tva ! # hi .\tsalut ! # ru 5.2 è¯å…ƒåŒ– å°†å•è¯ä»¥åŠæ ‡ç‚¹ç¬¦å·è®¤ä¸ºæ˜¯è¯å…ƒ åœ¨æ¯ä¸€è¡Œä¸­ï¼Œå¯¹åˆ¶è¡¨ç¬¦å‰åçš„æ–‡æœ¬åˆ†åˆ«è¿›è¡Œè¯å…ƒåŒ–ï¼Œä½œä¸ºsourceä¸target 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 #@save def tokenize_nmt(text, num_examples=None): \"\"\"è¯å…ƒåŒ–â€œè‹±è¯­ï¼æ³•è¯­â€æ•°æ®æ•°æ®é›†\"\"\" source, target = [], [] for i, line in enumerate(text.split('\\n')): if num_examples and i \u003e num_examples: break parts = line.split('\\t') if len(parts) == 2: source.append(parts[0].split(' ')) target.append(parts[1].split(' ')) return source, target #list of list source, target = tokenize_nmt(text) source[:3], target[:3] # ([['go', '.'], ['hi', '.'], ['run', '!']], # [['va', '!'], ['salut', '!'], ['cours', '!']]) 5.3 è¯è¡¨ åˆ†åˆ«ä¸ºæºè¯­è¨€ï¼ˆè‹±è¯­ï¼‰ä»¥åŠç›®æ ‡ï¼ˆæ³•è¯­ï¼‰è¯­è¨€æ„å»ºè¯è¡¨ï¼› å°†è¯é¢‘ä½äº2çš„è¯å…ƒè®¾ç½®ä¸ºâ€™' æ­¤å¤–ï¼Œé¢å¤–æŒ‡å®šå‡ ä¸ªç‰¹æ®Šè¯å…ƒ â€˜â€™ å¡«å……è¯å…ƒ â€˜â€™ å¼€å§‹è¯å…ƒ â€˜â€™ ç»“æŸè¯å…ƒ 1 2 3 4 5 # å¦‚ä¸‹ä»¥æºè¯­è¨€ä¸ºä¾‹ src_vocab = d2l.Vocab(source, min_freq=2, reserved_tokens=['', '', '']) len(src_vocab) #è¯å…ƒç±»åˆ«æ•° # 10012 5.4 åŠ è½½æ•°æ®é›† ä¸ºäº†ä¾¿äºè®­ç»ƒï¼Œéœ€è¦å°†è¾“å…¥åºåˆ—ä¸ºè®¾ç½®ä¸ºå›ºå®šé•¿åº¦ã€‚æ­¤æ—¶ä¼šæœ‰å¦‚ä¸‹ä¸¤ç§æƒ…å†µ æˆªæ–­ï¼šä»…å–å‰é¢é¢„æœŸåºåˆ—é•¿åº¦çš„è¯å…ƒï¼Œä¸¢å¼ƒåé¢çš„è¯å…ƒ å¡«å……ï¼šå½“ä¸æ»¡è¶³é¢„æœŸåºåˆ—é•¿åº¦æ—¶ï¼Œåœ¨åé¢å¡«å……è¡¥é½ 1 2 3 4 5 6 7 8 9 10 #@save def truncate_pad(line, num_steps, padding_token): \"\"\"æˆªæ–­æˆ–å¡«å……æ–‡æœ¬åºåˆ—\"\"\" if len(line) \u003e num_steps: return line[:num_steps] # æˆªæ–­ return line + [padding_token] * (num_steps - len(line)) # å¡«å…… # å¦‚ä¸‹ç¤ºä¾‹ï¼Œå¯¹sourceçš„ç¬¬ä¸€ä¸ªè¯å…ƒåºåˆ—è¿›è¡Œå¤„ç†ï¼Œä½¿ç”¨å¡«å……å­—ç¬¦å°†é•¿åº¦è¡¥åˆ°10 truncate_pad(src_vocab[source[0]], 10, src_vocab['']) # [47, 4, 1, 1, 1, 1, 1, 1, 1, 1] å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œå¯¹source/targetè¿›è¡Œä¸Šè¿°å¤„ç†ï¼Œå¹¶åœ¨åºåˆ—ç»“å°¾åŠ ä¸Šä¸€ä¸ªâ€™â€˜è¯å…ƒ æ­¤å¤–ï¼Œä¼šç»Ÿè®¡ä¸€ä¸‹æ¯ä¸ªåºåˆ—çš„æœ‰æ•ˆé•¿åº¦ï¼ˆé™¤å»å¡«å……è¯å…ƒï¼‰ 1 2 3 4 5 6 7 8 9 #@save def build_array_nmt(lines, vocab, num_steps): \"\"\"å°†æœºå™¨ç¿»è¯‘çš„æ–‡æœ¬åºåˆ—è½¬æ¢æˆå°æ‰¹é‡\"\"\" lines = [vocab[l] for l in lines] lines = [l + [vocab['']] for l in lines] array = torch.tensor([truncate_pad( l, num_steps, vocab['']) for l in lines]) valid_len = (array != vocab['']).type(torch.int32).sum(1) return array, valid_len 5.5 æœ€ç»ˆå½¢å¼ å®šä¹‰ä¸€ä¸ªç»¼åˆå‡½æ•°ï¼Œè¿”å›æ•°æ®è¿­ä»£å™¨ï¼Œæºè¯­è¨€è¯è¡¨ï¼Œç›®æ ‡è¯­è¨€è¯è¡¨ æ•°æ®è¿­ä»£å™¨æ¯æ¬¡è¿”å›ä¸€ä¸ªæ‰¹é‡çš„è¾“å…¥åºåˆ—ä¸è¾“å‡ºåºåˆ— 1 2 3 4 5 6 7 8 9 10 11 12 13 14 #@save def load_data_nmt(batch_size, num_steps, num_examples=600): \"\"\"è¿”å›ç¿»è¯‘æ•°æ®é›†çš„è¿­ä»£å™¨å’Œè¯è¡¨\"\"\" text = preprocess_nmt(read_data_nmt()) source, target = tokenize_nmt(text, num_examples) src_vocab = d2l.Vocab(source, min_freq=2, reserved_tokens=['', '', '']) tgt_vocab = d2l.Vocab(target, min_freq=2, reserved_tokens=['', '', '']) src_array, src_valid_len = build_array_nmt(source, src_vocab, num_steps) tgt_array, tgt_valid_len = build_array_nmt(target, tgt_vocab, num_steps) data_arrays = (src_array, src_valid_len, tgt_array, tgt_valid_len) data_iter = d2l.load_array(data_arrays, batch_size) return data_iter, src_vocab, tgt_vocab ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 train_iter, src_vocab, tgt_vocab = load_data_nmt(batch_size=2, num_steps=8) for X, X_valid_len, Y, Y_valid_len in train_iter: print('X:', X.type(torch.int32)) print('Xçš„æœ‰æ•ˆé•¿åº¦:', X_valid_len) print('Y:', Y.type(torch.int32)) print('Yçš„æœ‰æ•ˆé•¿åº¦:', Y_valid_len) break # X: tensor([[ 58, 47, 4, 3, 1, 1, 1, 1], # [ 7, 102, 5, 3, 1, 1, 1, 1]], dtype=torch.int32) # Xçš„æœ‰æ•ˆé•¿åº¦: tensor([4, 4]) # Y: tensor([[ 18, 14, 34, 4, 3, 1, 1, 1], # [ 6, 7, 161, 5, 3, 1, 1, 1]], dtype=torch.int32) # Yçš„æœ‰æ•ˆé•¿åº¦: tensor([5, 5]) 6. ç¼–ç å™¨ä¸è§£ç å™¨æ¶æ„ å¯¹äºä¹‹å‰å­¦ä¹ çš„CNNä»¥åŠç°åœ¨å­¦ä¹ çš„RNNï¼Œéƒ½å¯ä»¥ç†è§£ä¸ºç¼–ç å™¨ä¸è§£ç å™¨æ¶æ„ï¼› ç¼–ç å™¨ï¼šå°†è¾“å…¥å˜æ¢ä¸ºä¸­é—´è¡¨è¾¾å½¢å¼ï¼ˆç‰¹å¾ï¼‰ï¼› å¯¹äºRNNï¼Œå¯å°†é•¿åº¦å¯å˜çš„åºåˆ—ä½œä¸ºè¾“å…¥ï¼Œè½¬æ¢ä¸ºå…·æœ‰å›ºå®šå½¢çŠ¶çš„ç¼–ç çŠ¶æ€ è§£ç å™¨ï¼šå°†æå–çš„ä¸­é—´è¡¨ç¤ºç¼–ç æˆè¾“å‡ºã€‚ å¯¹äºRNNï¼Œå°†å›ºå®šå½¢çŠ¶çš„ç¼–ç çŠ¶æ€æ˜ å°„åˆ°é•¿åº¦å¯å˜çš„åºåˆ— æ¥ä¸‹æ¥å®šä¹‰ä¸€ä¸ªæŠ½è±¡çš„ç¼–ç å™¨-è§£ç å™¨æ¥å£ï¼Œä»¥æ–¹ä¾¿åç»­çš„å®ç°\n6.1 ç¼–ç å™¨ åœ¨ç¼–ç å™¨æ¥å£ä¸­ï¼ŒæŒ‡å®šé•¿åº¦å¯å˜çš„åºåˆ—ä½œä¸ºè¾“å…¥X 1 2 3 4 5 6 7 8 9 10 from torch import nn #@save class Encoder(nn.Module): \"\"\"ç¼–ç å™¨-è§£ç å™¨æ¶æ„çš„åŸºæœ¬ç¼–ç å™¨æ¥å£\"\"\" def __init__(self, **kwargs): super(Encoder, self).__init__(**kwargs) def forward(self, X, *args): raise NotImplementedError raise NotImplementedError æ˜¯ä¸€ç§ç¼–ç¨‹æ¨¡å¼ï¼Œç”¨äºè¡¨æ˜æŸä¸ªæ–¹æ³•æˆ–åŠŸèƒ½è¿˜æ²¡æœ‰å‡†å¤‡å¥½æˆ–è€…éœ€è¦è¢«å­ç±»è¦†ç›–ä»¥æä¾›å®é™…çš„è¡Œä¸ºã€‚\n6.2 è§£ç å™¨ init_stateç”¨äºåˆå§‹åŒ–è§£ç å™¨çš„çŠ¶æ€ã€‚ ä¸»è¦æ˜¯å°†ç¼–ç å™¨çš„è¾“å‡ºè½¬æ¢ä¸ºç¼–ç åçš„çŠ¶æ€ æ ¹æ®RNNæ€è·¯ï¼Œè§£ç å™¨åœ¨æ¯ä¸ªæ—¶é—´æ­¥éƒ½ä¼šå°†è¾“å…¥X ï¼ˆä¾‹å¦‚ï¼šåœ¨å‰ä¸€æ—¶é—´æ­¥ç”Ÿæˆçš„è¯å…ƒï¼‰å’Œç¼–ç åçš„çŠ¶æ€ æ˜ å°„æˆå½“å‰æ—¶é—´æ­¥çš„è¾“å‡ºè¯å…ƒã€‚ 1 2 3 4 5 6 7 8 9 10 11 #@save class Decoder(nn.Module): \"\"\"ç¼–ç å™¨-è§£ç å™¨æ¶æ„çš„åŸºæœ¬è§£ç å™¨æ¥å£\"\"\" def __init__(self, **kwargs): super(Decoder, self).__init__(**kwargs) def init_state(self, enc_outputs, *args): raise NotImplementedError def forward(self, X, state): raise NotImplementedError 6.3 åˆå¹¶ç¼–ç å™¨ä¸è§£ç å™¨ åœ¨å‰å‘ä¼ æ’­ä¸­ï¼Œ\nç¼–ç å™¨çš„è¾“å‡ºç”¨äºç”Ÿæˆç¼–ç çŠ¶æ€ï¼› è¿™ä¸ªçŠ¶æ€åˆè¢«è§£ç å™¨ä½œä¸ºå…¶è¾“å…¥çš„ä¸€éƒ¨åˆ†ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 #@save class EncoderDecoder(nn.Module): \"\"\"ç¼–ç å™¨-è§£ç å™¨æ¶æ„çš„åŸºç±»\"\"\" def __init__(self, encoder, decoder, **kwargs): super(EncoderDecoder, self).__init__(**kwargs) self.encoder = encoder self.decoder = decoder def forward(self, enc_X, dec_X, *args): enc_outputs = self.encoder(enc_X, *args) dec_state = self.decoder.init_state(enc_outputs, *args) return self.decoder(dec_X, dec_state) 7. åºåˆ—åˆ°åºåˆ—å­¦ä¹ (seq2seq) åºåˆ—åˆ°åºåˆ—å­¦ä¹ æ¨¡å‹ç”±ä¸¤ä¸ªRNNçš„ç¼–ç å™¨ä¸è§£ç å™¨ç»„æˆ ç¼–ç å™¨RNNï¼šå°†è¾“å…¥åºåˆ—çš„ä¿¡æ¯ç¼–ç ä¸ºå›ºå®šå½¢çŠ¶çš„éšçŠ¶æ€ã€‚ è§£ç å™¨RNNï¼šåŸºäºç¼–ç å™¨è¾“å…¥åºåˆ—çš„ç¼–ç ä¿¡æ¯ä»¥åŠå½“å‰æ—¶é—´æ­¥çš„è¯å…ƒï¼Œæ¥é¢„æµ‹ä¸‹ä¸€ä¸ªè¯å…ƒã€‚ 1 2 3 4 5 import collections import math import torch from torch import nn from d2l import torch as d2l 7.1 ç¼–ç å™¨ åœ¨ç¼–ç å™¨RNNéƒ¨åˆ†ï¼Œä¸»è¦ç›®çš„æ˜¯å¾—åˆ°è¾“å…¥åºåˆ—æœ€åä¸€ä¸ªæ—¶é—´æ­¥çš„éšçŠ¶æ€è¡¨ç¤ºï¼ˆå¯ä»¥æœ‰å¤šå±‚ï¼‰ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 #@save class Seq2SeqEncoder(d2l.Encoder): \"\"\"ç”¨äºåºåˆ—åˆ°åºåˆ—å­¦ä¹ çš„å¾ªç¯ç¥ç»ç½‘ç»œç¼–ç å™¨\"\"\" def __init__(self, vocab_size, embed_size, num_hiddens, num_layers, dropout=0, **kwargs): super(Seq2SeqEncoder, self).__init__(**kwargs) # åµŒå…¥å±‚ï¼šæå–æ¯ä¸ªè¯å…ƒçš„ç‰¹å¾å‘é‡ self.embedding = nn.Embedding(vocab_size, embed_size) # è¿™é‡Œä½¿ç”¨å¤šå±‚çš„GRUå¾ªç¯ç¥ç»ç½‘ç»œ self.rnn = nn.GRU(embed_size, num_hiddens, num_layers, dropout=dropout) def forward(self, X, *args): # è¾“å…¥'X'çš„å½¢çŠ¶ï¼š(batch_size,num_steps) # è¾“å‡º'X'çš„å½¢çŠ¶ï¼š(batch_size,num_steps,embed_size) X = self.embedding(X) # åœ¨å¾ªç¯ç¥ç»ç½‘ç»œæ¨¡å‹ä¸­ï¼Œéœ€è¦å°†ç¬¬ä¸€ä¸ªè½´è®¾ç½®ä¸ºæ—¶é—´æ­¥ï¼ˆæ‰¹é‡å†…çš„å­åºåˆ—ï¼‰ X = X.permute(1, 0, 2) # å¦‚æœæœªæåŠçŠ¶æ€ï¼Œåˆ™é»˜è®¤ä¸º0 output, state = self.rnn(X) # outputçš„å½¢çŠ¶:(num_steps,batch_size,num_hiddens) # stateçš„å½¢çŠ¶:(num_layers,batch_size,num_hiddens) return output, state outputæ˜¯åŸºäºæ¯ä¸ªæ—¶é—´æ­¥æœ€åä¸€å±‚çš„éšçŠ¶æ€ï¼ˆä¸€èˆ¬æƒ…å†µä¸‹åé¢éœ€è¦è·Ÿå…¨è¿æ¥å±‚è¿›è¡Œé¢„æµ‹è¾“å‡ºï¼‰ï¼›\nstateæ˜¯æœ€åä¸€ä¸ªæ—¶é—´æ­¥çš„å¤šå±‚çš„éšçŠ¶æ€ã€‚\nç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 encoder = Seq2SeqEncoder(vocab_size=10, embed_size=8, num_hiddens=16, num_layers=2) encoder.eval() X = torch.zeros((4, 7), dtype=torch.long) output, state = encoder(X) output.shape # torch.Size([7, 4, 16]) #(æ—¶é—´æ­¥æ•°ï¼Œæ‰¹é‡å¤§å°ï¼Œéšè—å•å…ƒæ•°) state.shape # torch.Size([2, 4, 16]) #(éšè—å±‚çš„æ•°é‡ï¼Œæ‰¹é‡å¤§å°ï¼Œéšè—å•å…ƒçš„æ•°é‡) # output æ‰¹é‡å†…ç¬¬1ä¸ªå­åºåˆ—çš„ç¬¬7ä¸ªæ—¶é—´æ­¥çš„å‰5ä¸ªå€¼ # state æ‰¹é‡å†…ç¬¬1ä¸ªå­åºåˆ—çš„æœ€åä¸€ä¸ªæ—¶é—´æ­¥çš„ç¬¬2å±‚çš„å‰5ä¸ªå€¼ output[6, 0, :5], state[1, 0, :5] # (tensor([ 0.0533, -0.2092, 0.0406, -0.0956, -0.3704], grad_fn=), # tensor([ 0.0533, -0.2092, 0.0406, -0.0956, -0.3704], grad_fn=)) 7.2 è§£ç å™¨ åœ¨è§£ç å™¨RNNä¸­ï¼Œ\nä¸€æ–¹é¢ï¼Œä¼šç»§æ‰¿ç¼–ç å™¨RNNçš„æœ€åä¸€ä¸ªæ—¶é—´æ­¥çš„æ‰€æœ‰éšçŠ¶æ€ï¼Œä½œä¸ºè§£ç å™¨è¾“å…¥åºåˆ—çš„åˆå§‹åŒ–éšçŠ¶æ€ï¼› å¦ä¸€æ–¹é¢ä¼šå°†ç¼–ç å™¨RNNçš„æœ€åä¸€ä¸ªæ—¶é—´æ­¥çš„æœ€åä¸€å±‚éšçŠ¶æ€ï¼Œä½œä¸ºè§£ç å™¨è¾“å…¥åºåˆ—ä¸­æ¯ä¸ªè§‚æµ‹è¯å…ƒçš„ä¸€éƒ¨åˆ†ç‰¹å¾ï¼ˆå‚è€ƒä¸Šå›¾ï¼‰ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 class Seq2SeqDecoder(d2l.Decoder): \"\"\"ç”¨äºåºåˆ—åˆ°åºåˆ—å­¦ä¹ çš„å¾ªç¯ç¥ç»ç½‘ç»œè§£ç å™¨\"\"\" def __init__(self, vocab_size, embed_size, num_hiddens, num_layers, dropout=0, **kwargs): super(Seq2SeqDecoder, self).__init__(**kwargs) self.embedding = nn.Embedding(vocab_size, embed_size) # è§‚æµ‹è¯å…ƒè¾“å…¥=è¯å…ƒæœ¬èº«ç‰¹å¾+ç¼–ç å™¨çš„ä¿¡æ¯context self.rnn = nn.GRU(embed_size + num_hiddens, num_hiddens, num_layers, dropout=dropout) self.dense = nn.Linear(num_hiddens, vocab_size) def init_state(self, enc_outputs, *args): return enc_outputs[1] #å–stateï¼Œè€Œéoutput def forward(self, X, state): # è¾“å‡º'X'çš„å½¢çŠ¶ï¼š(batch_size,num_steps,embed_size) X = self.embedding(X).permute(1, 0, 2) # å¹¿æ’­contextï¼Œä½¿å…¶å…·æœ‰ä¸Xç›¸åŒçš„num_steps context = state[-1].repeat(X.shape[0], 1, 1) X_and_context = torch.cat((X, context), 2) output, state = self.rnn(X_and_context, state) output = self.dense(output).permute(1, 0, 2) # outputçš„å½¢çŠ¶:(batch_size,num_steps,vocab_size)ï¼Œé¢„æµ‹ç»“æœ # stateçš„å½¢çŠ¶:(num_layers,batch_size,num_hiddens)ï¼Œè§£ç å™¨åºåˆ—æœ€åä¸€ä¸ªæ—¶é—´æ­¥çš„éšçŠ¶æ€ return output, state 7.3 æŸå¤±å‡½æ•° å¯¹äºè§£ç å™¨çš„é¢„æµ‹è¾“å‡ºï¼Œä¸€èˆ¬ä½¿ç”¨å¹³å‡äº¤å‰ç†µæŸå¤±(Softmax)è¯„ä»·ä¸æ ‡ç­¾åºåˆ—çš„å·®å¼‚æŸå¤±ï¼› åœ¨è®¡ç®—æŸå¤±æ—¶ï¼Œåº”ä¸éœ€è¦å…³æ³¨å¯¹äºåºåˆ—ä¸­çš„å¡«å……è¯å…ƒçš„é¢„æµ‹æ­£ç¡®ä¸å¦ æ¢å¥è¯è¯´ï¼Œä»…å…³æ³¨åºåˆ—ä¸­æœ‰æ•ˆè¯å…ƒçš„é¢„æµ‹ç»“æœ 1 2 3 4 5 6 7 8 9 10 11 12 13 #@save def sequence_mask(X, valid_len, value=0): \"\"\"åœ¨åºåˆ—ä¸­å±è”½ä¸ç›¸å…³çš„é¡¹\"\"\" maxlen = X.size(1) mask = torch.arange((maxlen), dtype=torch.float32, device=X.device)[None, :] \u003c valid_len[:, None] X[~mask] = value return X X = torch.tensor([[1, 2, 3], [4, 5, 6]]) sequence_mask(X, torch.tensor([1, 2])) # tensor([[1, 0, 0], #ç¬¬ä¸€ä¸ªè¯å…ƒä»¥å¤–çš„éƒ¨åˆ†è¢«ç½®æ¢ä¸º0 # [4, 5, 0]]) #å‰ä¸¤ä¸ªè¯å…ƒä»¥å¤–çš„éƒ¨åˆ†è¢«ç½®æ¢ä¸º0 æ®æ­¤è‡ªå®šä¹‰ä¸€ä¸ªæŸå¤±å‡½æ•° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 #@save class MaskedSoftmaxCELoss(nn.CrossEntropyLoss): \"\"\"å¸¦é®è”½çš„softmaxäº¤å‰ç†µæŸå¤±å‡½æ•°\"\"\" # predçš„å½¢çŠ¶ï¼š(batch_size,num_steps,vocab_size) # labelçš„å½¢çŠ¶ï¼š(batch_size,num_steps) # valid_lençš„å½¢çŠ¶ï¼š(batch_size,) def forward(self, pred, label, valid_len): weights = torch.ones_like(label) #æ— æ•ˆè¯å…ƒçš„æƒé‡è®¾ç½®ä¸º0ï¼Œå³å¿½ç•¥ weights = sequence_mask(weights, valid_len) self.reduction='none' #ä¸ä¼šè‡ªåŠ¨å¯¹è¾“å‡ºè¿›è¡Œå¹³å‡æˆ–æ±‚å’Œ unweighted_loss = super(MaskedSoftmaxCELoss, self).forward( pred.permute(0, 2, 1), label) #(batch_size, vocab_size, num_steps) å°†ç±»åˆ«æ¦‚ç‡æ”¾åœ¨ç¬¬äºŒç»´ weighted_loss = (unweighted_loss * weights).mean(dim=1) return weighted_loss 7.4 è®­ç»ƒ åœ¨è§£ç å™¨ä¸­ï¼Œâ€™â€˜ä¸åŸå§‹çš„è¾“å‡ºåºåˆ—ï¼ˆä¸åŒ…å«â€™â€™ï¼‰è¿æ¥åœ¨ä¸€èµ·å…±åŒä½œä¸ºè¾“å…¥ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 #@save def train_seq2seq(net, data_iter, lr, num_epochs, tgt_vocab, device): \"\"\"è®­ç»ƒåºåˆ—åˆ°åºåˆ—æ¨¡å‹\"\"\" def xavier_init_weights(m): if type(m) == nn.Linear: nn.init.xavier_uniform_(m.weight) if type(m) == nn.GRU: for param in m._flat_weights_names: if \"weight\" in param: nn.init.xavier_uniform_(m._parameters[param]) net.apply(xavier_init_weights) net.to(device) optimizer = torch.optim.Adam(net.parameters(), lr=lr) loss = MaskedSoftmaxCELoss() net.train() animator = d2l.Animator(xlabel='epoch', ylabel='loss', xlim=[10, num_epochs]) for epoch in range(num_epochs): timer = d2l.Timer() metric = d2l.Accumulator(2) # è®­ç»ƒæŸå¤±æ€»å’Œï¼Œè¯å…ƒæ•°é‡ for batch in data_iter: optimizer.zero_grad() X, X_valid_len, Y, Y_valid_len = [x.to(device) for x in batch] #åœ¨ä¹‹å‰åºåˆ—é¢„å¤„ç†é‡Œload_data_nmtä¸­ï¼Œå·²å°†æ¯ä¸ªåºåˆ—æœ«å°¾æ·»åŠ äº†è¯å…ƒ #å¯¹äºè§£ç å™¨çš„è¾“å…¥åºåˆ—ï¼Œåœ¨å¼€å¤´æ’å…¥ä¸€ä¸ªbosè¯å…ƒã€‚ä¸ºä¿è¯é•¿åº¦ä¸å˜ï¼Œéœ€è¦æˆªæ‰åºåˆ—çš„æœ€åä¸€ä¸ªè¯å…ƒ() bos = torch.tensor([tgt_vocab['']] * Y.shape[0], device=device).reshape(-1, 1) dec_input = torch.cat([bos, Y[:, :-1]], 1) # å¼ºåˆ¶æ•™å­¦ # X_valid_lenæœ¬ç« æš‚æ—¶ç”¨ä¸åˆ°ï¼ŒY_valid_lenä¼šç”¨åˆ° Y_hat, _ = net(X, dec_input, X_valid_len) l = loss(Y_hat, Y, Y_valid_len) l.sum().backward() # æŸå¤±å‡½æ•°çš„æ ‡é‡è¿›è¡Œâ€œåå‘ä¼ æ’­â€ d2l.grad_clipping(net, 1) num_tokens = Y_valid_len.sum() optimizer.step() with torch.no_grad(): metric.add(l.sum(), num_tokens) if (epoch + 1) % 10 == 0: animator.add(epoch + 1, (metric[0] / metric[1],)) print(f'loss {metric[0] / metric[1]:.3f}, {metric[1] / timer.stop():.1f} ' f'tokens/sec on {str(device)}') å®ä¾‹åŒ–æ¨¡å‹ï¼Œå¹¶è®­ç»ƒ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 embed_size, num_hiddens, num_layers, dropout = 32, 32, 2, 0.1 batch_size, num_steps = 64, 10 lr, num_epochs, device = 0.005, 300, d2l.try_gpu() train_iter, src_vocab, tgt_vocab = d2l.load_data_nmt(batch_size, num_steps) encoder = Seq2SeqEncoder(len(src_vocab), embed_size, num_hiddens, num_layers, dropout) decoder = Seq2SeqDecoder(len(tgt_vocab), embed_size, num_hiddens, num_layers, dropout) net = d2l.EncoderDecoder(encoder, decoder) train_seq2seq(net, train_iter, lr, num_epochs, tgt_vocab, device) # loss 0.019, 10100.9 tokens/sec on cuda:0 7.5 é¢„æµ‹ ä¸è®­ç»ƒéƒ¨åˆ†ä¸åŒä¹‹å¤„åœ¨äºï¼Œ æ¯ä¸ªè§£ç å™¨å½“å‰æ—¶é—´æ­¥çš„è¾“å…¥éƒ½å°†æ¥è‡ªäºå‰ä¸€æ—¶é—´æ­¥çš„é¢„æµ‹è¯å…ƒã€‚è€Œåœ¨è®­ç»ƒæ—¶çš„è§£ç å™¨è¾“å…¥éƒ½æ˜¯æ¥è‡ªçœŸå®çš„è¯å…ƒã€‚ src_sentence è¡¨ç¤ºç”¨æˆ·çš„è¾“å…¥è‹±è¯­å¥å­ src_vocabè¡¨ç¤ºè‹±è¯­çš„ç´¢å¼•è¯è¡¨ tgt_vocabè¡¨ç¤ºæ³•è¯­çš„ç´¢å¼•è¯è¡¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 #@save def predict_seq2seq(net, src_sentence, src_vocab, tgt_vocab, num_steps, device, save_attention_weights=False): \"\"\"åºåˆ—åˆ°åºåˆ—æ¨¡å‹çš„é¢„æµ‹\"\"\" # åœ¨é¢„æµ‹æ—¶å°†netè®¾ç½®ä¸ºè¯„ä¼°æ¨¡å¼ net.eval() src_tokens = src_vocab[src_sentence.lower().split(' ')] + [ src_vocab['']] enc_valid_len = torch.tensor([len(src_tokens)], device=device) src_tokens = d2l.truncate_pad(src_tokens, num_steps, src_vocab['']) #å›ºå®šé•¿åº¦ # æ·»åŠ æ‰¹é‡è½´ï¼ˆä½œä¸ºç¬¬ä¸€ä¸ªç»´åº¦ï¼‰ enc_X = torch.unsqueeze( torch.tensor(src_tokens, dtype=torch.long, device=device), dim=0) enc_outputs = net.encoder(enc_X, enc_valid_len) dec_state = net.decoder.init_state(enc_outputs, enc_valid_len) # æ·»åŠ æ‰¹é‡è½´ dec_X = torch.unsqueeze(torch.tensor( [tgt_vocab['']], dtype=torch.long, device=device), dim=0) output_seq, attention_weight_seq = [], [] for _ in range(num_steps): Y, dec_state = net.decoder(dec_X, dec_state) # æˆ‘ä»¬ä½¿ç”¨å…·æœ‰é¢„æµ‹æœ€é«˜å¯èƒ½æ€§çš„è¯å…ƒï¼Œä½œä¸ºè§£ç å™¨åœ¨ä¸‹ä¸€æ—¶é—´æ­¥çš„è¾“å…¥ dec_X = Y.argmax(dim=2) pred = dec_X.squeeze(dim=0).type(torch.int32).item() # ä¿å­˜æ³¨æ„åŠ›æƒé‡ï¼ˆç¨åè®¨è®ºï¼‰ if save_attention_weights: attention_weight_seq.append(net.decoder.attention_weights) # ä¸€æ—¦åºåˆ—ç»“æŸè¯å…ƒè¢«é¢„æµ‹ï¼Œè¾“å‡ºåºåˆ—çš„ç”Ÿæˆå°±æå‰å®Œæˆäº† if pred == tgt_vocab['']: break output_seq.append(pred) return ' '.join(tgt_vocab.to_tokens(output_seq)), attention_weight_seq 7.6 é¢„æµ‹åºåˆ—çš„è¯„ä¼° å¯ä½¿ç”¨Bleuå€¼è¯„ä¼°é¢„æµ‹åºåˆ—ä¸çœŸå®åºåˆ—çš„å·®å¼‚ï¼›å€¼è¶Šå¤§ï¼Œä¸”æ¥è¿‘1è¡¨ç¤ºæ•ˆæœè¶Šå¥½ å½“é¢„æµ‹çš„åºåˆ—é•¿åº¦å°äºçœŸå®åºåˆ—é•¿åº¦æ—¶ï¼Œå‰é¢çš„expç³»æ•°è¿ç®—å°±ä¼šå°äº1ï¼Œå³å¯¹Bleuå€¼æƒ©ç½šï¼› å½“nå€¼è¾ƒå¤§æ—¶çš„nå…ƒé¢„æµ‹å‡†ç¡®ç‡è¶Šé«˜æ—¶ï¼ŒPné¡¹å°±è¶Šå¤§ã€‚ å…·ä½“åœ°è¯´ï¼Œç»™å®šæ ‡ç­¾åºåˆ—Aã€Bã€Cã€Dã€Eã€F å’Œé¢„æµ‹åºåˆ—Aã€Bã€Bã€Cã€Dï¼Œ æˆ‘ä»¬æœ‰p1=4/5ã€p2=3/4ã€p3=1/3å’Œp4=0ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 def bleu(pred_seq, label_seq, k): #@save \"\"\"è®¡ç®—BLEU\"\"\" pred_tokens, label_tokens = pred_seq.split(' '), label_seq.split(' ') len_pred, len_label = len(pred_tokens), len(label_tokens) score = math.exp(min(0, 1 - len_label / len_pred)) for n in range(1, k + 1): num_matches, label_subs = 0, collections.defaultdict(int) for i in range(len_label - n + 1): label_subs[' '.join(label_tokens[i: i + n])] += 1 for i in range(len_pred - n + 1): if label_subs[' '.join(pred_tokens[i: i + n])] \u003e 0: num_matches += 1 label_subs[' '.join(pred_tokens[i: i + n])] -= 1 score *= math.pow(num_matches / (len_pred - n + 1), math.pow(0.5, n)) return score ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 engs = ['go .', \"i lost .\", 'he\\'s calm .', 'i\\'m home .'] fras = ['va !', 'j\\'ai perdu .', 'il est calme .', 'je suis chez moi .'] for eng, fra in zip(engs, fras): translation, attention_weight_seq = predict_seq2seq( net, eng, src_vocab, tgt_vocab, num_steps, device) print(f'{eng} =\u003e {translation}, bleu {bleu(translation, fra, k=2):.3f}') # go . =\u003e va ., bleu 0.000 # i lost . =\u003e j'ai perdu ., bleu 1.000 # he's calm . =\u003e il est bon de de essaye ., bleu 0.418 # i'm home . =\u003e je suis chez de moi emportÃ© ., bleu 0.578 ",
  "wordCount" : "8150",
  "inLanguage": "en",
  "datePublished": "2024-08-11T00:00:00Z",
  "dateModified": "2024-08-11T00:00:00Z",
  "author":[{
    "@type": "Person",
    "name": "Lishensuo"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://lishensuo.github.io/en/posts/bioinfo/712d2l-%E7%AC%AC%E4%B9%9D%E7%AB%A0%E7%8E%B0%E4%BB%A3%E5%BE%AA%E7%8E%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Li's Bioinfo-Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://lishensuo.github.io/img/Q.gif"
    }
  }
}
</script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://lishensuo.github.io/en/" accesskey="h" title="Li&#39;s Bioinfo-Blog (Alt + H)">Li&#39;s Bioinfo-Blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                </ul>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://lishensuo.github.io/en/" title="ä¸»é¡µ">
                    <span>ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://lishensuo.github.io/en/posts" title="åˆ†ç±»">
                    <span>åˆ†ç±»</span>
                </a>
            </li>
            <li>
                <a href="https://lishensuo.github.io/en/tags" title="æ ‡ç­¾">
                    <span>æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://lishensuo.github.io/en/archives/" title="å½’æ¡£">
                    <span>å½’æ¡£</span>
                </a>
            </li>
            <li>
                <a href="https://lishensuo.github.io/en/about" title="å…³äº">
                    <span>å…³äº</span>
                </a>
            </li>
            <li>
                <a href="https://lishensuo.github.io/en/search" title="æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>æœç´¢</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://lishensuo.github.io/en/">Home</a>&nbsp;Â»&nbsp;<a href="https://lishensuo.github.io/en/posts/">åˆ†ç±»</a>&nbsp;Â»&nbsp;<a href="https://lishensuo.github.io/en/posts/bioinfo/">ğŸ“– ç”Ÿä¿¡æ•°æ®åˆ†æ--åˆ†ææµç¨‹ï¼Œå·¥å…·åŒ…ç­‰</a></div>
    <h1 class="post-title">
      D2L--ç¬¬ä¹ç« ç°ä»£å¾ªç¯ç¥ç»ç½‘ç»œ
    </h1>
    <div class="post-meta">













Create:&amp;nbsp;&lt;span title=&#39;2024-08-11 00:00:00 &#43;0000 UTC&#39;&gt;2024-08-11&lt;/span&gt;&amp;nbsp;|&amp;nbsp;Update:&amp;nbsp;2024-08-11&amp;nbsp;|&amp;nbsp;Words:&amp;nbsp;8150&amp;nbsp;|&amp;nbsp;17 min&amp;nbsp;|&amp;nbsp;Lishensuo

|  Viewers: <span id="busuanzi_value_page_pv"></span> 
	  
    </div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">Table of Contents</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#1-%e9%97%a8%e6%8e%a7%e5%be%aa%e7%8e%af%e5%8d%95%e5%85%83gru" aria-label="1. é—¨æ§å¾ªç¯å•å…ƒ(GRU)">1. é—¨æ§å¾ªç¯å•å…ƒ(GRU)</a><ul>
                            
                    <li>
                        <a href="#11-%e9%97%a8%e6%8e%a7%e9%9a%90%e8%97%8f%e7%8a%b6%e6%80%81" aria-label="1.1 é—¨æ§éšè—çŠ¶æ€">1.1 é—¨æ§éšè—çŠ¶æ€</a></li>
                    <li>
                        <a href="#12-%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e5%ae%9e%e7%8e%b0" aria-label="1.2 ä»é›¶å¼€å§‹å®ç°">1.2 ä»é›¶å¼€å§‹å®ç°</a></li>
                    <li>
                        <a href="#13-%e7%ae%80%e6%b4%81%e5%ae%9e%e7%8e%b0" aria-label="1.3 ç®€æ´å®ç°">1.3 ç®€æ´å®ç°</a></li></ul>
                    </li>
                    <li>
                        <a href="#2-%e9%95%bf%e7%9f%ad%e6%9c%9f%e8%ae%b0%e5%bf%86%e7%bd%91%e7%bb%9clstm" aria-label="2. é•¿çŸ­æœŸè®°å¿†ç½‘ç»œ(LSTM)">2. é•¿çŸ­æœŸè®°å¿†ç½‘ç»œ(LSTM)</a><ul>
                            
                    <li>
                        <a href="#21-%e9%97%a8%e6%8e%a7%e8%ae%b0%e5%bf%86%e5%85%83" aria-label="2.1 é—¨æ§è®°å¿†å…ƒ">2.1 é—¨æ§è®°å¿†å…ƒ</a></li>
                    <li>
                        <a href="#22-%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e5%ae%9e%e7%8e%b0" aria-label="2.2 ä»é›¶å¼€å§‹å®ç°">2.2 ä»é›¶å¼€å§‹å®ç°</a></li>
                    <li>
                        <a href="#23-%e7%ae%80%e6%b4%81%e5%ae%9e%e7%8e%b0" aria-label="2.3 ç®€æ´å®ç°">2.3 ç®€æ´å®ç°</a></li></ul>
                    </li>
                    <li>
                        <a href="#3-%e6%b7%b1%e5%ba%a6rnn" aria-label="3. æ·±åº¦RNN">3. æ·±åº¦RNN</a><ul>
                            
                    <li>
                        <a href="#31-%e7%ae%80%e6%b4%81%e5%ae%9e%e7%8e%b0" aria-label="3.1 ç®€æ´å®ç°">3.1 ç®€æ´å®ç°</a></li>
                    <li>
                        <a href="#32-%e8%ae%ad%e7%bb%83%e4%b8%8e%e9%a2%84%e6%b5%8b" aria-label="3.2 è®­ç»ƒä¸é¢„æµ‹">3.2 è®­ç»ƒä¸é¢„æµ‹</a></li></ul>
                    </li>
                    <li>
                        <a href="#4-%e5%8f%8c%e5%90%91rnn" aria-label="4. åŒå‘RNN">4. åŒå‘RNN</a><ul>
                            
                    <li>
                        <a href="#41-%e5%ae%9a%e4%b9%89" aria-label="4.1 å®šä¹‰">4.1 å®šä¹‰</a></li>
                    <li>
                        <a href="#42-%e9%94%99%e8%af%af%e5%ba%94%e7%94%a8" aria-label="4.2 é”™è¯¯åº”ç”¨">4.2 é”™è¯¯åº”ç”¨</a></li></ul>
                    </li>
                    <li>
                        <a href="#5-%e6%9c%ba%e5%99%a8%e7%bf%bb%e8%af%91%e4%b8%8e%e6%95%b0%e6%8d%ae%e9%9b%86" aria-label="5. æœºå™¨ç¿»è¯‘ä¸æ•°æ®é›†">5. æœºå™¨ç¿»è¯‘ä¸æ•°æ®é›†</a><ul>
                            
                    <li>
                        <a href="#51-%e4%b8%8b%e8%bd%bd%e5%92%8c%e9%a2%84%e5%a4%84%e7%90%86" aria-label="5.1 ä¸‹è½½å’Œé¢„å¤„ç†">5.1 ä¸‹è½½å’Œé¢„å¤„ç†</a></li>
                    <li>
                        <a href="#52-%e8%af%8d%e5%85%83%e5%8c%96" aria-label="5.2 è¯å…ƒåŒ–">5.2 è¯å…ƒåŒ–</a></li>
                    <li>
                        <a href="#53-%e8%af%8d%e8%a1%a8" aria-label="5.3 è¯è¡¨">5.3 è¯è¡¨</a></li>
                    <li>
                        <a href="#54-%e5%8a%a0%e8%bd%bd%e6%95%b0%e6%8d%ae%e9%9b%86" aria-label="5.4 åŠ è½½æ•°æ®é›†">5.4 åŠ è½½æ•°æ®é›†</a></li>
                    <li>
                        <a href="#55-%e6%9c%80%e7%bb%88%e5%bd%a2%e5%bc%8f" aria-label="5.5 æœ€ç»ˆå½¢å¼">5.5 æœ€ç»ˆå½¢å¼</a></li></ul>
                    </li>
                    <li>
                        <a href="#6-%e7%bc%96%e7%a0%81%e5%99%a8%e4%b8%8e%e8%a7%a3%e7%a0%81%e5%99%a8%e6%9e%b6%e6%9e%84" aria-label="6. ç¼–ç å™¨ä¸è§£ç å™¨æ¶æ„">6. ç¼–ç å™¨ä¸è§£ç å™¨æ¶æ„</a><ul>
                            
                    <li>
                        <a href="#61-%e7%bc%96%e7%a0%81%e5%99%a8" aria-label="6.1 ç¼–ç å™¨">6.1 ç¼–ç å™¨</a></li>
                    <li>
                        <a href="#62-%e8%a7%a3%e7%a0%81%e5%99%a8" aria-label="6.2 è§£ç å™¨">6.2 è§£ç å™¨</a></li>
                    <li>
                        <a href="#63-%e5%90%88%e5%b9%b6%e7%bc%96%e7%a0%81%e5%99%a8%e4%b8%8e%e8%a7%a3%e7%a0%81%e5%99%a8" aria-label="6.3 åˆå¹¶ç¼–ç å™¨ä¸è§£ç å™¨">6.3 åˆå¹¶ç¼–ç å™¨ä¸è§£ç å™¨</a></li></ul>
                    </li>
                    <li>
                        <a href="#7-%e5%ba%8f%e5%88%97%e5%88%b0%e5%ba%8f%e5%88%97%e5%ad%a6%e4%b9%a0seq2seq" aria-label="7. åºåˆ—åˆ°åºåˆ—å­¦ä¹ (seq2seq)">7. åºåˆ—åˆ°åºåˆ—å­¦ä¹ (seq2seq)</a><ul>
                            
                    <li>
                        <a href="#71-%e7%bc%96%e7%a0%81%e5%99%a8" aria-label="7.1 ç¼–ç å™¨">7.1 ç¼–ç å™¨</a></li>
                    <li>
                        <a href="#72-%e8%a7%a3%e7%a0%81%e5%99%a8" aria-label="7.2 è§£ç å™¨">7.2 è§£ç å™¨</a></li>
                    <li>
                        <a href="#73-%e6%8d%9f%e5%a4%b1%e5%87%bd%e6%95%b0" aria-label="7.3 æŸå¤±å‡½æ•°">7.3 æŸå¤±å‡½æ•°</a></li>
                    <li>
                        <a href="#74-%e8%ae%ad%e7%bb%83" aria-label="7.4 è®­ç»ƒ">7.4 è®­ç»ƒ</a></li>
                    <li>
                        <a href="#75-%e9%a2%84%e6%b5%8b" aria-label="7.5 é¢„æµ‹">7.5 é¢„æµ‹</a></li>
                    <li>
                        <a href="#76-%e9%a2%84%e6%b5%8b%e5%ba%8f%e5%88%97%e7%9a%84%e8%af%84%e4%bc%b0" aria-label="7.6 é¢„æµ‹åºåˆ—çš„è¯„ä¼°">7.6 é¢„æµ‹åºåˆ—çš„è¯„ä¼°</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>


  <div class="post-content"><h1 id="1-é—¨æ§å¾ªç¯å•å…ƒgru">1. é—¨æ§å¾ªç¯å•å…ƒ(GRU)<a hidden class="anchor" aria-hidden="true" href="#1-é—¨æ§å¾ªç¯å•å…ƒgru">#</a></h1>
<blockquote>
<p>ä¼ ç»Ÿçš„RNNåœ¨å¤„ç†é•¿åºåˆ—æ—¶ä¼šé‡åˆ°æ¢¯åº¦æ¶ˆå¤±æˆ–æ¢¯åº¦çˆ†ç‚¸çš„é—®é¢˜ã€‚ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œå¼•å…¥äº†é—¨æ§æœºåˆ¶çš„å˜ç§ï¼Œå¦‚é•¿çŸ­æ—¶è®°å¿†ç½‘ç»œï¼ˆLSTM, long short-term memoryï¼‰å’Œé—¨æ§å¾ªç¯å•å…ƒï¼ˆGRU, gated recurrent unitï¼‰ã€‚GRUæ˜¯LSTMçš„ä¸€ä¸ªç®€åŒ–ç‰ˆæœ¬ï¼Œå®ƒé€šè¿‡åˆå¹¶æŸäº›é—¨å¹¶å‡å°‘å‚æ•°æ•°é‡æ¥æé«˜æ•ˆç‡ã€‚</p></blockquote>
<h2 id="11-é—¨æ§éšè—çŠ¶æ€">1.1 é—¨æ§éšè—çŠ¶æ€<a hidden class="anchor" aria-hidden="true" href="#11-é—¨æ§éšè—çŠ¶æ€">#</a></h2>
<p><strong>ï¼ˆ1ï¼‰é‡ç½®é—¨ä¸æ›´æ–°é—¨</strong></p>
<p>é€šè¿‡æ”¯æŒå¯¹éšçŠ¶æ€çš„é—¨æ§ï¼Œæ¨¡å‹å¯ä»¥å­¦ä¹ åºåˆ—ä¸­ç›¸å¯¹é‡è¦çš„è¯å…ƒï¼Œè·³è¿‡ä¸å¤ªç›¸å…³çš„è¯å…ƒã€‚GRUåŒ…æ‹¬äº†ä¸¤ä¸ªé—¨æ§å•å…ƒï¼š</p>
<ul>
<li><strong>é‡ç½®é—¨</strong>ï¼šå†³å®šä¸Šä¸€æ—¶åˆ»çš„éšè—çŠ¶æ€(<strong>H</strong>tâˆ’1)æœ‰å¤šå°‘ä¿¡æ¯éœ€è¦è¢«â€œé‡ç½®â€æˆ–å¿½ç•¥ï¼Œè®¡ç®—å€™é€‰éšçŠ¶æ€;</li>
<li><strong>æ›´æ–°é—¨</strong>ï¼šå†³å®šå¤šå°‘æ—§çŠ¶æ€(<strong>H</strong>t-1)åº”è¯¥è¢«ä¿ç•™ï¼Œå¤šå°‘æ–°çŠ¶æ€(å³ä¸Šé¢çš„å€™é€‰éšçŠ¶æ€ï¼ŒåŒ…æ‹¬æ–°è¾“å…¥çš„<strong>X</strong>t)åº”è¯¥è¢«æ·»åŠ åˆ°å½“å‰çŠ¶æ€ä¸­ã€‚</li>
<li>è®¡ç®—ä¸Šè¿°ä¸¤ä¸ªé—¨æ§å•å…ƒçš„æ–¹å¼ä¸RNNä¸­Htçš„è®¡ç®—å…¬å¼åŸºæœ¬ä¸€è‡´ï¼Œåªæ˜¯æ¿€æ´»å‡½æ•°é€‰æ‹©ä¸åŒã€‚è¿™é‡Œä½¿ç”¨çš„Sigmoidï¼Œä½¿å¾—è½¬æ¢ä¸º0~1èŒƒå›´ï¼Œæ–¹ä¾¿åç»­çš„æ§åˆ¶æ“ä½œã€‚</li>
</ul>
<p><img loading="lazy" src="https://raw.githubusercontent.com/lishensuo/images2/main/img01/image-20240808102630079.png" alt="image-20240808102630079"  />
</p>
<p><strong>ï¼ˆ2ï¼‰å€™é€‰éšçŠ¶æ€</strong></p>
<ul>
<li>å¯é€šè¿‡é‡ç½®é—¨ï¼Œæ¥æ§åˆ¶ç”Ÿæˆå€™é€‰éšçŠ¶æ€ã€‚</li>
<li>Rt = 1æ—¶ï¼Œå°±æ˜¯åŸºæœ¬çš„RNNå±‚ï¼ˆåŒ…å«<strong>H</strong>t-1ä¸<strong>X</strong>tï¼‰ï¼›</li>
<li>Rt = 0æ—¶ï¼Œä¸Šä¸€æ­¥çš„éšçŠ¶æ€ä¼šè¢«é‡ç½®/å¿½ç•¥ï¼Œä»…è€ƒè™‘<strong>X</strong>tè¾“å…¥ã€‚</li>
</ul>
<p><img loading="lazy" src="https://raw.githubusercontent.com/lishensuo/images2/main/img01/image-20240808103029769.png" alt="image-20240808103029769"  />
</p>
<p><strong>ï¼ˆ3ï¼‰éšçŠ¶æ€</strong></p>
<ul>
<li>æ›´æ–°é—¨å¯ä»¥æ§åˆ¶æœ€ç»ˆéšçŠ¶æ€çš„è¾“å‡ºï¼Œç”¨äºé¢„æµ‹<strong>O</strong>t</li>
<li>Zt = 0æ—¶ï¼Œä¼šå…¨éƒ¨ä½¿ç”¨ä¸Šè¿°çš„å€™é€‰éšçŠ¶æ€ï¼ˆåŒ…å«<strong>X</strong>tï¼‰</li>
<li>Zt = 1æ—¶ï¼Œä¼šä¸¢å¼ƒå€™é€‰éšçŠ¶æ€ï¼Œç›´æ¥ç»§æ‰¿å‰ä¸€éšè—çŠ¶æ€çš„<strong>H</strong>t-1
<ul>
<li>è‹¥æ•´ä¸ªå­åºåˆ—çš„æ‰€æœ‰æ—¶é—´æ­¥çš„æ›´æ–°é—¨éƒ½æ¥è¿‘1ï¼Œåˆ™åºåˆ—èµ·å§‹æ—¶é—´æ­¥çš„éšçŠ¶æ€å°†å¾ˆå®¹æ˜“ä¿ç•™ã€å¹¶ä¼ é€’åˆ°åºåˆ—ç»“æŸã€‚</li>
</ul>
</li>
</ul>
<p><img loading="lazy" src="https://raw.githubusercontent.com/lishensuo/images2/main/img01/image-20240808104015096.png" alt="image-20240808104015096"  />
</p>
<blockquote>
<p>ç»¼ä¸Šï¼Œ</p>
<ul>
<li>é‡ç½®é—¨å¯ä»¥æ§åˆ¶<u>å¤šå¤§ç¨‹åº¦è·å¾—ä¸Šä¸€æ­¥éª¤çš„éšçŠ¶æ€</u>ï¼Œæœ‰åŠ©äºæ•è·åºåˆ—ä¸­çš„çŸ­æœŸä¾èµ–å…³ç³»ã€‚</li>
<li>æ›´æ–°é—¨å¯ä»¥æ§åˆ¶<u>å¤šå¤§ç¨‹åº¦å­¦ä¹ å½“å‰æ­¥éª¤(Xt)çš„è§‚æµ‹</u>ï¼Œæœ‰åŠ©äºæ•è·åºåˆ—ä¸­çš„é•¿æœŸä¾èµ–å…³ç³»ã€‚</li>
</ul></blockquote>
<h2 id="12-ä»é›¶å¼€å§‹å®ç°">1.2 ä»é›¶å¼€å§‹å®ç°<a hidden class="anchor" aria-hidden="true" href="#12-ä»é›¶å¼€å§‹å®ç°">#</a></h2>
<ul>
<li>åŠ è½½æ•°æ®</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> torch <span style="color:#fff;font-weight:bold">import</span> nn
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> d2l <span style="color:#fff;font-weight:bold">import</span> torch <span style="color:#fff;font-weight:bold">as</span> d2l
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>batch_size, num_steps = <span style="color:#ff0;font-weight:bold">32</span>, <span style="color:#ff0;font-weight:bold">35</span>
</span></span><span style="display:flex;"><span>train_iter, vocab = d2l.load_data_time_machine(batch_size, num_steps)
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>ï¼ˆ1ï¼‰åˆå§‹åŒ–æ¨¡å‹å‚æ•°</strong></p>
<ul>
<li>ä¸RNNç›¸æ¯”ï¼Œå¤šäº†æ›´æ–°é—¨ä¸é‡ç½®é—¨çš„æ¨¡å‹å‚æ•°</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> get_params(vocab_size, num_hiddens, device):
</span></span><span style="display:flex;"><span>    num_inputs = num_outputs = vocab_size
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> normal(shape):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> torch.randn(size=shape, device=device)*<span style="color:#ff0;font-weight:bold">0.01</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> three():
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> (normal((num_inputs, num_hiddens)),
</span></span><span style="display:flex;"><span>                normal((num_hiddens, num_hiddens)),
</span></span><span style="display:flex;"><span>                torch.zeros(num_hiddens, device=device))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    W_xz, W_hz, b_z = three()  <span style="color:#007f7f"># æ›´æ–°é—¨å‚æ•°</span>
</span></span><span style="display:flex;"><span>    W_xr, W_hr, b_r = three()  <span style="color:#007f7f"># é‡ç½®é—¨å‚æ•°</span>
</span></span><span style="display:flex;"><span>    W_xh, W_hh, b_h = three()  <span style="color:#007f7f"># å€™é€‰éšçŠ¶æ€å‚æ•°</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># è¾“å‡ºå±‚å‚æ•°</span>
</span></span><span style="display:flex;"><span>    W_hq = normal((num_hiddens, num_outputs))
</span></span><span style="display:flex;"><span>    b_q = torch.zeros(num_outputs, device=device)
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># é™„åŠ æ¢¯åº¦</span>
</span></span><span style="display:flex;"><span>    params = [W_xz, W_hz, b_z, W_xr, W_hr, b_r, W_xh, W_hh, b_h, W_hq, b_q]
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> param in params:
</span></span><span style="display:flex;"><span>        param.requires_grad_(<span style="color:#fff;font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> params
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>ï¼ˆ2ï¼‰å®šä¹‰æ¨¡å‹</strong></p>
<ul>
<li>éšçŠ¶æ€åˆå§‹åŒ–å‡½æ•°ï¼Œä¸ä¹‹å‰RNNä¸€æ ·</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> init_gru_state(batch_size, num_hiddens, device):
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> (torch.zeros((batch_size, num_hiddens), device=device), )
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>å®šä¹‰GRUæ¨¡å‹çš„ä¼ æ’­, <code>@</code>è¡¨ç¤ºæŒ‰å…ƒç´ ç›¸ä¹˜çš„çŸ©é˜µä¹˜æ³•</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> gru(inputs, state, params):
</span></span><span style="display:flex;"><span>    W_xz, W_hz, b_z, W_xr, W_hr, b_r, W_xh, W_hh, b_h, W_hq, b_q = params
</span></span><span style="display:flex;"><span>    H, = state
</span></span><span style="display:flex;"><span>    outputs = []
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> X in inputs:
</span></span><span style="display:flex;"><span>        Z = torch.sigmoid((X @ W_xz) + (H @ W_hz) + b_z) <span style="color:#007f7f">#æ›´æ–°é—¨</span>
</span></span><span style="display:flex;"><span>        R = torch.sigmoid((X @ W_xr) + (H @ W_hr) + b_r) <span style="color:#007f7f">#é‡ç½®é—¨</span>
</span></span><span style="display:flex;"><span>        H_tilda = torch.tanh((X @ W_xh) + ((R * H) @ W_hh) + b_h) <span style="color:#007f7f">#å€™é€‰éšçŠ¶æ€</span>
</span></span><span style="display:flex;"><span>        H = Z * H + (<span style="color:#ff0;font-weight:bold">1</span> - Z) * H_tilda
</span></span><span style="display:flex;"><span>        Y = H @ W_hq + b_q
</span></span><span style="display:flex;"><span>        outputs.append(Y)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> torch.cat(outputs, dim=<span style="color:#ff0;font-weight:bold">0</span>), (H,)
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>è®­ç»ƒé¢„æµ‹ï¼Œä¸RNNä»£ç åŸºæœ¬ä¸€è‡´</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>vocab_size, num_hiddens, device = <span style="color:#fff;font-weight:bold">len</span>(vocab), <span style="color:#ff0;font-weight:bold">256</span>, d2l.try_gpu()
</span></span><span style="display:flex;"><span>num_epochs, lr = <span style="color:#ff0;font-weight:bold">500</span>, <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># å®šä¹‰æ¨¡å‹</span>
</span></span><span style="display:flex;"><span>model = d2l.RNNModelScratch(<span style="color:#fff;font-weight:bold">len</span>(vocab), num_hiddens, device, get_params,
</span></span><span style="display:flex;"><span>                            init_gru_state, gru)
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># è®­ç»ƒ</span>
</span></span><span style="display:flex;"><span>d2l.train_ch8(model, train_iter, vocab, lr, num_epochs, device)
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># perplexity 1.1, 23869.1 tokens/sec on cuda:0</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># time traveller for so it will be convenient to speak of himwas e</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># traveller afweryhin ing sfor the three dimensions of space</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="13-ç®€æ´å®ç°">1.3 ç®€æ´å®ç°<a hidden class="anchor" aria-hidden="true" href="#13-ç®€æ´å®ç°">#</a></h2>
<ul>
<li>ç›´æ¥é€šè¿‡torchçš„<code>nn.GRU()</code>å®šä¹‰é—¨æ§ç¥ç»å•å…ƒ</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>num_inputs = vocab_size
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>gru_layer = nn.GRU(num_inputs, num_hiddens)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model = d2l.RNNModel(gru_layer, <span style="color:#fff;font-weight:bold">len</span>(vocab))
</span></span><span style="display:flex;"><span>model = model.to(device)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>d2l.train_ch8(model, train_iter, vocab, lr, num_epochs, device)
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># perplexity 1.0, 132652.9 tokens/sec on cuda:0</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># time travelleryou can show black is white by argument said filby</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># travelleryou can show black is white by argument said filby</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="2-é•¿çŸ­æœŸè®°å¿†ç½‘ç»œlstm">2. é•¿çŸ­æœŸè®°å¿†ç½‘ç»œ(LSTM)<a hidden class="anchor" aria-hidden="true" href="#2-é•¿çŸ­æœŸè®°å¿†ç½‘ç»œlstm">#</a></h1>
<p>LSTMä¸GRUè¾ƒä¸ºç±»ä¼¼ï¼Œå…¶è¢«æ—©æå‡º20å¹´ï¼Œè®¾è®¡æ›´åŠ å¤æ‚ä¸€ç‚¹</p>
<h2 id="21-é—¨æ§è®°å¿†å…ƒ">2.1 é—¨æ§è®°å¿†å…ƒ<a hidden class="anchor" aria-hidden="true" href="#21-é—¨æ§è®°å¿†å…ƒ">#</a></h2>
<ul>
<li>é™¤äº†éšçŠ¶æ€ä»¥å¤–ï¼ŒLSTMåˆæå‡ºäº†è®°å¿†å…ƒçš„æ¦‚å¿µã€‚å®ƒä¸éšçŠ¶æ€çš„å½¢çŠ¶ç›¸åŒï¼Œè®¾è®¡ç›®çš„æ˜¯ç”¨äºè®°å½•æ›´å¤šçš„ä¿¡æ¯ã€‚</li>
</ul>
<p><strong>ï¼ˆ1ï¼‰è¾“å…¥é—¨ã€è¾“å‡ºé—¨å’Œè¾“å‡ºé—¨</strong></p>
<ul>
<li>å…±æœ‰ä¸‰ä¸ªé—¨è¢«æå‡ºç”¨äºæ§åˆ¶è®°å¿†å…ƒï¼š
<ul>
<li>è¾“å‡ºé—¨ç”¨æ¥æ§åˆ¶ä»è®°å¿†å…ƒè¾“å‡ºåˆ°éšçŠ¶æ€ï¼›</li>
<li>è¾“å…¥é—¨ç”¨æ¥æ§åˆ¶å¦‚ä½•ä»ä¸Šä¸€æ­¥çš„éšçŠ¶æ€ä»¥åŠå½“å‰çš„è§‚æµ‹ä¸­å­¦ä¹ è®°å¿†å…ƒï¼›</li>
<li>é—å¿˜é—¨ç”¨æ¥æ§åˆ¶å¤šå¤§ç¨‹åº¦ç»§æ‰¿ä¸Šä¸€æ­¥çš„è®°å¿†å…ƒã€‚</li>
</ul>
</li>
<li>è¿™ä¸‰ä¸ªé—¨çš„è®¡ç®—æ–¹å¼ä¸ä¹‹å‰éƒ½ç±»ä¼¼</li>
</ul>
<p><img loading="lazy" src="https://raw.githubusercontent.com/lishensuo/images2/main/img01/image-20240808162220950.png" alt="image-20240808162220950"  />
</p>
<p><strong>ï¼ˆ2ï¼‰å€™é€‰è®°å¿†å…ƒ</strong></p>
<ul>
<li>å€™é€‰è®°å¿†å…ƒçš„è®¡ç®—æ–¹å¼ä¸ä¸Šè¿°ä¹Ÿç±»ä¼¼ï¼Œåªæ˜¯æ¿€æ´»å‡½æ•°ä¸ºtanhï¼Œå› æ­¤å˜æ¢åçš„èŒƒå›´æ˜¯(-1, 1)</li>
</ul>
<p><img loading="lazy" src="https://raw.githubusercontent.com/lishensuo/images2/main/img01/image-20240808162522852.png" alt="image-20240808162522852"  />
</p>
<p><strong>ï¼ˆ3ï¼‰è®°å¿†å…ƒ</strong></p>
<ul>
<li>å¦‚ä¸‹å›¾ï¼Œè®¡ç®—å½“å‰æ—¶é—´æ­¥çš„è®°å¿†å…ƒåŸºäºä¸¤ä¸ªé—¨çš„æ§åˆ¶ï¼›</li>
<li>è¾“å…¥é—¨<strong>I</strong>tæ§åˆ¶å¤šå¤§ç¨‹åº¦æ¥è‡ªäºä¸Šè¿°è®¡ç®—çš„å€™é€‰è®°å¿†å…ƒï¼›</li>
<li>é—å¿˜é—¨<strong>F</strong>tæ§åˆ¶å¤šå¤§ç¨‹åº¦æ¥è‡ªäºä¸Šä¸€æ—¶é—´æ­¥çš„è®°å¿†å…ƒï¼›</li>
</ul>
<p><img loading="lazy" src="C:%5cUsers%5cxiaoxin%5cAppData%5cRoaming%5cTypora%5ctypora-user-images%5cimage-20240808163653615.png" alt="image-20240808163653615"  />
</p>
<p><strong>ï¼ˆ4ï¼‰éšçŠ¶æ€</strong></p>
<ul>
<li>åŸºäºä¸Šè¿°çš„è®¡ç®—ï¼Œæœ€ç»ˆé€šè¿‡è¾“å‡ºé—¨<strong>O</strong>tå†³å®šå¤šå¤§ç¨‹åº¦å°†è®°å¿†å…ƒè¾“å‡ºä½œä¸ºéšçŠ¶æ€</li>
</ul>
<p><img loading="lazy" src="https://raw.githubusercontent.com/lishensuo/images2/main/img01/image-20240808164312153.png" alt="image-20240808164312153"  />
</p>
<h2 id="22-ä»é›¶å¼€å§‹å®ç°">2.2 ä»é›¶å¼€å§‹å®ç°<a hidden class="anchor" aria-hidden="true" href="#22-ä»é›¶å¼€å§‹å®ç°">#</a></h2>
<ul>
<li>åŠ è½½æ•°æ®</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> torch <span style="color:#fff;font-weight:bold">import</span> nn
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> d2l <span style="color:#fff;font-weight:bold">import</span> torch <span style="color:#fff;font-weight:bold">as</span> d2l
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>batch_size, num_steps = <span style="color:#ff0;font-weight:bold">32</span>, <span style="color:#ff0;font-weight:bold">35</span>
</span></span><span style="display:flex;"><span>train_iter, vocab = d2l.load_data_time_machine(batch_size, num_steps)
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>ï¼ˆ1ï¼‰åˆå§‹åŒ–æ¨¡å‹å‚æ•°</strong></p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> get_lstm_params(vocab_size, num_hiddens, device):
</span></span><span style="display:flex;"><span>    num_inputs = num_outputs = vocab_size
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> normal(shape):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> torch.randn(size=shape, device=device)*<span style="color:#ff0;font-weight:bold">0.01</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> three():
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> (normal((num_inputs, num_hiddens)),
</span></span><span style="display:flex;"><span>                normal((num_hiddens, num_hiddens)),
</span></span><span style="display:flex;"><span>                torch.zeros(num_hiddens, device=device))
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">#ä¸GRUç›¸æ¯”ï¼Œåœ¨æ•°é‡ä¸Šå¤šäº†ä¸€ç»„é—¨å‚æ•°</span>
</span></span><span style="display:flex;"><span>    W_xi, W_hi, b_i = three()  <span style="color:#007f7f"># è¾“å…¥é—¨å‚æ•°</span>
</span></span><span style="display:flex;"><span>    W_xf, W_hf, b_f = three()  <span style="color:#007f7f"># é—å¿˜é—¨å‚æ•°</span>
</span></span><span style="display:flex;"><span>    W_xo, W_ho, b_o = three()  <span style="color:#007f7f"># è¾“å‡ºé—¨å‚æ•°</span>
</span></span><span style="display:flex;"><span>    W_xc, W_hc, b_c = three()  <span style="color:#007f7f"># å€™é€‰è®°å¿†å…ƒå‚æ•°</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># è¾“å‡ºå±‚å‚æ•°</span>
</span></span><span style="display:flex;"><span>    W_hq = normal((num_hiddens, num_outputs))
</span></span><span style="display:flex;"><span>    b_q = torch.zeros(num_outputs, device=device)
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># é™„åŠ æ¢¯åº¦</span>
</span></span><span style="display:flex;"><span>    params = [W_xi, W_hi, b_i, W_xf, W_hf, b_f, W_xo, W_ho, b_o, W_xc, W_hc,
</span></span><span style="display:flex;"><span>              b_c, W_hq, b_q]
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> param in params:
</span></span><span style="display:flex;"><span>        param.requires_grad_(<span style="color:#fff;font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> params
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>ï¼ˆ2ï¼‰å®šä¹‰æ¨¡å‹</strong></p>
<ul>
<li>åˆå§‹åŒ–éšçŠ¶æ€ä»¥åŠè®°å¿†å…ƒï¼ŒäºŒè€…çš„å½¢çŠ¶ç›¸åŒ</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> init_lstm_state(batch_size, num_hiddens, device):
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> (torch.zeros((batch_size, num_hiddens), device=device),
</span></span><span style="display:flex;"><span>            torch.zeros((batch_size, num_hiddens), device=device))
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>å‚ç…§ä¸Šè¿°æ€è·¯ï¼Œå®šä¹‰LSTMçš„å‰å‘ä¼ æ’­æ–¹å¼</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> lstm(inputs, state, params):
</span></span><span style="display:flex;"><span>    [W_xi, W_hi, b_i, W_xf, W_hf, b_f, W_xo, W_ho, b_o, W_xc, W_hc, b_c,
</span></span><span style="display:flex;"><span>     W_hq, b_q] = params
</span></span><span style="display:flex;"><span>    (H, C) = state <span style="color:#007f7f">#éšçŠ¶æ€+è®°å¿†å…ƒ</span>
</span></span><span style="display:flex;"><span>    outputs = []
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> X in inputs:
</span></span><span style="display:flex;"><span>        I = torch.sigmoid((X @ W_xi) + (H @ W_hi) + b_i)
</span></span><span style="display:flex;"><span>        F = torch.sigmoid((X @ W_xf) + (H @ W_hf) + b_f)
</span></span><span style="display:flex;"><span>        O = torch.sigmoid((X @ W_xo) + (H @ W_ho) + b_o)
</span></span><span style="display:flex;"><span>        C_tilda = torch.tanh((X @ W_xc) + (H @ W_hc) + b_c) <span style="color:#007f7f">#å€™é€‰è®°å¿†å…ƒ</span>
</span></span><span style="display:flex;"><span>        C = F * C + I * C_tilda <span style="color:#007f7f">#è®°å¿†å…ƒ</span>
</span></span><span style="display:flex;"><span>        H = O * torch.tanh(C) <span style="color:#007f7f">#éšçŠ¶æ€</span>
</span></span><span style="display:flex;"><span>        Y = (H @ W_hq) + b_q <span style="color:#007f7f">#é¢„æµ‹è¾“å‡º</span>
</span></span><span style="display:flex;"><span>        outputs.append(Y)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> torch.cat(outputs, dim=<span style="color:#ff0;font-weight:bold">0</span>), (H, C)
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>ï¼ˆ3ï¼‰è®­ç»ƒå’Œé¢„æµ‹</strong></p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>vocab_size, num_hiddens, device = <span style="color:#fff;font-weight:bold">len</span>(vocab), <span style="color:#ff0;font-weight:bold">256</span>, d2l.try_gpu()
</span></span><span style="display:flex;"><span>num_epochs, lr = <span style="color:#ff0;font-weight:bold">500</span>, <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model = d2l.RNNModelScratch(<span style="color:#fff;font-weight:bold">len</span>(vocab), num_hiddens, device, get_lstm_params,
</span></span><span style="display:flex;"><span>                            init_lstm_state, lstm)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>d2l.train_ch8(model, train_iter, vocab, lr, num_epochs, device)
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># perplexity 1.1, 20088.5 tokens/sec on cuda:0</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># time traveller proceeded anyreal body must have extension in fou</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># traveller and whyon geantating simong and why can thive yor</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="23-ç®€æ´å®ç°">2.3 ç®€æ´å®ç°<a hidden class="anchor" aria-hidden="true" href="#23-ç®€æ´å®ç°">#</a></h2>
<ul>
<li>åŸºäºtorchçš„<code>nn.LSTM()</code>ï¼Œå¿«é€Ÿå®ç°</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>num_inputs = vocab_size
</span></span><span style="display:flex;"><span>lstm_layer = nn.LSTM(num_inputs, num_hiddens)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model = d2l.RNNModel(lstm_layer, <span style="color:#fff;font-weight:bold">len</span>(vocab))
</span></span><span style="display:flex;"><span>model = model.to(device)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>d2l.train_ch8(model, train_iter, vocab, lr, num_epochs, device)
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># perplexity 1.0, 130362.3 tokens/sec on cuda:0</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># time traveller with a slight accession ofcheerfulness really thi</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># travelleryou can show black is white by argument said filby</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="3-æ·±åº¦rnn">3. æ·±åº¦RNN<a hidden class="anchor" aria-hidden="true" href="#3-æ·±åº¦rnn">#</a></h1>
<ul>
<li>å¯¹äºä¹‹å‰å­¦ä¹ çš„RNNï¼Œä»¥åŠæ›´åŠ å¤æ‚çš„GRUã€LSTMï¼Œæœ¬è´¨ä¸Šéƒ½å¯ä»¥ç†è§£ä¸ºå•éšè—å±‚(<strong>H</strong>t)çš„MLPã€‚</li>
<li>å¯ä»¥æ­å»ºå…·æœ‰Lä¸ªéšè—å±‚çš„æ·±åº¦å¾ªç¯ç¥ç»ç½‘ç»œï¼Œ æ¯ä¸ªéšçŠ¶æ€éƒ½è¿ç»­åœ°ä¼ é€’åˆ°å½“å‰å±‚çš„ä¸‹ä¸€ä¸ªæ—¶é—´æ­¥å’Œä¸‹ä¸€å±‚çš„å½“å‰æ—¶é—´æ­¥ã€‚</li>
</ul>
<p><img loading="lazy" src="https://raw.githubusercontent.com/lishensuo/images2/main/img01/image-20240808194229417.png" alt="image-20240808194229417"  />
</p>
<h2 id="31-ç®€æ´å®ç°">3.1 ç®€æ´å®ç°<a hidden class="anchor" aria-hidden="true" href="#31-ç®€æ´å®ç°">#</a></h2>
<ul>
<li>åŠ è½½æ•°æ®</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> torch <span style="color:#fff;font-weight:bold">import</span> nn
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> d2l <span style="color:#fff;font-weight:bold">import</span> torch <span style="color:#fff;font-weight:bold">as</span> d2l
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>batch_size, num_steps = <span style="color:#ff0;font-weight:bold">32</span>, <span style="color:#ff0;font-weight:bold">35</span>
</span></span><span style="display:flex;"><span>train_iter, vocab = d2l.load_data_time_machine(batch_size, num_steps)
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>å¦‚ä¸‹ä»¥LSTMæ¨¡å‹ä¸ºä¾‹ï¼Œä»…éœ€è¦åœ¨<code>nn.LSTM()</code>æ¨¡å‹ä¸­çš„ç¬¬ä¸‰ä¸ªå‚æ•°ä¸­è®¾ç½®å±‚æ•°å³å¯</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>vocab_size, num_hiddens, num_layers = <span style="color:#fff;font-weight:bold">len</span>(vocab), <span style="color:#ff0;font-weight:bold">256</span>, <span style="color:#ff0;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>num_inputs = vocab_size
</span></span><span style="display:flex;"><span>device = d2l.try_gpu()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># num_layersè®¾ç½®ä¸ºä¸¤å±‚</span>
</span></span><span style="display:flex;"><span>lstm_layer = nn.LSTM(num_inputs, num_hiddens, num_layers)
</span></span><span style="display:flex;"><span>model = d2l.RNNModel(lstm_layer, <span style="color:#fff;font-weight:bold">len</span>(vocab))
</span></span><span style="display:flex;"><span>model = model.to(device)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="32-è®­ç»ƒä¸é¢„æµ‹">3.2 è®­ç»ƒä¸é¢„æµ‹<a hidden class="anchor" aria-hidden="true" href="#32-è®­ç»ƒä¸é¢„æµ‹">#</a></h2>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>num_epochs, lr = <span style="color:#ff0;font-weight:bold">500</span>, <span style="color:#ff0;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>d2l.train_ch8(model, train_iter, vocab, lr*<span style="color:#ff0;font-weight:bold">1.0</span>, num_epochs, device)
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># perplexity 1.0, 98815.1 tokens/sec on cuda:0</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># time travelleryou can show black is white by argument said filby</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># travelleryou can show black is white by argument said filby</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="4-åŒå‘rnn">4. åŒå‘RNN<a hidden class="anchor" aria-hidden="true" href="#4-åŒå‘rnn">#</a></h1>
<h2 id="41-å®šä¹‰">4.1 å®šä¹‰<a hidden class="anchor" aria-hidden="true" href="#41-å®šä¹‰">#</a></h2>
<ul>
<li>
<p>æœ‰æ—¶ï¼Œåºåˆ—çš„ä¸‹æ–‡ä¹Ÿå¯¹å½“å‰æ­¥çš„é¢„æµ‹æœ‰å¸®åŠ©ï¼Œä¾‹å¦‚<code>æˆ‘__, è¯·ç»™æˆ‘ç‚¹åƒçš„ã€‚</code></p>
</li>
<li>
<p>åŒå‘RNNå¯ä»¥ç†è§£ä¸ºæœ‰ä¸¤ä¸ªéšè—å±‚çš„RNNæ¨¡å‹ï¼Œä½¿ç”¨åºåˆ—ä¸¤ç«¯çš„ä¿¡æ¯é¢„æµ‹è¾“å‡ºã€‚</p>
<ul>
<li>å…¶ä¸­ä¸¤å±‚éå†åºåˆ—çš„æ–¹å‘ç›¸åï¼Œåˆ†åˆ«è®¡ç®—å‰å‘ä¸åå‘éšçŠ¶æ€</li>
<li>æœ€åå°†ä¸¤ä¸ªéšçŠ¶æ€ç»“æœåˆå¹¶èµ·æ¥ï¼Œå…±åŒç”¨äºè®¡ç®—<strong>O</strong>t</li>
</ul>
</li>
</ul>
<p><img loading="lazy" src="https://raw.githubusercontent.com/lishensuo/images2/main/img01/image-20240808203233504.png" alt="image-20240808203233504"  />
</p>
<ul>
<li>åŒå‘RNNæ¨¡å‹çš„è®¡ç®—é€Ÿåº¦è¾ƒæ…¢ï¼Œä¸»è¦åŸå› æ˜¯ç½‘ç»œçš„å‰å‘ä¼ æ’­éœ€è¦åœ¨åŒå‘å±‚ä¸­è¿›è¡Œå‰å‘å’Œåå‘é€’å½’ï¼Œ å¹¶ä¸”ç½‘ç»œçš„åå‘ä¼ æ’­è¿˜ä¾èµ–äºå‰å‘ä¼ æ’­çš„ç»“æœã€‚ å› æ­¤ï¼Œæ¢¯åº¦æ±‚è§£å°†æœ‰ä¸€ä¸ªéå¸¸é•¿çš„é“¾ã€‚</li>
<li>æ­¤å¤–ï¼ŒåŒå‘RNNæ¨¡å‹çš„åº”ç”¨åœºæ™¯æœ‰é™ï¼Œä¸é€‚åˆç”¨äºä¸‹æ–‡é¢„æµ‹ï¼›å¯ä»¥ç”¨äºå¡«å……ç¼ºå¤±çš„å•è¯ã€è¯å…ƒæ³¨é‡Šï¼Œæœºå™¨ç¿»è¯‘ç­‰ã€‚</li>
</ul>
<h2 id="42-é”™è¯¯åº”ç”¨">4.2 é”™è¯¯åº”ç”¨<a hidden class="anchor" aria-hidden="true" href="#42-é”™è¯¯åº”ç”¨">#</a></h2>
<ul>
<li>å¦‚ä¸Šï¼ŒåŒå‘RNNåœ¨é¢„æµ‹æ—¶éœ€è¦ç”¨åˆ°è¿‡å»å’Œæœªæ¥çš„æ•°æ®ï¼Œä¸é€‚åˆç”¨äºé¢„æµ‹æœªæ¥è¯å…ƒï¼Œå°½ç®¡æœ‰æ—¶æ¨¡å‹è®­ç»ƒæ€§èƒ½è¾ƒå¥½ã€‚</li>
<li>åœ¨torchä¸­å®ç°ä¹Ÿå¾ˆç®€å•ï¼Œä»…éœ€è¦è®¾ç½®ç›¸åº”çš„å‚æ•°å³å¯ã€‚</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> torch <span style="color:#fff;font-weight:bold">import</span> nn
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> d2l <span style="color:#fff;font-weight:bold">import</span> torch <span style="color:#fff;font-weight:bold">as</span> d2l
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># åŠ è½½æ•°æ®</span>
</span></span><span style="display:flex;"><span>batch_size, num_steps, device = <span style="color:#ff0;font-weight:bold">32</span>, <span style="color:#ff0;font-weight:bold">35</span>, d2l.try_gpu()
</span></span><span style="display:flex;"><span>train_iter, vocab = d2l.load_data_time_machine(batch_size, num_steps)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># é€šè¿‡è®¾ç½®â€œbidirective=Trueâ€æ¥å®šä¹‰åŒå‘LSTMæ¨¡å‹</span>
</span></span><span style="display:flex;"><span>vocab_size, num_hiddens, num_layers = <span style="color:#fff;font-weight:bold">len</span>(vocab), <span style="color:#ff0;font-weight:bold">256</span>, <span style="color:#ff0;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>num_inputs = vocab_size
</span></span><span style="display:flex;"><span>lstm_layer = nn.LSTM(num_inputs, num_hiddens, num_layers, bidirectional=<span style="color:#fff;font-weight:bold">True</span>) 
</span></span><span style="display:flex;"><span>model = d2l.RNNModel(lstm_layer, <span style="color:#fff;font-weight:bold">len</span>(vocab))
</span></span><span style="display:flex;"><span>model = model.to(device)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># è®­ç»ƒæ¨¡å‹</span>
</span></span><span style="display:flex;"><span>num_epochs, lr = <span style="color:#ff0;font-weight:bold">500</span>, <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>d2l.train_ch8(model, train_iter, vocab, lr, num_epochs, device)
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># perplexity 1.1, 64036.4 tokens/sec on cuda:0</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># time travellerererererererererererererererererererererererererer</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># travellerererererererererererererererererererererererererer</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="5-æœºå™¨ç¿»è¯‘ä¸æ•°æ®é›†">5. æœºå™¨ç¿»è¯‘ä¸æ•°æ®é›†<a hidden class="anchor" aria-hidden="true" href="#5-æœºå™¨ç¿»è¯‘ä¸æ•°æ®é›†">#</a></h1>
<ul>
<li>æœºå™¨ç¿»è¯‘æ˜¯å°†ä¸€ç§è¯­è¨€ç¿»è¯‘ä¸ºå¦ä¸€ç§è¯­è¨€ï¼›</li>
<li>å¯ä»¥ç†è§£ä¸ºæ˜¯å°†è¾“å…¥åºåˆ—è½¬æ¢æˆè¾“å‡ºåºåˆ—çš„åºåˆ—è½¬æ¢æ¨¡å‹ã€‚</li>
<li>æ¥ä¸‹æ¥çš„åé¢å‡ èŠ‚éƒ½å°†å­¦ä¹ å¦‚ä½•å®ç°</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> d2l <span style="color:#fff;font-weight:bold">import</span> torch <span style="color:#fff;font-weight:bold">as</span> d2l
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="51-ä¸‹è½½å’Œé¢„å¤„ç†">5.1 ä¸‹è½½å’Œé¢„å¤„ç†<a hidden class="anchor" aria-hidden="true" href="#51-ä¸‹è½½å’Œé¢„å¤„ç†">#</a></h2>
<ul>
<li>ç¤ºä¾‹æ•°æ®æ˜¯ä¸€ä¸ª&rsquo;è‹±è¯­â€”æ³•è¯­&rsquo;æ–‡æœ¬æ•°æ®é›†ã€‚</li>
<li>æ¯ä¸€è¡Œéƒ½æ˜¯ç”±åˆ¶è¡¨ç¬¦åˆ†å‰²çš„æ–‡æœ¬åºåˆ—å¯¹ã€‚</li>
<li>æ–‡æœ¬åºåˆ—å¯ä»¥æ˜¯å•è¯ï¼Œå¥å­ï¼Œæ®µè½ï¼ˆåŒ…å«æ ‡ç‚¹ï¼‰</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f">#@save</span>
</span></span><span style="display:flex;"><span>d2l.DATA_HUB[<span style="color:#0ff;font-weight:bold">&#39;fra-eng&#39;</span>] = (d2l.DATA_URL + <span style="color:#0ff;font-weight:bold">&#39;fra-eng.zip&#39;</span>,
</span></span><span style="display:flex;"><span>                           <span style="color:#0ff;font-weight:bold">&#39;94646ad1522d915e7b0f9296181140edcf86a4f5&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#@save</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> read_data_nmt():
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;è½½å…¥â€œè‹±è¯­ï¼æ³•è¯­â€æ•°æ®é›†&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    data_dir = d2l.download_extract(<span style="color:#0ff;font-weight:bold">&#39;fra-eng&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">with</span> <span style="color:#fff;font-weight:bold">open</span>(os.path.join(data_dir, <span style="color:#0ff;font-weight:bold">&#39;fra.txt&#39;</span>), <span style="color:#0ff;font-weight:bold">&#39;r&#39;</span>,
</span></span><span style="display:flex;"><span>             encoding=<span style="color:#0ff;font-weight:bold">&#39;utf-8&#39;</span>) <span style="color:#fff;font-weight:bold">as</span> f:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> f.read()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>raw_text = read_data_nmt()
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">print</span>(raw_text[:<span style="color:#ff0;font-weight:bold">20</span>])
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># Go.	Va !</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># Hi.	Salut !</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>æ–‡æœ¬é¢„å¤„ç†æ“ä½œ</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f">#@save</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> preprocess_nmt(text):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;é¢„å¤„ç†â€œè‹±è¯­ï¼æ³•è¯­â€æ•°æ®é›†&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># è¿”å›é€»è¾‘å€¼ï¼šå­—ç¬¦æ˜¯å¦ä¸ºæ ‡ç‚¹ç¬¦å·ï¼Œä¸”è¯¥å­—ç¬¦å‰æ˜¯å¦æ²¡æœ‰ç©ºæ ¼</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> no_space(char, prev_char):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> char in <span style="color:#fff;font-weight:bold">set</span>(<span style="color:#0ff;font-weight:bold">&#39;,.!?&#39;</span>) and prev_char != <span style="color:#0ff;font-weight:bold">&#39; &#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># ä½¿ç”¨ç©ºæ ¼æ›¿æ¢ä¸é—´æ–­ç©ºæ ¼</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># ä½¿ç”¨å°å†™å­—æ¯æ›¿æ¢å¤§å†™å­—æ¯</span>
</span></span><span style="display:flex;"><span>    text = text.replace(<span style="color:#0ff;font-weight:bold">&#39;</span><span style="color:#0ff;font-weight:bold">\u202f</span><span style="color:#0ff;font-weight:bold">&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39; &#39;</span>).replace(<span style="color:#0ff;font-weight:bold">&#39;</span><span style="color:#0ff;font-weight:bold">\xa0</span><span style="color:#0ff;font-weight:bold">&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39; &#39;</span>).lower()
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># åœ¨å•è¯å’Œæ ‡ç‚¹ç¬¦å·ä¹‹é—´æ’å…¥ç©ºæ ¼</span>
</span></span><span style="display:flex;"><span>    out = [<span style="color:#0ff;font-weight:bold">&#39; &#39;</span> + char <span style="color:#fff;font-weight:bold">if</span> i &gt; <span style="color:#ff0;font-weight:bold">0</span> and no_space(char, text[i - <span style="color:#ff0;font-weight:bold">1</span>]) <span style="color:#fff;font-weight:bold">else</span> char
</span></span><span style="display:flex;"><span>           <span style="color:#fff;font-weight:bold">for</span> i, char in <span style="color:#fff;font-weight:bold">enumerate</span>(text)]
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#39;&#39;</span>.join(out)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>text = preprocess_nmt(raw_text)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">print</span>(text[:<span style="color:#ff0;font-weight:bold">25</span>])
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># go .	va !</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># hi .	salut !</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># ru</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="52-è¯å…ƒåŒ–">5.2 è¯å…ƒåŒ–<a hidden class="anchor" aria-hidden="true" href="#52-è¯å…ƒåŒ–">#</a></h2>
<ul>
<li>å°†å•è¯ä»¥åŠæ ‡ç‚¹ç¬¦å·è®¤ä¸ºæ˜¯è¯å…ƒ</li>
<li>åœ¨æ¯ä¸€è¡Œä¸­ï¼Œå¯¹åˆ¶è¡¨ç¬¦å‰åçš„æ–‡æœ¬åˆ†åˆ«è¿›è¡Œè¯å…ƒåŒ–ï¼Œä½œä¸ºsourceä¸target</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f">#@save</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> tokenize_nmt(text, num_examples=<span style="color:#fff;font-weight:bold">None</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;è¯å…ƒåŒ–â€œè‹±è¯­ï¼æ³•è¯­â€æ•°æ®æ•°æ®é›†&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    source, target = [], []
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> i, line in <span style="color:#fff;font-weight:bold">enumerate</span>(text.split(<span style="color:#0ff;font-weight:bold">&#39;</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">&#39;</span>)):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> num_examples and i &gt; num_examples:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>        parts = line.split(<span style="color:#0ff;font-weight:bold">&#39;</span><span style="color:#0ff;font-weight:bold">\t</span><span style="color:#0ff;font-weight:bold">&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">len</span>(parts) == <span style="color:#ff0;font-weight:bold">2</span>:
</span></span><span style="display:flex;"><span>            source.append(parts[<span style="color:#ff0;font-weight:bold">0</span>].split(<span style="color:#0ff;font-weight:bold">&#39; &#39;</span>))
</span></span><span style="display:flex;"><span>            target.append(parts[<span style="color:#ff0;font-weight:bold">1</span>].split(<span style="color:#0ff;font-weight:bold">&#39; &#39;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> source, target
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#list of list</span>
</span></span><span style="display:flex;"><span>source, target = tokenize_nmt(text)
</span></span><span style="display:flex;"><span>source[:<span style="color:#ff0;font-weight:bold">3</span>], target[:<span style="color:#ff0;font-weight:bold">3</span>]
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># ([[&#39;go&#39;, &#39;.&#39;], [&#39;hi&#39;, &#39;.&#39;], [&#39;run&#39;, &#39;!&#39;]],</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#  [[&#39;va&#39;, &#39;!&#39;], [&#39;salut&#39;, &#39;!&#39;], [&#39;cours&#39;, &#39;!&#39;]])</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="53-è¯è¡¨">5.3 è¯è¡¨<a hidden class="anchor" aria-hidden="true" href="#53-è¯è¡¨">#</a></h2>
<ul>
<li>åˆ†åˆ«ä¸ºæºè¯­è¨€ï¼ˆè‹±è¯­ï¼‰ä»¥åŠç›®æ ‡ï¼ˆæ³•è¯­ï¼‰è¯­è¨€æ„å»ºè¯è¡¨ï¼›</li>
<li>å°†è¯é¢‘ä½äº2çš„è¯å…ƒè®¾ç½®ä¸º&rsquo;&lt;unk&gt;'</li>
<li>æ­¤å¤–ï¼Œé¢å¤–æŒ‡å®šå‡ ä¸ªç‰¹æ®Šè¯å…ƒ
<ul>
<li>&lsquo;&lt;pad&gt;&rsquo; å¡«å……è¯å…ƒ</li>
<li>&lsquo;&lt;bos&gt;&rsquo; å¼€å§‹è¯å…ƒ</li>
<li>&lsquo;&lt;eos&gt;&rsquo; ç»“æŸè¯å…ƒ</li>
</ul>
</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f"># å¦‚ä¸‹ä»¥æºè¯­è¨€ä¸ºä¾‹</span>
</span></span><span style="display:flex;"><span>src_vocab = d2l.Vocab(source, min_freq=<span style="color:#ff0;font-weight:bold">2</span>,
</span></span><span style="display:flex;"><span>                      reserved_tokens=[<span style="color:#0ff;font-weight:bold">&#39;&lt;pad&gt;&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;&lt;bos&gt;&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;&lt;eos&gt;&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">len</span>(src_vocab) <span style="color:#007f7f">#è¯å…ƒç±»åˆ«æ•°</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 10012</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="54-åŠ è½½æ•°æ®é›†">5.4 åŠ è½½æ•°æ®é›†<a hidden class="anchor" aria-hidden="true" href="#54-åŠ è½½æ•°æ®é›†">#</a></h2>
<ul>
<li>ä¸ºäº†ä¾¿äºè®­ç»ƒï¼Œéœ€è¦å°†è¾“å…¥åºåˆ—ä¸ºè®¾ç½®ä¸ºå›ºå®šé•¿åº¦ã€‚æ­¤æ—¶ä¼šæœ‰å¦‚ä¸‹ä¸¤ç§æƒ…å†µ
<ul>
<li><strong>æˆªæ–­</strong>ï¼šä»…å–å‰é¢é¢„æœŸåºåˆ—é•¿åº¦çš„è¯å…ƒï¼Œä¸¢å¼ƒåé¢çš„è¯å…ƒ</li>
<li><strong>å¡«å……</strong>ï¼šå½“ä¸æ»¡è¶³é¢„æœŸåºåˆ—é•¿åº¦æ—¶ï¼Œåœ¨åé¢å¡«å……è¡¥é½</li>
</ul>
</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f">#@save</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> truncate_pad(line, num_steps, padding_token):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;æˆªæ–­æˆ–å¡«å……æ–‡æœ¬åºåˆ—&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">len</span>(line) &gt; num_steps:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> line[:num_steps]  <span style="color:#007f7f"># æˆªæ–­</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> line + [padding_token] * (num_steps - <span style="color:#fff;font-weight:bold">len</span>(line))  <span style="color:#007f7f"># å¡«å……</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># å¦‚ä¸‹ç¤ºä¾‹ï¼Œå¯¹sourceçš„ç¬¬ä¸€ä¸ªè¯å…ƒåºåˆ—è¿›è¡Œå¤„ç†ï¼Œä½¿ç”¨å¡«å……å­—ç¬¦å°†é•¿åº¦è¡¥åˆ°10</span>
</span></span><span style="display:flex;"><span>truncate_pad(src_vocab[source[<span style="color:#ff0;font-weight:bold">0</span>]], <span style="color:#ff0;font-weight:bold">10</span>, src_vocab[<span style="color:#0ff;font-weight:bold">&#39;&lt;pad&gt;&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># [47, 4, 1, 1, 1, 1, 1, 1, 1, 1]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œå¯¹source/targetè¿›è¡Œä¸Šè¿°å¤„ç†ï¼Œå¹¶åœ¨åºåˆ—ç»“å°¾åŠ ä¸Šä¸€ä¸ª&rsquo;&lt;eos&gt;&lsquo;è¯å…ƒ
<ul>
<li>æ­¤å¤–ï¼Œä¼šç»Ÿè®¡ä¸€ä¸‹æ¯ä¸ªåºåˆ—çš„æœ‰æ•ˆé•¿åº¦ï¼ˆé™¤å»å¡«å……è¯å…ƒï¼‰</li>
</ul>
</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f">#@save</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> build_array_nmt(lines, vocab, num_steps):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;å°†æœºå™¨ç¿»è¯‘çš„æ–‡æœ¬åºåˆ—è½¬æ¢æˆå°æ‰¹é‡&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    lines = [vocab[l] <span style="color:#fff;font-weight:bold">for</span> l in lines]
</span></span><span style="display:flex;"><span>    lines = [l + [vocab[<span style="color:#0ff;font-weight:bold">&#39;&lt;eos&gt;&#39;</span>]] <span style="color:#fff;font-weight:bold">for</span> l in lines]
</span></span><span style="display:flex;"><span>    array = torch.tensor([truncate_pad(
</span></span><span style="display:flex;"><span>        l, num_steps, vocab[<span style="color:#0ff;font-weight:bold">&#39;&lt;pad&gt;&#39;</span>]) <span style="color:#fff;font-weight:bold">for</span> l in lines])
</span></span><span style="display:flex;"><span>    valid_len = (array != vocab[<span style="color:#0ff;font-weight:bold">&#39;&lt;pad&gt;&#39;</span>]).type(torch.int32).sum(<span style="color:#ff0;font-weight:bold">1</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> array, valid_len
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="55-æœ€ç»ˆå½¢å¼">5.5 æœ€ç»ˆå½¢å¼<a hidden class="anchor" aria-hidden="true" href="#55-æœ€ç»ˆå½¢å¼">#</a></h2>
<ul>
<li>å®šä¹‰ä¸€ä¸ªç»¼åˆå‡½æ•°ï¼Œè¿”å›æ•°æ®è¿­ä»£å™¨ï¼Œæºè¯­è¨€è¯è¡¨ï¼Œç›®æ ‡è¯­è¨€è¯è¡¨
<ul>
<li>æ•°æ®è¿­ä»£å™¨æ¯æ¬¡è¿”å›ä¸€ä¸ªæ‰¹é‡çš„è¾“å…¥åºåˆ—ä¸è¾“å‡ºåºåˆ—</li>
</ul>
</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f">#@save</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> load_data_nmt(batch_size, num_steps, num_examples=<span style="color:#ff0;font-weight:bold">600</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;è¿”å›ç¿»è¯‘æ•°æ®é›†çš„è¿­ä»£å™¨å’Œè¯è¡¨&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    text = preprocess_nmt(read_data_nmt())
</span></span><span style="display:flex;"><span>    source, target = tokenize_nmt(text, num_examples)
</span></span><span style="display:flex;"><span>    src_vocab = d2l.Vocab(source, min_freq=<span style="color:#ff0;font-weight:bold">2</span>,
</span></span><span style="display:flex;"><span>                          reserved_tokens=[<span style="color:#0ff;font-weight:bold">&#39;&lt;pad&gt;&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;&lt;bos&gt;&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;&lt;eos&gt;&#39;</span>])
</span></span><span style="display:flex;"><span>    tgt_vocab = d2l.Vocab(target, min_freq=<span style="color:#ff0;font-weight:bold">2</span>,
</span></span><span style="display:flex;"><span>                          reserved_tokens=[<span style="color:#0ff;font-weight:bold">&#39;&lt;pad&gt;&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;&lt;bos&gt;&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;&lt;eos&gt;&#39;</span>])
</span></span><span style="display:flex;"><span>    src_array, src_valid_len = build_array_nmt(source, src_vocab, num_steps)
</span></span><span style="display:flex;"><span>    tgt_array, tgt_valid_len = build_array_nmt(target, tgt_vocab, num_steps)
</span></span><span style="display:flex;"><span>    data_arrays = (src_array, src_valid_len, tgt_array, tgt_valid_len)
</span></span><span style="display:flex;"><span>    data_iter = d2l.load_array(data_arrays, batch_size)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> data_iter, src_vocab, tgt_vocab
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ç¤ºä¾‹</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>train_iter, src_vocab, tgt_vocab = load_data_nmt(batch_size=<span style="color:#ff0;font-weight:bold">2</span>, num_steps=<span style="color:#ff0;font-weight:bold">8</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">for</span> X, X_valid_len, Y, Y_valid_len in train_iter:
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;X:&#39;</span>, X.type(torch.int32))
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;Xçš„æœ‰æ•ˆé•¿åº¦:&#39;</span>, X_valid_len)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;Y:&#39;</span>, Y.type(torch.int32))
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;Yçš„æœ‰æ•ˆé•¿åº¦:&#39;</span>, Y_valid_len)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># X: tensor([[ 58,  47,   4,   3,   1,   1,   1,   1],</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#         [  7, 102,   5,   3,   1,   1,   1,   1]], dtype=torch.int32)</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># Xçš„æœ‰æ•ˆé•¿åº¦: tensor([4, 4])</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># Y: tensor([[ 18,  14,  34,   4,   3,   1,   1,   1],</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#         [  6,   7, 161,   5,   3,   1,   1,   1]], dtype=torch.int32)</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># Yçš„æœ‰æ•ˆé•¿åº¦: tensor([5, 5])</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="6-ç¼–ç å™¨ä¸è§£ç å™¨æ¶æ„">6. ç¼–ç å™¨ä¸è§£ç å™¨æ¶æ„<a hidden class="anchor" aria-hidden="true" href="#6-ç¼–ç å™¨ä¸è§£ç å™¨æ¶æ„">#</a></h1>
<ul>
<li>å¯¹äºä¹‹å‰å­¦ä¹ çš„CNNä»¥åŠç°åœ¨å­¦ä¹ çš„RNNï¼Œéƒ½å¯ä»¥ç†è§£ä¸ºç¼–ç å™¨ä¸è§£ç å™¨æ¶æ„ï¼›</li>
</ul>
<img src="https://raw.githubusercontent.com/lishensuo/images2/main/img01/image-20240809072826713.png" alt="image-20240809072826713" style="zoom:50%;" />
<ul>
<li><strong>ç¼–ç å™¨</strong>ï¼šå°†è¾“å…¥å˜æ¢ä¸ºä¸­é—´è¡¨è¾¾å½¢å¼ï¼ˆç‰¹å¾ï¼‰ï¼›
<ul>
<li>å¯¹äºRNNï¼Œå¯å°†é•¿åº¦å¯å˜çš„åºåˆ—ä½œä¸ºè¾“å…¥ï¼Œè½¬æ¢ä¸ºå…·æœ‰å›ºå®šå½¢çŠ¶çš„ç¼–ç çŠ¶æ€</li>
</ul>
</li>
<li><strong>è§£ç å™¨</strong>ï¼šå°†æå–çš„ä¸­é—´è¡¨ç¤ºç¼–ç æˆè¾“å‡ºã€‚
<ul>
<li>å¯¹äºRNNï¼Œå°†å›ºå®šå½¢çŠ¶çš„ç¼–ç çŠ¶æ€æ˜ å°„åˆ°é•¿åº¦å¯å˜çš„åºåˆ—</li>
</ul>
</li>
</ul>
<p><img loading="lazy" src="https://raw.githubusercontent.com/lishensuo/images2/main/img01/image-20240809073527675.png" alt="image-20240809073527675"  />
</p>
<p>æ¥ä¸‹æ¥å®šä¹‰ä¸€ä¸ªæŠ½è±¡çš„ç¼–ç å™¨-è§£ç å™¨æ¥å£ï¼Œä»¥æ–¹ä¾¿åç»­çš„å®ç°</p>
<h2 id="61-ç¼–ç å™¨">6.1 ç¼–ç å™¨<a hidden class="anchor" aria-hidden="true" href="#61-ç¼–ç å™¨">#</a></h2>
<ul>
<li>åœ¨ç¼–ç å™¨æ¥å£ä¸­ï¼ŒæŒ‡å®šé•¿åº¦å¯å˜çš„åºåˆ—ä½œä¸ºè¾“å…¥X</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> torch <span style="color:#fff;font-weight:bold">import</span> nn
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#@save</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> Encoder(nn.Module):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;ç¼–ç å™¨-è§£ç å™¨æ¶æ„çš„åŸºæœ¬ç¼–ç å™¨æ¥å£&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> __init__(<span style="color:#fff;font-weight:bold">self</span>, **kwargs):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">super</span>(Encoder, <span style="color:#fff;font-weight:bold">self</span>).__init__(**kwargs)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> forward(<span style="color:#fff;font-weight:bold">self</span>, X, *args):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">raise</span> NotImplementedError
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><code>raise NotImplementedError</code> æ˜¯ä¸€ç§ç¼–ç¨‹æ¨¡å¼ï¼Œç”¨äºè¡¨æ˜æŸä¸ªæ–¹æ³•æˆ–åŠŸèƒ½è¿˜æ²¡æœ‰å‡†å¤‡å¥½æˆ–è€…éœ€è¦è¢«å­ç±»è¦†ç›–ä»¥æä¾›å®é™…çš„è¡Œä¸ºã€‚</p></blockquote>
<h2 id="62-è§£ç å™¨">6.2 è§£ç å™¨<a hidden class="anchor" aria-hidden="true" href="#62-è§£ç å™¨">#</a></h2>
<ul>
<li><code>init_state</code>ç”¨äºåˆå§‹åŒ–è§£ç å™¨çš„çŠ¶æ€ã€‚
<ul>
<li>ä¸»è¦æ˜¯å°†ç¼–ç å™¨çš„è¾“å‡ºè½¬æ¢ä¸ºç¼–ç åçš„çŠ¶æ€</li>
</ul>
</li>
<li>æ ¹æ®RNNæ€è·¯ï¼Œè§£ç å™¨åœ¨æ¯ä¸ªæ—¶é—´æ­¥éƒ½ä¼šå°†è¾“å…¥<strong>X</strong> ï¼ˆä¾‹å¦‚ï¼šåœ¨å‰ä¸€æ—¶é—´æ­¥ç”Ÿæˆçš„è¯å…ƒï¼‰å’Œç¼–ç åçš„çŠ¶æ€ æ˜ å°„æˆå½“å‰æ—¶é—´æ­¥çš„è¾“å‡ºè¯å…ƒã€‚</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f">#@save</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> Decoder(nn.Module):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;ç¼–ç å™¨-è§£ç å™¨æ¶æ„çš„åŸºæœ¬è§£ç å™¨æ¥å£&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> __init__(<span style="color:#fff;font-weight:bold">self</span>, **kwargs):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">super</span>(Decoder, <span style="color:#fff;font-weight:bold">self</span>).__init__(**kwargs)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> init_state(<span style="color:#fff;font-weight:bold">self</span>, enc_outputs, *args):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">raise</span> NotImplementedError
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> forward(<span style="color:#fff;font-weight:bold">self</span>, X, state):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">raise</span> NotImplementedError
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="63-åˆå¹¶ç¼–ç å™¨ä¸è§£ç å™¨">6.3 åˆå¹¶ç¼–ç å™¨ä¸è§£ç å™¨<a hidden class="anchor" aria-hidden="true" href="#63-åˆå¹¶ç¼–ç å™¨ä¸è§£ç å™¨">#</a></h2>
<p>åœ¨å‰å‘ä¼ æ’­ä¸­ï¼Œ</p>
<ul>
<li>ç¼–ç å™¨çš„è¾“å‡ºç”¨äºç”Ÿæˆç¼–ç çŠ¶æ€ï¼›</li>
<li>è¿™ä¸ªçŠ¶æ€åˆè¢«è§£ç å™¨ä½œä¸ºå…¶è¾“å…¥çš„ä¸€éƒ¨åˆ†ã€‚</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f">#@save</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> EncoderDecoder(nn.Module):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;ç¼–ç å™¨-è§£ç å™¨æ¶æ„çš„åŸºç±»&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> __init__(<span style="color:#fff;font-weight:bold">self</span>, encoder, decoder, **kwargs):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">super</span>(EncoderDecoder, <span style="color:#fff;font-weight:bold">self</span>).__init__(**kwargs)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">self</span>.encoder = encoder
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">self</span>.decoder = decoder
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> forward(<span style="color:#fff;font-weight:bold">self</span>, enc_X, dec_X, *args):
</span></span><span style="display:flex;"><span>        enc_outputs = <span style="color:#fff;font-weight:bold">self</span>.encoder(enc_X, *args)
</span></span><span style="display:flex;"><span>        dec_state = <span style="color:#fff;font-weight:bold">self</span>.decoder.init_state(enc_outputs, *args)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">self</span>.decoder(dec_X, dec_state)
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="7-åºåˆ—åˆ°åºåˆ—å­¦ä¹ seq2seq">7. åºåˆ—åˆ°åºåˆ—å­¦ä¹ (seq2seq)<a hidden class="anchor" aria-hidden="true" href="#7-åºåˆ—åˆ°åºåˆ—å­¦ä¹ seq2seq">#</a></h1>
<ul>
<li>åºåˆ—åˆ°åºåˆ—å­¦ä¹ æ¨¡å‹ç”±ä¸¤ä¸ªRNNçš„ç¼–ç å™¨ä¸è§£ç å™¨ç»„æˆ
<ul>
<li><strong>ç¼–ç å™¨RNN</strong>ï¼šå°†è¾“å…¥åºåˆ—çš„ä¿¡æ¯ç¼–ç ä¸ºå›ºå®šå½¢çŠ¶çš„éšçŠ¶æ€ã€‚</li>
<li><strong>è§£ç å™¨RNN</strong>ï¼šåŸºäºç¼–ç å™¨è¾“å…¥åºåˆ—çš„ç¼–ç ä¿¡æ¯ä»¥åŠå½“å‰æ—¶é—´æ­¥çš„è¯å…ƒï¼Œæ¥é¢„æµ‹ä¸‹ä¸€ä¸ªè¯å…ƒã€‚</li>
</ul>
</li>
</ul>
<img src="https://raw.githubusercontent.com/lishensuo/images2/main/img01/image-20240809142553682.png" alt="image-20240809142553682" style="zoom: 67%;" />
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> collections
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> math
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> torch <span style="color:#fff;font-weight:bold">import</span> nn
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> d2l <span style="color:#fff;font-weight:bold">import</span> torch <span style="color:#fff;font-weight:bold">as</span> d2l
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="71-ç¼–ç å™¨">7.1 ç¼–ç å™¨<a hidden class="anchor" aria-hidden="true" href="#71-ç¼–ç å™¨">#</a></h2>
<ul>
<li>åœ¨ç¼–ç å™¨RNNéƒ¨åˆ†ï¼Œä¸»è¦ç›®çš„æ˜¯å¾—åˆ°è¾“å…¥åºåˆ—æœ€åä¸€ä¸ªæ—¶é—´æ­¥çš„éšçŠ¶æ€è¡¨ç¤ºï¼ˆå¯ä»¥æœ‰å¤šå±‚ï¼‰ã€‚</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f">#@save</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> Seq2SeqEncoder(d2l.Encoder):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;ç”¨äºåºåˆ—åˆ°åºåˆ—å­¦ä¹ çš„å¾ªç¯ç¥ç»ç½‘ç»œç¼–ç å™¨&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> __init__(<span style="color:#fff;font-weight:bold">self</span>, vocab_size, embed_size, num_hiddens, num_layers,
</span></span><span style="display:flex;"><span>                 dropout=<span style="color:#ff0;font-weight:bold">0</span>, **kwargs):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">super</span>(Seq2SeqEncoder, <span style="color:#fff;font-weight:bold">self</span>).__init__(**kwargs)
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># åµŒå…¥å±‚ï¼šæå–æ¯ä¸ªè¯å…ƒçš„ç‰¹å¾å‘é‡</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">self</span>.embedding = nn.Embedding(vocab_size, embed_size)
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># è¿™é‡Œä½¿ç”¨å¤šå±‚çš„GRUå¾ªç¯ç¥ç»ç½‘ç»œ</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">self</span>.rnn = nn.GRU(embed_size, num_hiddens, num_layers,
</span></span><span style="display:flex;"><span>                          dropout=dropout)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> forward(<span style="color:#fff;font-weight:bold">self</span>, X, *args):
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># è¾“å…¥&#39;X&#39;çš„å½¢çŠ¶ï¼š(batch_size,num_steps)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># è¾“å‡º&#39;X&#39;çš„å½¢çŠ¶ï¼š(batch_size,num_steps,embed_size)</span>
</span></span><span style="display:flex;"><span>        X = <span style="color:#fff;font-weight:bold">self</span>.embedding(X)
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># åœ¨å¾ªç¯ç¥ç»ç½‘ç»œæ¨¡å‹ä¸­ï¼Œéœ€è¦å°†ç¬¬ä¸€ä¸ªè½´è®¾ç½®ä¸ºæ—¶é—´æ­¥ï¼ˆæ‰¹é‡å†…çš„å­åºåˆ—ï¼‰</span>
</span></span><span style="display:flex;"><span>        X = X.permute(<span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">0</span>, <span style="color:#ff0;font-weight:bold">2</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># å¦‚æœæœªæåŠçŠ¶æ€ï¼Œåˆ™é»˜è®¤ä¸º0</span>
</span></span><span style="display:flex;"><span>        output, state = <span style="color:#fff;font-weight:bold">self</span>.rnn(X)
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># outputçš„å½¢çŠ¶:(num_steps,batch_size,num_hiddens)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># stateçš„å½¢çŠ¶:(num_layers,batch_size,num_hiddens)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> output, state
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>outputæ˜¯åŸºäºæ¯ä¸ªæ—¶é—´æ­¥æœ€åä¸€å±‚çš„éšçŠ¶æ€ï¼ˆä¸€èˆ¬æƒ…å†µä¸‹åé¢éœ€è¦è·Ÿå…¨è¿æ¥å±‚è¿›è¡Œé¢„æµ‹è¾“å‡ºï¼‰ï¼›</p>
<p>stateæ˜¯æœ€åä¸€ä¸ªæ—¶é—´æ­¥çš„å¤šå±‚çš„éšçŠ¶æ€ã€‚</p></blockquote>
<ul>
<li>ç¤ºä¾‹</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>encoder = Seq2SeqEncoder(vocab_size=<span style="color:#ff0;font-weight:bold">10</span>, embed_size=<span style="color:#ff0;font-weight:bold">8</span>, num_hiddens=<span style="color:#ff0;font-weight:bold">16</span>,
</span></span><span style="display:flex;"><span>                         num_layers=<span style="color:#ff0;font-weight:bold">2</span>)
</span></span><span style="display:flex;"><span>encoder.eval()
</span></span><span style="display:flex;"><span>X = torch.zeros((<span style="color:#ff0;font-weight:bold">4</span>, <span style="color:#ff0;font-weight:bold">7</span>), dtype=torch.long)
</span></span><span style="display:flex;"><span>output, state = encoder(X)
</span></span><span style="display:flex;"><span>output.shape
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># torch.Size([7, 4, 16])  #(æ—¶é—´æ­¥æ•°ï¼Œæ‰¹é‡å¤§å°ï¼Œéšè—å•å…ƒæ•°)</span>
</span></span><span style="display:flex;"><span>state.shape
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># torch.Size([2, 4, 16])  #(éšè—å±‚çš„æ•°é‡ï¼Œæ‰¹é‡å¤§å°ï¼Œéšè—å•å…ƒçš„æ•°é‡)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># output æ‰¹é‡å†…ç¬¬1ä¸ªå­åºåˆ—çš„ç¬¬7ä¸ªæ—¶é—´æ­¥çš„å‰5ä¸ªå€¼</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># state æ‰¹é‡å†…ç¬¬1ä¸ªå­åºåˆ—çš„æœ€åä¸€ä¸ªæ—¶é—´æ­¥çš„ç¬¬2å±‚çš„å‰5ä¸ªå€¼</span>
</span></span><span style="display:flex;"><span>output[<span style="color:#ff0;font-weight:bold">6</span>, <span style="color:#ff0;font-weight:bold">0</span>, :<span style="color:#ff0;font-weight:bold">5</span>], state[<span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">0</span>, :<span style="color:#ff0;font-weight:bold">5</span>]
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># (tensor([ 0.0533, -0.2092,  0.0406, -0.0956, -0.3704], grad_fn=&lt;SliceBackward0&gt;),</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#  tensor([ 0.0533, -0.2092,  0.0406, -0.0956, -0.3704], grad_fn=&lt;SliceBackward0&gt;))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="72-è§£ç å™¨">7.2 è§£ç å™¨<a hidden class="anchor" aria-hidden="true" href="#72-è§£ç å™¨">#</a></h2>
<p>åœ¨è§£ç å™¨RNNä¸­ï¼Œ</p>
<ul>
<li>ä¸€æ–¹é¢ï¼Œä¼šç»§æ‰¿ç¼–ç å™¨RNNçš„æœ€åä¸€ä¸ªæ—¶é—´æ­¥çš„æ‰€æœ‰éšçŠ¶æ€ï¼Œä½œä¸ºè§£ç å™¨è¾“å…¥åºåˆ—çš„åˆå§‹åŒ–éšçŠ¶æ€ï¼›</li>
<li>å¦ä¸€æ–¹é¢ä¼šå°†ç¼–ç å™¨RNNçš„æœ€åä¸€ä¸ªæ—¶é—´æ­¥çš„æœ€åä¸€å±‚éšçŠ¶æ€ï¼Œä½œä¸ºè§£ç å™¨è¾“å…¥åºåˆ—ä¸­æ¯ä¸ªè§‚æµ‹è¯å…ƒçš„ä¸€éƒ¨åˆ†ç‰¹å¾ï¼ˆå‚è€ƒä¸Šå›¾ï¼‰ã€‚</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> Seq2SeqDecoder(d2l.Decoder):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;ç”¨äºåºåˆ—åˆ°åºåˆ—å­¦ä¹ çš„å¾ªç¯ç¥ç»ç½‘ç»œè§£ç å™¨&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> __init__(<span style="color:#fff;font-weight:bold">self</span>, vocab_size, embed_size, num_hiddens, num_layers,
</span></span><span style="display:flex;"><span>                 dropout=<span style="color:#ff0;font-weight:bold">0</span>, **kwargs):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">super</span>(Seq2SeqDecoder, <span style="color:#fff;font-weight:bold">self</span>).__init__(**kwargs)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">self</span>.embedding = nn.Embedding(vocab_size, embed_size)
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># è§‚æµ‹è¯å…ƒè¾“å…¥=è¯å…ƒæœ¬èº«ç‰¹å¾+ç¼–ç å™¨çš„ä¿¡æ¯context</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">self</span>.rnn = nn.GRU(embed_size + num_hiddens, num_hiddens, num_layers,
</span></span><span style="display:flex;"><span>                          dropout=dropout)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">self</span>.dense = nn.Linear(num_hiddens, vocab_size)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> init_state(<span style="color:#fff;font-weight:bold">self</span>, enc_outputs, *args):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> enc_outputs[<span style="color:#ff0;font-weight:bold">1</span>] <span style="color:#007f7f">#å–stateï¼Œè€Œéoutput</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> forward(<span style="color:#fff;font-weight:bold">self</span>, X, state):
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># è¾“å‡º&#39;X&#39;çš„å½¢çŠ¶ï¼š(batch_size,num_steps,embed_size)</span>
</span></span><span style="display:flex;"><span>        X = <span style="color:#fff;font-weight:bold">self</span>.embedding(X).permute(<span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">0</span>, <span style="color:#ff0;font-weight:bold">2</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># å¹¿æ’­contextï¼Œä½¿å…¶å…·æœ‰ä¸Xç›¸åŒçš„num_steps</span>
</span></span><span style="display:flex;"><span>        context = state[-<span style="color:#ff0;font-weight:bold">1</span>].repeat(X.shape[<span style="color:#ff0;font-weight:bold">0</span>], <span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">1</span>)
</span></span><span style="display:flex;"><span>        X_and_context = torch.cat((X, context), <span style="color:#ff0;font-weight:bold">2</span>)
</span></span><span style="display:flex;"><span>        output, state = <span style="color:#fff;font-weight:bold">self</span>.rnn(X_and_context, state)
</span></span><span style="display:flex;"><span>        output = <span style="color:#fff;font-weight:bold">self</span>.dense(output).permute(<span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">0</span>, <span style="color:#ff0;font-weight:bold">2</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># outputçš„å½¢çŠ¶:(batch_size,num_steps,vocab_size)ï¼Œé¢„æµ‹ç»“æœ</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># stateçš„å½¢çŠ¶:(num_layers,batch_size,num_hiddens)ï¼Œè§£ç å™¨åºåˆ—æœ€åä¸€ä¸ªæ—¶é—´æ­¥çš„éšçŠ¶æ€</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> output, state
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://raw.githubusercontent.com/lishensuo/images2/main/img01/image-20240809160845276.png" alt="image-20240809160845276"  />
</p>
<h2 id="73-æŸå¤±å‡½æ•°">7.3 æŸå¤±å‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#73-æŸå¤±å‡½æ•°">#</a></h2>
<ul>
<li>å¯¹äºè§£ç å™¨çš„é¢„æµ‹è¾“å‡ºï¼Œä¸€èˆ¬ä½¿ç”¨å¹³å‡äº¤å‰ç†µæŸå¤±(Softmax)è¯„ä»·ä¸æ ‡ç­¾åºåˆ—çš„å·®å¼‚æŸå¤±ï¼›</li>
<li>åœ¨è®¡ç®—æŸå¤±æ—¶ï¼Œåº”ä¸éœ€è¦å…³æ³¨å¯¹äºåºåˆ—ä¸­çš„å¡«å……è¯å…ƒçš„é¢„æµ‹æ­£ç¡®ä¸å¦
<ul>
<li>æ¢å¥è¯è¯´ï¼Œä»…å…³æ³¨åºåˆ—ä¸­æœ‰æ•ˆè¯å…ƒçš„é¢„æµ‹ç»“æœ</li>
</ul>
</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f">#@save</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> sequence_mask(X, valid_len, value=<span style="color:#ff0;font-weight:bold">0</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;åœ¨åºåˆ—ä¸­å±è”½ä¸ç›¸å…³çš„é¡¹&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    maxlen = X.size(<span style="color:#ff0;font-weight:bold">1</span>)
</span></span><span style="display:flex;"><span>    mask = torch.arange((maxlen), dtype=torch.float32,
</span></span><span style="display:flex;"><span>                        device=X.device)[<span style="color:#fff;font-weight:bold">None</span>, :] &lt; valid_len[:, <span style="color:#fff;font-weight:bold">None</span>]
</span></span><span style="display:flex;"><span>    X[~mask] = value
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> X
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>X = torch.tensor([[<span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">2</span>, <span style="color:#ff0;font-weight:bold">3</span>], [<span style="color:#ff0;font-weight:bold">4</span>, <span style="color:#ff0;font-weight:bold">5</span>, <span style="color:#ff0;font-weight:bold">6</span>]])
</span></span><span style="display:flex;"><span>sequence_mask(X, torch.tensor([<span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">2</span>]))
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># tensor([[1, 0, 0],   #ç¬¬ä¸€ä¸ªè¯å…ƒä»¥å¤–çš„éƒ¨åˆ†è¢«ç½®æ¢ä¸º0</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#         [4, 5, 0]])  #å‰ä¸¤ä¸ªè¯å…ƒä»¥å¤–çš„éƒ¨åˆ†è¢«ç½®æ¢ä¸º0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>æ®æ­¤è‡ªå®šä¹‰ä¸€ä¸ªæŸå¤±å‡½æ•°</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f">#@save</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> MaskedSoftmaxCELoss(nn.CrossEntropyLoss):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;å¸¦é®è”½çš„softmaxäº¤å‰ç†µæŸå¤±å‡½æ•°&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># predçš„å½¢çŠ¶ï¼š(batch_size,num_steps,vocab_size)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># labelçš„å½¢çŠ¶ï¼š(batch_size,num_steps)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># valid_lençš„å½¢çŠ¶ï¼š(batch_size,)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> forward(<span style="color:#fff;font-weight:bold">self</span>, pred, label, valid_len):
</span></span><span style="display:flex;"><span>        weights = torch.ones_like(label)
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">#æ— æ•ˆè¯å…ƒçš„æƒé‡è®¾ç½®ä¸º0ï¼Œå³å¿½ç•¥</span>
</span></span><span style="display:flex;"><span>        weights = sequence_mask(weights, valid_len)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">self</span>.reduction=<span style="color:#0ff;font-weight:bold">&#39;none&#39;</span> <span style="color:#007f7f">#ä¸ä¼šè‡ªåŠ¨å¯¹è¾“å‡ºè¿›è¡Œå¹³å‡æˆ–æ±‚å’Œ</span>
</span></span><span style="display:flex;"><span>        unweighted_loss = <span style="color:#fff;font-weight:bold">super</span>(MaskedSoftmaxCELoss, <span style="color:#fff;font-weight:bold">self</span>).forward(
</span></span><span style="display:flex;"><span>            pred.permute(<span style="color:#ff0;font-weight:bold">0</span>, <span style="color:#ff0;font-weight:bold">2</span>, <span style="color:#ff0;font-weight:bold">1</span>), label) 
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">#(batch_size, vocab_size, num_steps) å°†ç±»åˆ«æ¦‚ç‡æ”¾åœ¨ç¬¬äºŒç»´</span>
</span></span><span style="display:flex;"><span>        weighted_loss = (unweighted_loss * weights).mean(dim=<span style="color:#ff0;font-weight:bold">1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> weighted_loss
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="74-è®­ç»ƒ">7.4 è®­ç»ƒ<a hidden class="anchor" aria-hidden="true" href="#74-è®­ç»ƒ">#</a></h2>
<ul>
<li>åœ¨è§£ç å™¨ä¸­ï¼Œ&rsquo;&lt;bos&gt;&lsquo;ä¸åŸå§‹çš„è¾“å‡ºåºåˆ—ï¼ˆä¸åŒ…å«&rsquo;&lt;eos&gt;&rsquo;ï¼‰è¿æ¥åœ¨ä¸€èµ·å…±åŒä½œä¸ºè¾“å…¥ã€‚</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f">#@save</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> train_seq2seq(net, data_iter, lr, num_epochs, tgt_vocab, device):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;è®­ç»ƒåºåˆ—åˆ°åºåˆ—æ¨¡å‹&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> xavier_init_weights(m):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">type</span>(m) == nn.Linear:
</span></span><span style="display:flex;"><span>            nn.init.xavier_uniform_(m.weight)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">type</span>(m) == nn.GRU:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">for</span> param in m._flat_weights_names:
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> <span style="color:#0ff;font-weight:bold">&#34;weight&#34;</span> in param:
</span></span><span style="display:flex;"><span>                    nn.init.xavier_uniform_(m._parameters[param])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    net.apply(xavier_init_weights)
</span></span><span style="display:flex;"><span>    net.to(device)
</span></span><span style="display:flex;"><span>    optimizer = torch.optim.Adam(net.parameters(), lr=lr)
</span></span><span style="display:flex;"><span>    loss = MaskedSoftmaxCELoss()
</span></span><span style="display:flex;"><span>    net.train()
</span></span><span style="display:flex;"><span>    animator = d2l.Animator(xlabel=<span style="color:#0ff;font-weight:bold">&#39;epoch&#39;</span>, ylabel=<span style="color:#0ff;font-weight:bold">&#39;loss&#39;</span>,
</span></span><span style="display:flex;"><span>                     xlim=[<span style="color:#ff0;font-weight:bold">10</span>, num_epochs])
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> epoch in <span style="color:#fff;font-weight:bold">range</span>(num_epochs):
</span></span><span style="display:flex;"><span>        timer = d2l.Timer()
</span></span><span style="display:flex;"><span>        metric = d2l.Accumulator(<span style="color:#ff0;font-weight:bold">2</span>)  <span style="color:#007f7f"># è®­ç»ƒæŸå¤±æ€»å’Œï¼Œè¯å…ƒæ•°é‡</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> batch in data_iter:
</span></span><span style="display:flex;"><span>            optimizer.zero_grad()
</span></span><span style="display:flex;"><span>            X, X_valid_len, Y, Y_valid_len = [x.to(device) <span style="color:#fff;font-weight:bold">for</span> x in batch]
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">#åœ¨ä¹‹å‰åºåˆ—é¢„å¤„ç†é‡Œload_data_nmtä¸­ï¼Œå·²å°†æ¯ä¸ªåºåˆ—æœ«å°¾æ·»åŠ äº†&lt;eos&gt;è¯å…ƒ</span>
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">#å¯¹äºè§£ç å™¨çš„è¾“å…¥åºåˆ—ï¼Œåœ¨å¼€å¤´æ’å…¥ä¸€ä¸ªbosè¯å…ƒã€‚ä¸ºä¿è¯é•¿åº¦ä¸å˜ï¼Œéœ€è¦æˆªæ‰åºåˆ—çš„æœ€åä¸€ä¸ªè¯å…ƒ(&lt;eos&gt;)</span>
</span></span><span style="display:flex;"><span>            bos = torch.tensor([tgt_vocab[<span style="color:#0ff;font-weight:bold">&#39;&lt;bos&gt;&#39;</span>]] * Y.shape[<span style="color:#ff0;font-weight:bold">0</span>],
</span></span><span style="display:flex;"><span>                          device=device).reshape(-<span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">1</span>)
</span></span><span style="display:flex;"><span>            dec_input = torch.cat([bos, Y[:, :-<span style="color:#ff0;font-weight:bold">1</span>]], <span style="color:#ff0;font-weight:bold">1</span>)  <span style="color:#007f7f"># å¼ºåˆ¶æ•™å­¦</span>
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># X_valid_lenæœ¬ç« æš‚æ—¶ç”¨ä¸åˆ°ï¼ŒY_valid_lenä¼šç”¨åˆ°</span>
</span></span><span style="display:flex;"><span>            Y_hat, _ = net(X, dec_input, X_valid_len) 
</span></span><span style="display:flex;"><span>            l = loss(Y_hat, Y, Y_valid_len)
</span></span><span style="display:flex;"><span>            l.sum().backward()      <span style="color:#007f7f"># æŸå¤±å‡½æ•°çš„æ ‡é‡è¿›è¡Œâ€œåå‘ä¼ æ’­â€</span>
</span></span><span style="display:flex;"><span>            d2l.grad_clipping(net, <span style="color:#ff0;font-weight:bold">1</span>)
</span></span><span style="display:flex;"><span>            num_tokens = Y_valid_len.sum()
</span></span><span style="display:flex;"><span>            optimizer.step()
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">with</span> torch.no_grad():
</span></span><span style="display:flex;"><span>                metric.add(l.sum(), num_tokens)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (epoch + <span style="color:#ff0;font-weight:bold">1</span>) % <span style="color:#ff0;font-weight:bold">10</span> == <span style="color:#ff0;font-weight:bold">0</span>:
</span></span><span style="display:flex;"><span>            animator.add(epoch + <span style="color:#ff0;font-weight:bold">1</span>, (metric[<span style="color:#ff0;font-weight:bold">0</span>] / metric[<span style="color:#ff0;font-weight:bold">1</span>],))
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#39;loss </span><span style="color:#0ff;font-weight:bold">{</span>metric[<span style="color:#ff0;font-weight:bold">0</span>] / metric[<span style="color:#ff0;font-weight:bold">1</span>]<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.3f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">, </span><span style="color:#0ff;font-weight:bold">{</span>metric[<span style="color:#ff0;font-weight:bold">1</span>] / timer.stop()<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.1f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold"> &#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#39;tokens/sec on </span><span style="color:#0ff;font-weight:bold">{</span><span style="color:#fff;font-weight:bold">str</span>(device)<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">&#39;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>å®ä¾‹åŒ–æ¨¡å‹ï¼Œå¹¶è®­ç»ƒ</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>embed_size, num_hiddens, num_layers, dropout = <span style="color:#ff0;font-weight:bold">32</span>, <span style="color:#ff0;font-weight:bold">32</span>, <span style="color:#ff0;font-weight:bold">2</span>, <span style="color:#ff0;font-weight:bold">0.1</span>
</span></span><span style="display:flex;"><span>batch_size, num_steps = <span style="color:#ff0;font-weight:bold">64</span>, <span style="color:#ff0;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>lr, num_epochs, device = <span style="color:#ff0;font-weight:bold">0.005</span>, <span style="color:#ff0;font-weight:bold">300</span>, d2l.try_gpu()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>train_iter, src_vocab, tgt_vocab = d2l.load_data_nmt(batch_size, num_steps)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>encoder = Seq2SeqEncoder(<span style="color:#fff;font-weight:bold">len</span>(src_vocab), embed_size, num_hiddens, num_layers,
</span></span><span style="display:flex;"><span>                        dropout)
</span></span><span style="display:flex;"><span>decoder = Seq2SeqDecoder(<span style="color:#fff;font-weight:bold">len</span>(tgt_vocab), embed_size, num_hiddens, num_layers,
</span></span><span style="display:flex;"><span>                        dropout)
</span></span><span style="display:flex;"><span>net = d2l.EncoderDecoder(encoder, decoder)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>train_seq2seq(net, train_iter, lr, num_epochs, tgt_vocab, device)
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># loss 0.019, 10100.9 tokens/sec on cuda:0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="75-é¢„æµ‹">7.5 é¢„æµ‹<a hidden class="anchor" aria-hidden="true" href="#75-é¢„æµ‹">#</a></h2>
<ul>
<li>ä¸è®­ç»ƒéƒ¨åˆ†ä¸åŒä¹‹å¤„åœ¨äºï¼Œ æ¯ä¸ªè§£ç å™¨å½“å‰æ—¶é—´æ­¥çš„è¾“å…¥éƒ½å°†æ¥è‡ªäºå‰ä¸€æ—¶é—´æ­¥çš„é¢„æµ‹è¯å…ƒã€‚è€Œåœ¨è®­ç»ƒæ—¶çš„è§£ç å™¨è¾“å…¥éƒ½æ˜¯æ¥è‡ªçœŸå®çš„è¯å…ƒã€‚
<ul>
<li>src_sentence è¡¨ç¤ºç”¨æˆ·çš„è¾“å…¥è‹±è¯­å¥å­</li>
<li>src_vocabè¡¨ç¤ºè‹±è¯­çš„ç´¢å¼•è¯è¡¨</li>
<li>tgt_vocabè¡¨ç¤ºæ³•è¯­çš„ç´¢å¼•è¯è¡¨</li>
</ul>
</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f">#@save</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> predict_seq2seq(net, src_sentence, src_vocab, tgt_vocab, num_steps,
</span></span><span style="display:flex;"><span>                    device, save_attention_weights=<span style="color:#fff;font-weight:bold">False</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;åºåˆ—åˆ°åºåˆ—æ¨¡å‹çš„é¢„æµ‹&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># åœ¨é¢„æµ‹æ—¶å°†netè®¾ç½®ä¸ºè¯„ä¼°æ¨¡å¼</span>
</span></span><span style="display:flex;"><span>    net.eval()
</span></span><span style="display:flex;"><span>    src_tokens = src_vocab[src_sentence.lower().split(<span style="color:#0ff;font-weight:bold">&#39; &#39;</span>)] + [
</span></span><span style="display:flex;"><span>        src_vocab[<span style="color:#0ff;font-weight:bold">&#39;&lt;eos&gt;&#39;</span>]]
</span></span><span style="display:flex;"><span>    enc_valid_len = torch.tensor([<span style="color:#fff;font-weight:bold">len</span>(src_tokens)], device=device)
</span></span><span style="display:flex;"><span>    src_tokens = d2l.truncate_pad(src_tokens, num_steps, src_vocab[<span style="color:#0ff;font-weight:bold">&#39;&lt;pad&gt;&#39;</span>]) <span style="color:#007f7f">#å›ºå®šé•¿åº¦</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># æ·»åŠ æ‰¹é‡è½´ï¼ˆä½œä¸ºç¬¬ä¸€ä¸ªç»´åº¦ï¼‰</span>
</span></span><span style="display:flex;"><span>    enc_X = torch.unsqueeze(
</span></span><span style="display:flex;"><span>        torch.tensor(src_tokens, dtype=torch.long, device=device), dim=<span style="color:#ff0;font-weight:bold">0</span>)
</span></span><span style="display:flex;"><span>    enc_outputs = net.encoder(enc_X, enc_valid_len)
</span></span><span style="display:flex;"><span>    dec_state = net.decoder.init_state(enc_outputs, enc_valid_len)
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># æ·»åŠ æ‰¹é‡è½´</span>
</span></span><span style="display:flex;"><span>    dec_X = torch.unsqueeze(torch.tensor(
</span></span><span style="display:flex;"><span>        [tgt_vocab[<span style="color:#0ff;font-weight:bold">&#39;&lt;bos&gt;&#39;</span>]], dtype=torch.long, device=device), dim=<span style="color:#ff0;font-weight:bold">0</span>)
</span></span><span style="display:flex;"><span>    output_seq, attention_weight_seq = [], []
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> _ in <span style="color:#fff;font-weight:bold">range</span>(num_steps):
</span></span><span style="display:flex;"><span>        Y, dec_state = net.decoder(dec_X, dec_state)
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># æˆ‘ä»¬ä½¿ç”¨å…·æœ‰é¢„æµ‹æœ€é«˜å¯èƒ½æ€§çš„è¯å…ƒï¼Œä½œä¸ºè§£ç å™¨åœ¨ä¸‹ä¸€æ—¶é—´æ­¥çš„è¾“å…¥</span>
</span></span><span style="display:flex;"><span>        dec_X = Y.argmax(dim=<span style="color:#ff0;font-weight:bold">2</span>)
</span></span><span style="display:flex;"><span>        pred = dec_X.squeeze(dim=<span style="color:#ff0;font-weight:bold">0</span>).type(torch.int32).item()
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># ä¿å­˜æ³¨æ„åŠ›æƒé‡ï¼ˆç¨åè®¨è®ºï¼‰</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> save_attention_weights:
</span></span><span style="display:flex;"><span>            attention_weight_seq.append(net.decoder.attention_weights)
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># ä¸€æ—¦åºåˆ—ç»“æŸè¯å…ƒè¢«é¢„æµ‹ï¼Œè¾“å‡ºåºåˆ—çš„ç”Ÿæˆå°±æå‰å®Œæˆäº†</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> pred == tgt_vocab[<span style="color:#0ff;font-weight:bold">&#39;&lt;eos&gt;&#39;</span>]:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>        output_seq.append(pred)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#39; &#39;</span>.join(tgt_vocab.to_tokens(output_seq)), attention_weight_seq
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://raw.githubusercontent.com/lishensuo/images2/main/img01/image-20240809171239840.png" alt="image-20240809171239840"  />
</p>
<h2 id="76-é¢„æµ‹åºåˆ—çš„è¯„ä¼°">7.6 é¢„æµ‹åºåˆ—çš„è¯„ä¼°<a hidden class="anchor" aria-hidden="true" href="#76-é¢„æµ‹åºåˆ—çš„è¯„ä¼°">#</a></h2>
<ul>
<li>å¯ä½¿ç”¨Bleuå€¼è¯„ä¼°é¢„æµ‹åºåˆ—ä¸çœŸå®åºåˆ—çš„å·®å¼‚ï¼›å€¼è¶Šå¤§ï¼Œä¸”æ¥è¿‘1è¡¨ç¤ºæ•ˆæœè¶Šå¥½
<ul>
<li>å½“é¢„æµ‹çš„åºåˆ—é•¿åº¦å°äºçœŸå®åºåˆ—é•¿åº¦æ—¶ï¼Œå‰é¢çš„expç³»æ•°è¿ç®—å°±ä¼šå°äº1ï¼Œå³å¯¹Bleuå€¼æƒ©ç½šï¼›</li>
<li>å½“nå€¼è¾ƒå¤§æ—¶çš„nå…ƒé¢„æµ‹å‡†ç¡®ç‡è¶Šé«˜æ—¶ï¼ŒPné¡¹å°±è¶Šå¤§ã€‚</li>
</ul>
</li>
</ul>
<blockquote>
<p>å…·ä½“åœ°è¯´ï¼Œç»™å®šæ ‡ç­¾åºåˆ—Aã€Bã€Cã€Dã€Eã€F å’Œé¢„æµ‹åºåˆ—Aã€Bã€Bã€Cã€Dï¼Œ æˆ‘ä»¬æœ‰p1=4/5ã€p2=3/4ã€p3=1/3å’Œp4=0ã€‚</p></blockquote>
<p><img loading="lazy" src="https://raw.githubusercontent.com/lishensuo/images2/main/img01/image-20240809172146342.png" alt="image-20240809172146342"  />
</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> bleu(pred_seq, label_seq, k):  <span style="color:#007f7f">#@save</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;è®¡ç®—BLEU&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    pred_tokens, label_tokens = pred_seq.split(<span style="color:#0ff;font-weight:bold">&#39; &#39;</span>), label_seq.split(<span style="color:#0ff;font-weight:bold">&#39; &#39;</span>)
</span></span><span style="display:flex;"><span>    len_pred, len_label = <span style="color:#fff;font-weight:bold">len</span>(pred_tokens), <span style="color:#fff;font-weight:bold">len</span>(label_tokens)
</span></span><span style="display:flex;"><span>    score = math.exp(<span style="color:#fff;font-weight:bold">min</span>(<span style="color:#ff0;font-weight:bold">0</span>, <span style="color:#ff0;font-weight:bold">1</span> - len_label / len_pred))
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> n in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">1</span>, k + <span style="color:#ff0;font-weight:bold">1</span>):
</span></span><span style="display:flex;"><span>        num_matches, label_subs = <span style="color:#ff0;font-weight:bold">0</span>, collections.defaultdict(<span style="color:#fff;font-weight:bold">int</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(len_label - n + <span style="color:#ff0;font-weight:bold">1</span>):
</span></span><span style="display:flex;"><span>            label_subs[<span style="color:#0ff;font-weight:bold">&#39; &#39;</span>.join(label_tokens[i: i + n])] += <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(len_pred - n + <span style="color:#ff0;font-weight:bold">1</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> label_subs[<span style="color:#0ff;font-weight:bold">&#39; &#39;</span>.join(pred_tokens[i: i + n])] &gt; <span style="color:#ff0;font-weight:bold">0</span>:
</span></span><span style="display:flex;"><span>                num_matches += <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>                label_subs[<span style="color:#0ff;font-weight:bold">&#39; &#39;</span>.join(pred_tokens[i: i + n])] -= <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>        score *= math.pow(num_matches / (len_pred - n + <span style="color:#ff0;font-weight:bold">1</span>), math.pow(<span style="color:#ff0;font-weight:bold">0.5</span>, n))
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> score
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ç¤ºä¾‹</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>engs = [<span style="color:#0ff;font-weight:bold">&#39;go .&#39;</span>, <span style="color:#0ff;font-weight:bold">&#34;i lost .&#34;</span>, <span style="color:#0ff;font-weight:bold">&#39;he</span><span style="color:#0ff;font-weight:bold">\&#39;</span><span style="color:#0ff;font-weight:bold">s calm .&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;i</span><span style="color:#0ff;font-weight:bold">\&#39;</span><span style="color:#0ff;font-weight:bold">m home .&#39;</span>]
</span></span><span style="display:flex;"><span>fras = [<span style="color:#0ff;font-weight:bold">&#39;va !&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;j</span><span style="color:#0ff;font-weight:bold">\&#39;</span><span style="color:#0ff;font-weight:bold">ai perdu .&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;il est calme .&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;je suis chez moi .&#39;</span>]
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">for</span> eng, fra in <span style="color:#fff;font-weight:bold">zip</span>(engs, fras):
</span></span><span style="display:flex;"><span>    translation, attention_weight_seq = predict_seq2seq(
</span></span><span style="display:flex;"><span>        net, eng, src_vocab, tgt_vocab, num_steps, device)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#39;</span><span style="color:#0ff;font-weight:bold">{</span>eng<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold"> =&gt; </span><span style="color:#0ff;font-weight:bold">{</span>translation<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">, bleu </span><span style="color:#0ff;font-weight:bold">{</span>bleu(translation, fra, k=<span style="color:#ff0;font-weight:bold">2</span>)<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.3f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># go . =&gt; va &lt;unk&gt; &lt;unk&gt; ., bleu 0.000</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># i lost . =&gt; j&#39;ai perdu ., bleu 1.000</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># he&#39;s calm . =&gt; il est bon de de essaye ., bleu 0.418</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># i&#39;m home . =&gt; je suis chez de moi &lt;unk&gt; emportÃ© ., bleu 0.578</span>
</span></span></code></pre></td></tr></table>
</div>
</div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://lishensuo.github.io/en/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">æ·±åº¦å­¦ä¹ </a></li>
      <li><a href="https://lishensuo.github.io/en/tags/d2l/">D2L</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://lishensuo.github.io/en/posts/bioinfo/711d2l-%E7%AC%AC%E5%85%AB%E7%AB%A0%E5%BE%AA%E7%8E%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/">
    <span class="title">Â« Prev Page</span>
    <br>
    <span>D2L--ç¬¬å…«ç« å¾ªç¯ç¥ç»ç½‘ç»œ</span>
  </a>
  <a class="next" href="https://lishensuo.github.io/en/posts/bioinfo/713d2l-%E7%AC%AC%E5%8D%81%E7%AB%A0%E6%B3%A8%E6%84%8F%E5%8A%9B%E6%9C%BA%E5%88%B6/">
    <span class="title">Next Page Â»</span>
    <br>
    <span>D2L--ç¬¬åç« æ³¨æ„åŠ›æœºåˆ¶ä¸Transformer</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2025 <a href="https://lishensuo.github.io/en/">Li&#39;s Bioinfo-Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
		<br/>æ‚¨æ˜¯æœ¬ç«™ç¬¬ <span id="busuanzi_value_site_uv"></span> ä½è®¿é—®è€…ï¼Œæ€»æµè§ˆé‡ä¸º <span id="busuanzi_value_site_pv"></span> æ¬¡
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'copy';

        function copyingDone() {
            copybutton.innerText = 'copied!';
            setTimeout(() => {
                copybutton.innerText = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>

<script type="text/javascript"
async
src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
tex2jax: {
inlineMath: [['$','$'], ['\\(','\\)']],
displayMath: [['$$','$$'], ['\[\[','\]\]']],
processEscapes: true,
processEnvironments: true,
skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
TeX: { equationNumbers: { autoNumber: "AMS" },
extensions: ["AMSmath.js", "AMSsymbols.js"] }
}
});

MathJax.Hub.Queue(function() {



var all = MathJax.Hub.getAllJax(), i;
for(i = 0; i < all.length; i += 1) {
all[i].SourceElement().parentNode.className += ' has-jax';
}
});
</script>

<style>
code.has-jax {
font: inherit;
font-size: 100%;
background: inherit;
border: inherit;
color: #515151;
}
</style></body>
</html>
