<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">

<link rel="icon" href="/favicon.ico" type="image/x-icon"> 
<title>D2L--ç¬¬å…«ç« å¾ªç¯ç¥ç»ç½‘ç»œ | Li&#39;s Bioinfo-Blog</title>
<meta name="keywords" content="æ·±åº¦å­¦ä¹ , D2L">
<meta name="description" content="1. åºåˆ—æ¨¡å‹
1.1 è‡ªå›å½’æ¨¡å‹
ï¼ˆ1ï¼‰è‡ªå›å½’æ¨¡å‹ï¼šå¯¹äºä¸€ä¸ªåŒ…å«Tä¸ª&rsquo;æ—¶é—´&rsquo;èŠ‚ç‚¹çš„è¾“å…¥åºåˆ—ï¼Œè‹¥é¢„æµ‹å…¶ä¸­çš„ç¬¬tä¸ªæ•°æ®ï¼Œåˆ™ä¾èµ–äºè¯¥èŠ‚ç‚¹å‰é¢çš„è§‚å¯Ÿæ•°æ®">
<meta name="author" content="Lishensuo">
<link rel="canonical" href="https://lishensuo.github.io/en/posts/bioinfo/711d2l-%E7%AC%AC%E5%85%AB%E7%AB%A0%E5%BE%AA%E7%8E%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.9e4de5e3ba61ea358168341aa7cdf70abfaafb7c697dfe8624af3ddff9a35c2f.css" integrity="sha256-nk3l47ph6jWBaDQap833Cr&#43;q&#43;3xpff6GJK893/mjXC8=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.555af97124d54bb1457985dd081b8f5616a48103aafeb30ac89fde835d65aa6c.js" integrity="sha256-VVr5cSTVS7FFeYXdCBuPVhakgQOq/rMKyJ/eg11lqmw="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://lishensuo.github.io/img/Q.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://lishensuo.github.io/img/Q.gif">
<link rel="icon" type="image/png" sizes="32x32" href="https://lishensuo.github.io/img/Q.gif">
<link rel="apple-touch-icon" href="https://lishensuo.github.io/Q.gif">
<link rel="mask-icon" href="https://lishensuo.github.io/Q.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://lishensuo.github.io/en/posts/bioinfo/711d2l-%E7%AC%AC%E5%85%AB%E7%AB%A0%E5%BE%AA%E7%8E%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="D2L--ç¬¬å…«ç« å¾ªç¯ç¥ç»ç½‘ç»œ" />
<meta property="og:description" content="1. åºåˆ—æ¨¡å‹
1.1 è‡ªå›å½’æ¨¡å‹
ï¼ˆ1ï¼‰è‡ªå›å½’æ¨¡å‹ï¼šå¯¹äºä¸€ä¸ªåŒ…å«Tä¸ª&rsquo;æ—¶é—´&rsquo;èŠ‚ç‚¹çš„è¾“å…¥åºåˆ—ï¼Œè‹¥é¢„æµ‹å…¶ä¸­çš„ç¬¬tä¸ªæ•°æ®ï¼Œåˆ™ä¾èµ–äºè¯¥èŠ‚ç‚¹å‰é¢çš„è§‚å¯Ÿæ•°æ®" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://lishensuo.github.io/en/posts/bioinfo/711d2l-%E7%AC%AC%E5%85%AB%E7%AB%A0%E5%BE%AA%E7%8E%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-08-11T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2024-08-11T00:00:00&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="D2L--ç¬¬å…«ç« å¾ªç¯ç¥ç»ç½‘ç»œ"/>
<meta name="twitter:description" content="1. åºåˆ—æ¨¡å‹
1.1 è‡ªå›å½’æ¨¡å‹
ï¼ˆ1ï¼‰è‡ªå›å½’æ¨¡å‹ï¼šå¯¹äºä¸€ä¸ªåŒ…å«Tä¸ª&rsquo;æ—¶é—´&rsquo;èŠ‚ç‚¹çš„è¾“å…¥åºåˆ—ï¼Œè‹¥é¢„æµ‹å…¶ä¸­çš„ç¬¬tä¸ªæ•°æ®ï¼Œåˆ™ä¾èµ–äºè¯¥èŠ‚ç‚¹å‰é¢çš„è§‚å¯Ÿæ•°æ®"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "åˆ†ç±»",
      "item": "https://lishensuo.github.io/en/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ“– ç”Ÿä¿¡æ•°æ®åˆ†æ--åˆ†ææµç¨‹ï¼Œå·¥å…·åŒ…ç­‰",
      "item": "https://lishensuo.github.io/en/posts/bioinfo/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "D2L--ç¬¬å…«ç« å¾ªç¯ç¥ç»ç½‘ç»œ",
      "item": "https://lishensuo.github.io/en/posts/bioinfo/711d2l-%E7%AC%AC%E5%85%AB%E7%AB%A0%E5%BE%AA%E7%8E%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "D2L--ç¬¬å…«ç« å¾ªç¯ç¥ç»ç½‘ç»œ",
  "name": "D2L--ç¬¬å…«ç« å¾ªç¯ç¥ç»ç½‘ç»œ",
  "description": "1. åºåˆ—æ¨¡å‹ 1.1 è‡ªå›å½’æ¨¡å‹ ï¼ˆ1ï¼‰è‡ªå›å½’æ¨¡å‹ï¼šå¯¹äºä¸€ä¸ªåŒ…å«Tä¸ª\u0026rsquo;æ—¶é—´\u0026rsquo;èŠ‚ç‚¹çš„è¾“å…¥åºåˆ—ï¼Œè‹¥é¢„æµ‹å…¶ä¸­çš„ç¬¬tä¸ªæ•°æ®ï¼Œåˆ™ä¾èµ–äºè¯¥èŠ‚ç‚¹å‰é¢çš„è§‚å¯Ÿæ•°æ®\n",
  "keywords": [
    "æ·±åº¦å­¦ä¹ ", "D2L"
  ],
  "articleBody": "1. åºåˆ—æ¨¡å‹ 1.1 è‡ªå›å½’æ¨¡å‹ ï¼ˆ1ï¼‰è‡ªå›å½’æ¨¡å‹ï¼šå¯¹äºä¸€ä¸ªåŒ…å«Tä¸ªâ€™æ—¶é—´â€™èŠ‚ç‚¹çš„è¾“å…¥åºåˆ—ï¼Œè‹¥é¢„æµ‹å…¶ä¸­çš„ç¬¬tä¸ªæ•°æ®ï¼Œåˆ™ä¾èµ–äºè¯¥èŠ‚ç‚¹å‰é¢çš„è§‚å¯Ÿæ•°æ®\nåŸºäºæ­¤ï¼Œå¯¹äºæ•´ä¸ªåºåˆ—çš„ä¼°è®¡å€¼ï¼Œå¯ä»¥è¡¨ç¤ºä¸ºï¼š ç„¶è€Œè¿™å¯¹äºé•¿åºåˆ—åˆ™è®¡ç®—é‡è¿‡å¤§ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¯¥èŠ‚ç‚¹å‰é¢çš„Ï„ä¸ªæ ·æœ¬å»ºæ¨¡ï¼Œæ§åˆ¶æ¨¡å‹å‚æ•°çš„æ•°é‡ã€‚ å¦‚æœåºåˆ—å¯ä»¥æŒ‰è¿™ç§æ–¹å¼è®¡ç®—ï¼Œåˆ™è®¤ä¸ºå…¶æ»¡è¶³é©¬å°”ç§‘å¤«æ¡ä»¶ã€‚ å½“Ï„=1ï¼ˆæ ¹æ®å‰ä¸€ä¸ªèŠ‚ç‚¹æ¨æµ‹åä¸€ä¸ªèŠ‚ç‚¹ï¼‰æ—¶ï¼Œåºåˆ—ä¼°è®¡å¯ä»¥å†™æˆå¦‚ä¸‹å½¢å¼ã€‚ Tipsï¼šç§°ä¸ºè‡ªå›å½’çš„åŸå› æ˜¯è¾“å…¥ä¸è¾“å‡ºé¢„æµ‹åŒä¸€ç±»å‹çš„æ•°æ®ã€‚\nï¼ˆ2ï¼‰éšå˜é‡è‡ªå›å½’æ¨¡å‹ é€šè¿‡ä¸€ä¸ªéšè—(latent):çš„å˜é‡æ¨æµ‹Xtçš„å€¼ã€‚è€Œè¯¥éšè—å˜é‡æ¥è‡ªäºä¸Šä¸€çŠ¶æ€çš„éšå˜é‡ä»¥åŠå½“å‰Xt-1èŠ‚ç‚¹çš„å€¼ã€‚ï¼ˆRNN, Recurrent Neural Network)çš„æ€æƒ³ï¼‰\n1.2 è®­ç»ƒ å¦‚ä¸‹å°†æ¼”ç¤ºå¦‚ä½•æ ¹æ®æ­£å¼¦å‡½æ•°çš„æ ·æœ¬ç‚¹ï¼Œå»ºç«‹Ï„=4çš„è‡ªå›å½’æ¨¡å‹\nç¬¬ä¸€æ­¥ï¼šæ¨¡æ‹Ÿæ­£å¼¦å‡½æ•°çš„æ•°æ®ï¼Œxè½´ä»0åˆ°1000 1 2 3 4 5 6 7 8 9 %matplotlib inline import torch from torch import nn from d2l import torch as d2l T = 1000 # æ€»å…±äº§ç”Ÿ1000ä¸ªç‚¹ time = torch.arange(1, T + 1, dtype=torch.float32) x = torch.sin(0.01 * time) + torch.normal(0, 0.2, (T,)) #æ·»åŠ ä¸€ç‚¹å™ªéŸ³ d2l.plot(time, [x], 'time', 'x', xlim=[1, 1000], figsize=(6, 3)) ç¬¬äºŒæ­¥ï¼šç”Ÿæˆç‰¹å¾ä¸æ ‡ç­¾æ•°æ®ï¼ˆå‰4ä¸ªæ ·æœ¬ä½œä¸ºè¾“å…¥ï¼Œç¬¬5ä¸ªæ ·æœ¬ä½œä¸ºé¢„æµ‹ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 tau = 4 features = torch.zeros((T - tau, tau)) #tauåˆ— for i in range(tau): #é€åˆ—å¡«å……ï¼Œæ¯æ¬¡é”™å¼€ä¸€ä¸ªå…ƒç´  features[:, i] = x[i: T - tau + i] labels = x[tau:].reshape((-1, 1)) features[:4,:], labels[:4] # (tensor([[-0.1026, -0.2982, 0.1424, 0.0798], # [-0.2982, 0.1424, 0.0798, 0.1033], # [ 0.1424, 0.0798, 0.1033, 0.0814], # [ 0.0798, 0.1033, 0.0814, -0.3063]]), # tensor([[ 0.1033], # [ 0.0814], # [-0.3063], # [ 0.1354]])) batch_size, n_train = 16, 600 # åªæœ‰å‰n_trainä¸ªæ ·æœ¬ç”¨äºè®­ç»ƒ # æ‰¹é‡æ•°æ®è¿­ä»£ train_iter = d2l.load_array((features[:n_train], labels[:n_train]), batch_size, is_train=True) ç¬¬ä¸‰æ­¥ï¼šå»ºç«‹æ¨¡å‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # åˆå§‹åŒ–ç½‘ç»œæƒé‡çš„å‡½æ•° def init_weights(m): if type(m) == nn.Linear: nn.init.xavier_uniform_(m.weight) # ä¸€ä¸ªç®€å•çš„å¤šå±‚æ„ŸçŸ¥æœº def get_net(): net = nn.Sequential(nn.Linear(4, 10), nn.ReLU(), nn.Linear(10, 1)) net.apply(init_weights) return net # å¹³æ–¹æŸå¤±ï¼Œä¸åšèšåˆæ“ä½œ loss = nn.MSELoss(reduction='none') ç¬¬å››æ­¥ï¼šè®­ç»ƒæ¨¡å‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 def train(net, train_iter, loss, epochs, lr): trainer = torch.optim.Adam(net.parameters(), lr) #ä¼˜åŒ–ç®—æ³• for epoch in range(epochs): for X, y in train_iter: trainer.zero_grad() l = loss(net(X), y) l.sum().backward() trainer.step() print(f'epoch {epoch + 1}, ' f'loss: {d2l.evaluate_loss(net, train_iter, loss):f}') net = get_net() train(net, train_iter, loss, 5, 0.01) 1.3 é¢„æµ‹ é¢„æµ‹æ–¹å¼1ï¼šç‰¹å¾æ•°æ®å…¨éƒ¨æ¥è‡ªå·²çŸ¥æ•°æ® 1 2 3 4 5 6 onestep_preds = net(features) d2l.plot([time, time[tau:]], [x.detach().numpy(), onestep_preds.detach().numpy()], 'time', 'x', legend=['data', '1-step preds'], xlim=[1, 1000], figsize=(6, 3)) # ä¸‹å›¾å·¦ é¢„æµ‹æ–¹å¼2ï¼šå‰604ä¸ªæ ·æœ¬æ¥è®­ç»ƒé›†çš„å·²çŸ¥æ•°æ®ã€‚å†åé¢é¢„æµ‹æ—¶ï¼Œæ¯æ¬¡å°†æ–°é¢„æµ‹çš„æ ·æœ¬ä½œä¸ºè¾“å…¥é¢„æµ‹ä¸‹ä¸€ä¸ªè¾“å‡ºã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 multistep_preds = torch.zeros(T) #åˆå§‹åŒ–å…¨0 multistep_preds[: n_train + tau] = x[: n_train + tau] #å‰é¢çš„è®­ç»ƒé›†æ•°æ®å·²çŸ¥ï¼Œä¸åšé¢„æµ‹ for i in range(n_train + tau, T): # å°†æ–°é¢„æµ‹çš„ç»“æœåŠ å…¥ç‰¹å¾ä¸­ï¼Œä½œä¸ºä¸‹ä¸€æ¬¡é¢„æµ‹çš„è¾“å…¥ multistep_preds[i] = net( multistep_preds[i - tau:i].reshape((1, -1))) d2l.plot([time, time[tau:], time[n_train + tau:]], [x.detach().numpy(), onestep_preds.detach().numpy(), multistep_preds[n_train + tau:].detach().numpy()], 'time', 'x', legend=['data', '1-step preds', 'multistep preds'], xlim=[1, 1000], figsize=(6, 3)) # ä¸‹å›¾å³ å¦‚ä¸Šå¯ä»¥çœ‹å‡ºï¼š åœ¨å•æ­¥é¢„æµ‹ï¼ˆè¾“å…¥å‡ä¸ºå®é™…è§‚æµ‹æ•°æ®ï¼‰æ—¶ï¼Œæ¨¡å‹æ•ˆæœä¸é”™ï¼› è€Œåœ¨é¢„æµ‹å¤šæ­¥ï¼ˆå°†æœ€è¿‘çš„é¢„æµ‹ä½œä¸ºä¸‹ä¸€æ­¥è¾“å…¥ï¼‰æ—¶ï¼Œå³æ›´è¿œçš„é¢„æµ‹æ—¶ï¼Œæ¨¡å‹æ•ˆæœä¸å°½å¦‚äººæ„ã€‚ 2 æ–‡æœ¬é¢„å¤„ç† ä¸€ç¯‡æ–‡ç« å¯ä»¥è§†ä¸ºä¸€ä¸²å•è¯çš„åºåˆ—ï¼Œéœ€è¦è¿›è¡Œå¿…è¦çš„é¢„å¤„ç†æ“ä½œæ­¥éª¤ï¼š\nï¼ˆ1ï¼‰å°†æ–‡æœ¬ä½œä¸ºå­—ç¬¦ä¸²è¿›è¡ŒåŠ è½½ï¼›\nï¼ˆ2ï¼‰å°†å­—ç¬¦ä¸²æ‹†åˆ†ä¸ºè¯å…ƒï¼ˆå•è¯æˆ–å­—ç¬¦ï¼‰ï¼›\nï¼ˆ3ï¼‰å»ºç«‹ä¸€ä¸ªè¯è¡¨ï¼Œå°†è¯å…ƒæ˜ å°„åˆ°æ•°å­—ç´¢å¼•ï¼›\nï¼ˆ4ï¼‰å°†æ–‡æœ¬è½¬æ¢ä¸ºæ•°å­—ç´¢å¼•åºåˆ—ã€‚\n2.1 è¯»å–æ•°æ®é›† ç¤ºä¾‹æ•°æ®ï¼šæ—¶å…‰æœºå™¨ï¼ˆThe Time Machineï¼‰å°è¯´ å¦‚ä¸‹æ“ä½œï¼ŒæŒ‰è¡Œè¯»å–å…¨éƒ¨å°è¯´æ–‡æœ¬ã€‚ç»“æœä¸ºlistï¼Œå…¶ä¸­æ¯ä¸ªå…ƒç´ è¡¨ç¤ºä¸€è¡Œçš„æ–‡æœ¬ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 #@save d2l.DATA_HUB['time_machine'] = (d2l.DATA_URL + 'timemachine.txt', '090b5e7e70c295757f55df93cb0a180b9691891a') def read_time_machine(): #@save \"\"\"å°†æ—¶é—´æœºå™¨æ•°æ®é›†åŠ è½½åˆ°æ–‡æœ¬è¡Œçš„åˆ—è¡¨ä¸­\"\"\" with open(d2l.download('time_machine'), 'r') as f: lines = f.readlines() return [re.sub('[^A-Za-z]+', ' ', line).strip().lower() for line in lines] lines = read_time_machine() # list print(f'# æ–‡æœ¬æ€»è¡Œæ•°: {len(lines)}') # æ–‡æœ¬æ€»è¡Œæ•°: 3221 print(lines[0]) # the time machine by h g wells print(lines[10]) # twinkled and his usually pale face was flushed and animated the 2.2 è¯å…ƒåŒ– è¯å…ƒ(token)ï¼Œé€šå¸¸æŒ‡ä¸€ä¸ªå•è¯æˆ–å­—ç¬¦ å¦‚ä¸‹æ“ä½œå°†æ¯ä¸€è¡Œä»¥è¯å…ƒä¸ºå•ä½ï¼Œæ‹†åˆ†ä¸ºä¸€ä¸ªlistï¼Œç»“æœè¿”å›ä¸€ä¸ªlist of list 1 2 3 4 5 6 7 8 9 10 11 12 def tokenize(lines, token='word'): #@save \"\"\"å°†æ–‡æœ¬è¡Œæ‹†åˆ†ä¸ºå•è¯æˆ–å­—ç¬¦è¯å…ƒ\"\"\" if token == 'word': return [line.split() for line in lines] elif token == 'char': return [list(line) for line in lines] else: print('é”™è¯¯ï¼šæœªçŸ¥è¯å…ƒç±»å‹ï¼š' + token) tokens = tokenize(lines) #list of list, å†…éƒ¨listçš„å…ƒç´ å³ä¸ºè¯å…ƒ print(tokens[0]) # ['the', 'time', 'machine', 'by', 'h', 'g', 'wells'] 2.3 è¯è¡¨ è¯å…ƒçš„ç±»å‹æ˜¯å­—ç¬¦ä¸²ï¼Œè€Œæ¨¡å‹éœ€è¦çš„æ˜¯æ•°å­—ï¼› è¯è¡¨(Vocabulary)ï¼šç±»ä¼¼äºPythonä¸­çš„å­—å…¸ï¼Œå°†è¾“å…¥çš„è¯å…ƒè½¬æ¢ä¸ºæ•°å­—ç´¢å¼•ï¼› è¯­æ–™åº“(Corpus)ï¼šå¯¹æ‰€æœ‰æ–‡æœ¬ä¸­å”¯ä¸€è¯å…ƒçš„ç»Ÿè®¡ç»“æœï¼ŒæŒ‰é¢‘ç‡é™åºæ’ã€‚ å¯¹äºä½é¢‘ç‡å‡ºç°çš„è¯å…ƒï¼Œå¯è®¾ç½®ä¸€å®šæ ‡å‡†çš„é˜ˆå€¼è¿‡æ»¤ï¼› å¯¹äºè¯­æ–™åº“ä¸­ä¸å­˜åœ¨ï¼Œæˆ–è€…å·²è¿‡æ»¤çš„è¯å…ƒï¼Œå°†è¢«æ˜ å°„åˆ°æœªçŸ¥è¯å…ƒâ€™â€™, å…¶æ•°å­—ç´¢å¼•è®°ä¸º0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 class Vocab: #@save \"\"\"æ–‡æœ¬è¯è¡¨\"\"\" def __init__(self, tokens=None, min_freq=0, reserved_tokens=None): if tokens is None: tokens = [] if reserved_tokens is None: reserved_tokens = [] # æŒ‰å‡ºç°é¢‘ç‡æ’åº counter = count_corpus(tokens) # counter.items() e.g. [('word1', 5), ('word2', 3), ('word3', 8)] self._token_freqs = sorted(counter.items(), key=lambda x: x[1], reverse=True) # æœªçŸ¥è¯å…ƒçš„ç´¢å¼•ä¸º0 self.idx_to_token = [''] + reserved_tokens self.token_to_idx = {token: idx for idx, token in enumerate(self.idx_to_token)} for token, freq in self._token_freqs: if freq \u003c min_freq: break if token not in self.token_to_idx: self.idx_to_token.append(token) self.token_to_idx[token] = len(self.idx_to_token) - 1 def __len__(self): return len(self.idx_to_token) # å¦‚æœä¼ å…¥å•ä¸ªè¯å…ƒï¼Œåˆ™è¿”å›å…¶ç´¢å¼•ï¼›å¦‚æœä¼ å…¥è¯å…ƒåˆ—è¡¨ï¼Œåˆ™è¿”å›å¯¹åº”çš„ç´¢å¼•åˆ—è¡¨ã€‚ def __getitem__(self, tokens): if not isinstance(tokens, (list, tuple)): return self.token_to_idx.get(tokens, self.unk) return [self.__getitem__(token) for token in tokens] # æ ¹æ®è¾“å…¥çš„ç´¢å¼•æˆ–ç´¢å¼•åˆ—è¡¨è¿”å›å¯¹åº”çš„è¯å…ƒã€‚ def to_tokens(self, indices): if not isinstance(indices, (list, tuple)): return self.idx_to_token[indices] return [self.idx_to_token[index] for index in indices] @property def unk(self): # æœªçŸ¥è¯å…ƒçš„ç´¢å¼•ä¸º0 return 0 @property def token_freqs(self): return self._token_freqs def count_corpus(tokens): #@save \"\"\"ç»Ÿè®¡è¯å…ƒçš„é¢‘ç‡\"\"\" # è¿™é‡Œçš„tokensæ˜¯1Dåˆ—è¡¨æˆ–2Dåˆ—è¡¨ if len(tokens) == 0 or isinstance(tokens[0], list): # å°†è¯å…ƒlist of liståˆ—è¡¨å±•å¹³æˆä¸€ä¸ªåˆ—è¡¨ tokens = [token for line in tokens for token in line] return collections.Counter(tokens) vocab = Vocab(tokens) list(vocab.token_to_idx.items())[:5] # [('', 0), ('the', 1), ('i', 2), ('and', 3), ('of', 4)] vocab.token_freqs[:5] # [('the', 2261), ('i', 1267), ('and', 1245), ('of', 1155), ('a', 816)] 2.4 æ•´åˆæ‰€æœ‰åŠŸèƒ½ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 def load_corpus_time_machine(max_tokens=-1): #@save \"\"\"è¿”å›æ—¶å…‰æœºå™¨æ•°æ®é›†çš„è¯å…ƒç´¢å¼•åˆ—è¡¨å’Œè¯è¡¨\"\"\" lines = read_time_machine() tokens = tokenize(lines, 'char') #è¯å…ƒä¸ºå­—ç¬¦ vocab = Vocab(tokens) # å› ä¸ºæ—¶å…‰æœºå™¨æ•°æ®é›†ä¸­çš„æ¯ä¸ªæ–‡æœ¬è¡Œä¸ä¸€å®šæ˜¯ä¸€ä¸ªå¥å­æˆ–ä¸€ä¸ªæ®µè½ï¼Œ # æ‰€ä»¥å°†æ‰€æœ‰æ–‡æœ¬è¡Œå±•å¹³åˆ°ä¸€ä¸ªåˆ—è¡¨ä¸­ corpus = [vocab[token] for line in tokens for token in line] if max_tokens \u003e 0: corpus = corpus[:max_tokens] return corpus, vocab # corpus å…¨éƒ¨æ–‡æœ¬çš„è¯å…ƒ corpus, vocab = load_corpus_time_machine() len(corpus), len(vocab) # (170580, 28) corpus[:5] # [3, 9, 2, 1, 3] vocab.token_freqs[:5] # [(' ', 29927), ('e', 17838), ('t', 13515), ('a', 11704), ('i', 10138)] 3. è¯­è¨€æ¨¡å‹å’Œæ•°æ®é›† 3.1 è‡ªç„¶è¯­è¨€ç»Ÿè®¡ å•ä¸ªè¯å…ƒç»Ÿè®¡ï¼ˆä¸€å…ƒè¯­æ³•ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 import random import torch from d2l import torch as d2l tokens = d2l.tokenize(d2l.read_time_machine()) # å°†list of listè½¬ä¸ºlist corpus = [token for line in tokens for token in line] vocab = d2l.Vocab(corpus) vocab.token_freqs[:10] # [('the', 2261), ('i', 1267), ('and', 1245)] ä¸¤ä¸ªè¿ç»­è¯å…ƒç»Ÿè®¡ï¼ˆäºŒå…ƒè¯­æ³•ï¼‰ 1 2 3 4 5 6 bigram_tokens = [pair for pair in zip(corpus[:-1], corpus[1:])] bigram_tokens[:3] # [('the', 'time'), ('time', 'machine'), ('machine', 'by')] bigram_vocab = d2l.Vocab(bigram_tokens) bigram_vocab.token_freqs[:3] # [(('of', 'the'), 309), (('in', 'the'), 169), (('i', 'had'), 130)] ä¸‰ä¸ªè¿ç»­è¯å…ƒç»Ÿè®¡ï¼ˆä¸‰å…ƒè¯­æ³•ï¼‰ 1 2 3 4 5 6 7 trigram_tokens = [triple for triple in zip( corpus[:-2], corpus[1:-1], corpus[2:])] trigram_vocab = d2l.Vocab(trigram_tokens) trigram_vocab.token_freqs[:3] # [(('the', 'time', 'traveller'), 59), # (('the', 'time', 'machine'), 30), # (('the', 'medical', 'man'), 24)] æ ¹æ®ä¸‹å›¾çš„é¢‘ç‡åˆ†å¸ƒå¯è§†åŒ–ï¼Œå¯ä»¥çœ‹å‡ºï¼š ä¸‰è€…å‡ä¸åŒç¨‹åº¦ä¸Šéµå¾ªé½æ™®å¤«å®šå¾‹ï¼Œå‘ˆç°è¾ƒä¸ºæ˜¾è‘—çš„è¡°å‡ å°‘æ•°é«˜é¢‘è¯å äº†å…¨éƒ¨è¯­æ–™åº“çš„å¤§å¤šæ•°ï¼Œå¤§éƒ¨åˆ†å¯èƒ½å½¢å¼çš„nå…ƒç»„å¾ˆå°‘å‡ºç° 1 2 3 4 5 6 freqs = [freq for token, freq in vocab.token_freqs] bigram_freqs = [freq for token, freq in bigram_vocab.token_freqs] trigram_freqs = [freq for token, freq in trigram_vocab.token_freqs] d2l.plot([freqs, bigram_freqs, trigram_freqs], xlabel='token: x', ylabel='frequency: n(x)', xscale='log', yscale='log', legend=['unigram', 'bigram', 'trigram']) 3.2 è¯»å–é•¿åºåˆ—æ•°æ® å¦‚å‰æ‰€è¿°ï¼Œåœ¨å¤„ç†é•¿åºåˆ—æ—¶ï¼Œé€šå¸¸ä»…è€ƒè™‘å¾…é¢„æµ‹æ•°æ®å‰çš„è‹¥å¹²èŠ‚ç‚¹çš„è§‚æµ‹æ•°æ®ã€‚\nbatch_sizeï¼šæ¯ä¸ªå°æ‰¹é‡åŒæ—¶å¤„ç†çš„å­åºåˆ—æ ·æœ¬æ•°ç›®ï¼›\nnum_stepsï¼šæ¯ä¸ªå­åºåˆ—ä¸­é¢„å®šä¹‰çš„æ—¶é—´æ­¥æ•°ã€‚\nåœ¨å°æ‰¹é‡é‡‡æ ·æ—¶ï¼Œç”±å¦‚ä¸‹ä¸¤ç§æ–¹å¼ï¼ˆå­åºåˆ—çš„æ—¶é—´æ­¥æ•°éƒ½ä¸é‡å ï¼‰\néšæœºåç§»é‡ï¼šä»ä¸€ä¸ªéšæœºèµ·å§‹ç‚¹å¼€å§‹æˆªå–åºåˆ—ï¼Œå¢åŠ æ¯ä¸ªepochè¿­ä»£çš„éšæœºæ€§\nï¼ˆ1ï¼‰éšæœºæŠ½æ ·\næ¯ä¸ªæ‰¹é‡æ ·æœ¬ä¹‹é—´çš„èµ·å§‹æ—¶é—´æ­¥æ•°æ— é¡ºåºå…³ç³» e.g. ç¬¬ä¸€ä¸ªå°æ‰¹é‡çš„ç¬¬ä¸€ä¸ªåºåˆ—ä¸ç¬¬äºŒä¸ªå°æ‰¹é‡çš„ç¬¬ä¸€ä¸ªåºåˆ—æ— ç›¸é‚»çš„é¡ºåºå…³ç³» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 def seq_data_iter_random(corpus, batch_size, num_steps): #@save \"\"\"ä½¿ç”¨éšæœºæŠ½æ ·ç”Ÿæˆä¸€ä¸ªå°æ‰¹é‡å­åºåˆ—\"\"\" # ä»éšæœºåç§»é‡å¼€å§‹å¯¹åºåˆ—è¿›è¡Œåˆ†åŒº(éšæœºä¸¢å¼ƒå¼€å¤´çš„å‡ ä¸ªä½ç½®æ•°æ®)ï¼ŒéšæœºèŒƒå›´åŒ…æ‹¬num_steps-1 corpus = corpus[random.randint(0, num_steps - 1):] # è®¡ç®—å¯ä»¥ç”Ÿæˆå¤šå°‘ä¸ªä¸é‡å çš„å­åºåˆ—(å‡å»1ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬éœ€è¦è€ƒè™‘æ ‡ç­¾) num_subseqs = (len(corpus) - 1) // num_steps # æ¯ä¸ªå­åºåˆ—çš„èµ·å§‹ç´¢å¼• initial_indices = list(range(0, num_subseqs * num_steps, num_steps)) # æ‰“ä¹±åˆå§‹ç´¢å¼• random.shuffle(initial_indices) def data(pos): # è¿”å›ä»posä½ç½®å¼€å§‹çš„é•¿åº¦ä¸ºnum_stepsçš„åºåˆ— return corpus[pos: pos + num_steps] #æ ¹æ®æ¯ä¸ªå°æ‰¹é‡åŒ…å«çš„å­åºåˆ—æ•°ï¼Œè®¡ç®—æœ‰å¤šå°‘ä¸ªæ‰¹é‡ num_batches = num_subseqs // batch_size for i in range(0, batch_size * num_batches, batch_size): # åœ¨è¿™é‡Œï¼Œæ¯ä¸ªæ‰¹é‡å†…æ‰€æœ‰å­åºåˆ—çš„èµ·å§‹ç´¢å¼• initial_indices_per_batch = initial_indices[i: i + batch_size] X = [data(j) for j in initial_indices_per_batch] Y = [data(j + 1) for j in initial_indices_per_batch] yield torch.tensor(X), torch.tensor(Y) ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 random_iter = seq_data_iter_random(list(range(35)), batch_size=2, num_steps=5) next(iter(random_iter)) # (tensor([[24, 25, 26, 27, 28], # [14, 15, 16, 17, 18]]), # tensor([[25, 26, 27, 28, 29], # [15, 16, 17, 18, 19]])) next(iter(random_iter)) # (tensor([[ 9, 10, 11, 12, 13], # [ 4, 5, 6, 7, 8]]), # tensor([[10, 11, 12, 13, 14], # [ 5, 6, 7, 8, 9]])) ï¼ˆ2ï¼‰é¡ºåºåˆ†åŒº\nä¿è¯ä¸¤ä¸ªç›¸é‚»çš„å°æ‰¹é‡ä¸­çš„å­åºåˆ—åœ¨åŸå§‹åºåˆ—ä¸Šä¹Ÿæ˜¯ç›¸é‚»çš„ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 def seq_data_iter_sequential(corpus, batch_size, num_steps): #@save \"\"\"ä½¿ç”¨é¡ºåºåˆ†åŒºç”Ÿæˆä¸€ä¸ªå°æ‰¹é‡å­åºåˆ—\"\"\" # ä»éšæœºåç§»é‡å¼€å§‹åˆ’åˆ†åºåˆ— offset = random.randint(0, num_steps) # ç¡®ä¿å¯ä»¥è¢«æ•´é™¤çš„tokensè¯å…ƒæ•°é‡ num_tokens = ((len(corpus) - offset - 1) // batch_size) * batch_size # æ‰€æœ‰ä½œä¸ºç‰¹å¾çš„è¾“å…¥åºåˆ— Xs = torch.tensor(corpus[offset: offset + num_tokens]) # æ‰€æœ‰çš„æ ‡ç­¾å€¼ Ys = torch.tensor(corpus[offset + 1: offset + 1 + num_tokens]) # è¡Œæ•°è¡¨ç¤ºæ¯ä¸ªæ‰¹é‡åŒ…å«çš„å­åºåˆ—æ•° Xs, Ys = Xs.reshape(batch_size, -1), Ys.reshape(batch_size, -1) num_batches = Xs.shape[1] // num_steps for i in range(0, num_steps * num_batches, num_steps): X = Xs[:, i: i + num_steps] Y = Ys[:, i: i + num_steps] yield X, Y ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 iter_seq = seq_data_iter_sequential(list(range(35)), batch_size=2, num_steps=5) next(iter(iter_seq)) # (tensor([[ 2, 3, 4, 5, 6], # [18, 19, 20, 21, 22]]), # tensor([[ 3, 4, 5, 6, 7], # [19, 20, 21, 22, 23]])) next(iter(iter_seq)) # (tensor([[ 7, 8, 9, 10, 11], # [23, 24, 25, 26, 27]]), # tensor([[ 8, 9, 10, 11, 12], # [24, 25, 26, 27, 28]])) Tipsï¼šæ— è®ºä¸Šè¿°å“ªä¸€ç§æ–¹å¼ï¼Œç”Ÿæˆçš„åºåˆ—æ ·æœ¬æ•°æ®éƒ½æ˜¯ä¸é‡å çš„ã€‚\næ•´åˆä¸Šè¿°è¿­ä»£æ–¹æ³•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 # å®šä¹‰ä¸€ä¸ªç±»ï¼Œç”Ÿæˆæ•°æ®è¿­ä»£å™¨ class SeqDataLoader: #@save \"\"\"åŠ è½½åºåˆ—æ•°æ®çš„è¿­ä»£å™¨\"\"\" def __init__(self, batch_size, num_steps, use_random_iter, max_tokens): if use_random_iter: self.data_iter_fn = d2l.seq_data_iter_random else: self.data_iter_fn = d2l.seq_data_iter_sequential # è¿”å›æ‰€æœ‰æ–‡æ¡£çš„è¯å…ƒç´¢å¼•åˆ—è¡¨ï¼Œä»¥åŠè¯è¡¨vocab self.corpus, self.vocab = d2l.load_corpus_time_machine(max_tokens) self.batch_size, self.num_steps = batch_size, num_steps def __iter__(self): return self.data_iter_fn(self.corpus, self.batch_size, self.num_steps) # ç»¼åˆè¯è¡¨ä¸æ•°æ®è¿­ä»£å™¨ def load_data_time_machine(batch_size, num_steps, #@save use_random_iter=False, max_tokens=10000): \"\"\"è¿”å›æ—¶å…‰æœºå™¨æ•°æ®é›†çš„è¿­ä»£å™¨å’Œè¯è¡¨\"\"\" data_iter = SeqDataLoader( batch_size, num_steps, use_random_iter, max_tokens) return data_iter, data_iter.vocab 4. å¾ªç¯ç¥ç»ç½‘ç»œ å¾ªç¯ç¥ç»ç½‘ç»œæ˜¯å…·æœ‰éšçŠ¶æ€çš„ç¥ç»ç½‘ç»œï¼› éšçŠ¶æ€ä¸éšè—å±‚çš„æ¦‚å¿µæˆªç„¶ä¸åŒ éšè—å±‚æ˜¯æŒ‡åœ¨ä»è¾“å…¥åˆ°è¾“å‡ºçš„è·¯å¾„ä¸Šï¼Œéšè—çš„å±‚ï¼› éšçŠ¶æ€å¯ä»¥ç†è§£ä¸ºRNNä¸­çš„è®°å¿†å•å…ƒï¼Œå®ƒä¿å­˜äº†åºåˆ—ä¸­å…ˆå‰æ—¶é—´æ­¥çš„ä¿¡æ¯ï¼Œå¹¶ä¼ é€’ç»™åç»­çš„æ—¶é—´æ­¥ã€‚ 4.1 æ— éšçŠ¶æ€çš„ç¥ç»ç½‘ç»œ ä»¥ç®€å•çš„å•éšè—å±‚MLPä¸ºä¾‹ï¼š\nè¾“å…¥Xï¼Œéšè—å±‚è¾“å‡ºHï¼Œéšè—å±‚æƒé‡å‚æ•°Wxhï¼Œåç½®å‚æ•°b è¾“å‡ºå±‚Oï¼Œæƒé‡å‚æ•°Whqï¼Œåç½®å‚æ•°b 4.2 æœ‰éšçŠ¶æ€çš„ç¥ç»ç½‘ç»œ å¯¹äºä¸€ä¸ªç‰¹å®šæ—¶é—´æ­¥é•¿çš„åºåˆ—ï¼š\nXtæ­¥çš„è¾“å‡º(Otï¼Œè¡¨ç¤ºå¯¹äºXt+1çš„é¢„æµ‹)ï¼Œå–å†³äºå½“å‰æ—¶é—´åºåˆ—çš„éšçŠ¶æ€Htï¼› è€Œå½“å‰çš„éšçŠ¶æ€Htç”±å½“å‰æ—¶é—´æ­¥çš„è¾“å…¥Xtä¸å‰ä¸€ä¸ªæ—¶é—´æ­¥çš„éšçŠ¶æ€Ht-1å…±åŒè®¡ç®—å¾—å‡ºã€‚ å¯¹äºè¾“å…¥çš„å°æ‰¹é‡æ•°æ®ï¼Œç”±nä¸ªé•¿åº¦ä¸ºTçš„åºåˆ—æ ·æœ¬ç»„æˆã€‚è‹¥æ ·æœ¬ç‰¹å¾é•¿åº¦ä¸ºdæ—¶ï¼Œåˆ™æ¯æ¬¡è®­ç»ƒè¾“å…¥æ•°æ®ä¸º Xtï¼šnÃ—d åŸºäºXtçš„è¾“å…¥ï¼Œå‚ä¸Htè®¡ç®—çš„æƒé‡å‚æ•°ä¸ºWxhï¼›åŸºäºHt-1éšçŠ¶æ€ï¼Œå‚ä¸Htè®¡ç®—çš„æƒé‡å‚æ•°ä¸ºWhhï¼Œæ­¤å¤–è¿˜æœ‰åç½®ï¼› ä»HtéšçŠ¶æ€ï¼Œæœ€ç»ˆè®¡ç®—Otçš„æƒé‡å‚æ•°ä¸ºWhqï¼Œä»¥åŠåç½®ã€‚ ï¼ˆ1ï¼‰å¦‚ä¸Šå¯ä»¥çœ‹å‡ºï¼Œæœ‰éšçŠ¶æ€çš„ç¥ç»ç½‘ç»œä»å…¬å¼ä¸Šæ¥çœ‹ï¼Œä¸å•éšè—å±‚çš„ç¥ç»ç½‘ç»œéå¸¸ç±»ä¼¼ã€‚åªæ˜¯å¤šäº†ä¸€é¡¹Wxhå‚æ•°çš„è®¡ç®—è¿‡ç¨‹ã€‚\nï¼ˆ2ï¼‰åœ¨åŒä¸€æ‰¹é‡çš„ä¸åŒæ—¶é—´èŠ‚ç‚¹è¿­ä»£æ—¶ï¼Œä»ç„¶æ˜¯ä¸Šè¿°è¿™äº›æ¨¡å‹å‚æ•°ã€‚å³æ¨¡å‹å‚æ•°çš„å¼€é”€ä¸ä¼šéšç€æ—¶é—´æ­¥çš„å¢åŠ è€Œå¢åŠ ã€‚\nå¦‚ä¸‹ï¼Œæ¼”ç¤ºåŒæ—¶å¯¹ç‰¹å®šä¸€ä¸ªæ‰¹é‡å†…å¤šä¸ªå­åºåˆ—çš„ç¬¬iä¸ªè¯å…ƒçš„éšçŠ¶æ€è®¡ç®—ï¼š è¾“å…¥çš„æ‰¹é‡åŒ…å«3æ¡å­åºåˆ—ï¼Œæ¯æ¡å­åºåˆ—ä¸­å•ä¸ªè¯å…ƒçš„ç‰¹å¾é•¿åº¦ä¸º1ï¼› éšçŠ¶æ€çš„ç¥ç»å…ƒä¸ªæ•°è®¾ç½®ä¸º4ã€‚ 1 2 3 4 5 6 7 import torch from d2l import torch as d2l X, W_xh = torch.normal(0, 1, (3, 1)), torch.normal(0, 1, (1, 4)) H, W_hh = torch.normal(0, 1, (3, 4)), torch.normal(0, 1, (4, 4)) torch.matmul(X, W_xh) + torch.matmul(H, W_hh) 4.3 åŸºäºRNNçš„å­—ç¬¦çº§è¯­è¨€æ¨¡å‹ åœ¨å­—ç¬¦çº§è¯­è¨€æ¨¡å‹ä¸­ï¼Œæ–‡æœ¬è¯å…ƒä¸ºå­—ç¬¦è€Œä¸æ˜¯å•è¯ï¼› å¦‚ä¸‹å¯ä»¥ç†è§£ä¸ºå°æ‰¹é‡å¤§å°ä¸º1ï¼Œæ–‡æœ¬åºåˆ—ä¸ºâ€™machine' 4.4 å›°æƒ‘åº¦ è¯­è¨€æ¨¡å‹å¤§éƒ¨åˆ†æƒ…å†µä¸‹å¯ä»¥ç†è§£ä¸ºåˆ†ç±»é—®é¢˜ï¼Œå¯ä»¥åˆ©ç”¨äº¤å‰ç†µè®¡ç®—æ¨¡å‹è¾“å…¥ä¸æ ‡ç­¾ä¹‹é—´çš„å·®å¼‚ï¼› æ¨¡å‹æ€§èƒ½(æŸå¤±)å¯æ ¹æ®ä¸€ä¸ªåºåˆ—ä¸­æ‰€æœ‰è¯å…ƒ(n)çš„å¹³å‡äº¤å‰ç†µæŸå¤±æ¥è¡¡é‡ï¼› å®é™…å»ºæ¨¡æ—¶ï¼Œè‡ªç„¶è¯­è¨€å¤„ç†çš„ç§‘å­¦å®¶æ›´å–œæ¬¢ä½¿ç”¨å›°æƒ‘åº¦(Perplexity)æŒ‡æ ‡ã€‚æœ¬è´¨ä¸Šåªæ˜¯å¯¹ä¸Šè¿°è¿›è¡ŒexpæŒ‡æ•°è¿ç®—ã€‚ è¯¥æŒ‡æ ‡å¯ä»¥ç†è§£ä¸ºå¯¹ä¸‹ä¸€ä¸ªè¯å…ƒçš„å®é™…é€‰æ‹©æ•°çš„è°ƒå’Œå¹³å‡æ•°ã€‚ å›°æƒ‘åº¦è¶Šä½ï¼Œè¯´æ˜æ¨¡å‹çš„é¢„æµ‹æ•ˆæœè¶Šå¥½ã€‚æœ€å¥½çš„æƒ…å†µä¸º1ï¼Œå³å®Œç¾åœ°ä¼°è®¡äº†æ ‡ç­¾è¯å…ƒï¼› å¦‚æœå›°æƒ‘åº¦ä¸º kkï¼Œé‚£ä¹ˆå¯ä»¥ç†è§£ä¸ºæ¨¡å‹é¢„æµ‹ä¸‹ä¸€ä¸ªè¯æ—¶çš„å€™é€‰è¯æ•°é‡å¤§è‡´ä¸º kã€‚ 5. RNNçš„ä»é›¶å®ç° ä»é›¶å¼€å§‹åŸºäºRNNå®ç°å­—ç¬¦çº§è¯­è¨€æ¨¡å‹\nè¯»å–æ•°æ®é›† batch_sizeè¡¨ç¤ºæ¯ä¸ªæ‰¹é‡åŒæ—¶è¯»å–/å¤„ç†å¤šå°‘æ¡å­åºåˆ— num_stepsè¡¨ç¤ºæ¯æ¡å­åºåˆ—çš„é•¿åº¦ 1 2 3 4 5 6 7 8 9 %matplotlib inline import math import torch from torch import nn from torch.nn import functional as F from d2l import torch as d2l batch_size, num_steps = 32, 35 train_iter, vocab = d2l.load_data_time_machine(batch_size, num_steps) 5.1 ç‹¬çƒ­ç¼–ç  æ¯ä¸ªè¯å…ƒç»è½¬æ¢åè¡¨ç¤ºä¸ºä¸€ä¸ªæ•°å­—ç´¢å¼•ï¼Œç„¶åç»ç‹¬çƒ­ç¼–ç è¡¨ç¤ºä¸ºç‰¹å¾å‘é‡ï¼› è‹¥è¯è¡¨çš„å”¯ä¸€è¯å…ƒæœ‰Nä¸ª(len(vocab))ï¼Œåˆ™è¯å…ƒç´¢å¼•èŒƒå›´æ˜¯ 0~N-1ï¼Œå…¶ç‰¹å¾å‘é‡é•¿åº¦ä¸ºN 1 2 F.one_hot(torch.tensor([0, 2]), len(vocab)).shape # torch.Size([2, 28]) ç‰¹å¾ç¼–ç å‰ï¼Œå°æ‰¹é‡è¾“å…¥å½¢çŠ¶ä¸ºäºŒç»´å¼ é‡ï¼ˆæ‰¹é‡å¤§å°ï¼Œæ—¶é—´æ­¥æ•°/åºåˆ—é•¿åº¦ï¼‰ ç¼–ç ååˆ™ä¸º3ç»´å¼ é‡ï¼Œéœ€è¦å†è°ƒæ•´ä¸‹ç»´åº¦çš„é¡ºåºï¼Œæ–¹ä¾¿åç»­æ“ä½œã€‚ï¼ˆæ—¶é—´æ­¥æ•°/åºåˆ—é•¿åº¦ï¼Œæ‰¹é‡å¤§å°ï¼Œè¯è¡¨å¤§å°/ç‰¹å¾é•¿åº¦ï¼‰ 1 2 3 4 5 6 # æ‰¹é‡å¤§å°ä¸º2ï¼Œåºåˆ—é•¿åº¦ä¸º5 X = torch.arange(10).reshape((2, 5)) #X.Tè½¬ç½®æ“ä½œï¼Œå°†åºåˆ—é•¿åº¦ç»´æ•°æ”¾åœ¨å‰é¢ä¹‹åï¼Œå†è¿›è¡Œç‹¬çƒ­ç¼–ç  F.one_hot(X.T, 28).shape # torch.Size([5, 2, 28]) 5.2 åˆå§‹åŒ–æ¨¡å‹å‚æ•° RNNæ¨¡å‹å‚æ•°å¯å‚è€ƒ4.2éƒ¨åˆ†ä»‹ç»ï¼Œä¸»è¦åˆ†ä¸ºéšçŠ¶æ€å‚æ•°ä¸è¾“å‡ºå±‚å‚æ•° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 def get_params(vocab_size, num_hiddens, device): # è¾“å…¥ä¸è¾“å‡ºçš„è¯å…ƒçš„ç‰¹å¾å‘é‡é•¿åº¦ç›¸åŒ num_inputs = num_outputs = vocab_size def normal(shape): return torch.randn(size=shape, device=device) * 0.01 # éšè—å±‚å‚æ•° W_xh = normal((num_inputs, num_hiddens)) W_hh = normal((num_hiddens, num_hiddens)) b_h = torch.zeros(num_hiddens, device=device) # è¾“å‡ºå±‚å‚æ•°ï¼Œnum_outputsç­‰äºè¯å…ƒç±»åˆ«æ•° W_hq = normal((num_hiddens, num_outputs)) b_q = torch.zeros(num_outputs, device=device) # é™„åŠ æ¢¯åº¦ params = [W_xh, W_hh, b_h, W_hq, b_q] for param in params: param.requires_grad_(True) return params 5.3 RNNæ¨¡å‹ åˆå§‹åŒ–éšçŠ¶æ€ï¼Œå½¢çŠ¶ä¸ºï¼ˆæ‰¹é‡å¤§å°ï¼Œéšè—å•å…ƒæ•°ï¼‰ 1 2 3 def init_rnn_state(batch_size, num_hiddens, device): return (torch.zeros((batch_size, num_hiddens), device=device), ) # è¿™é‡Œè¿”å›å…ƒç»„ï¼Œå› ä¸ºåé¢ç« èŠ‚çš„éšçŠ¶æ€ä¼šæœ‰å¤šä¸ªå˜é‡ï¼ˆLSTMï¼‰ å®šä¹‰å‰å‘ä¼ æ’­å‡½æ•°ï¼Œè¿”å›ä¸€è½®batchçš„é¢„æµ‹ç»“æœï¼ˆæ‰¹é‡å¤§å°Ã—åºåˆ—é•¿åº¦ï¼Œè¯è¡¨å¤§å°ï¼‰ï¼Œä»¥åŠæ›´æ–°çš„éšçŠ¶æ€ è¾“å…¥inputsä¸ºä¸Šè¿°5.1æ‰€ä»‹ç»çš„ä¸‰ç»´å¼ é‡ 1 2 3 4 5 6 7 8 9 10 11 12 13 def rnn(inputs, state, params): # inputsçš„å½¢çŠ¶ï¼š(æ—¶é—´æ­¥æ•°é‡ï¼Œæ‰¹é‡å¤§å°ï¼Œè¯è¡¨å¤§å°) W_xh, W_hh, b_h, W_hq, b_q = params H, = state outputs = [] # é€æ—¶é—´æ­¥è¿­ä»£ï¼šXçš„å½¢çŠ¶ä¸º(æ‰¹é‡å¤§å°ï¼Œè¯è¡¨å¤§å°) for X in inputs: H = torch.tanh(torch.mm(X, W_xh) + torch.mm(H, W_hh) + b_h) Y = torch.mm(H, W_hq) + b_q # Yå½¢çŠ¶ï¼š(æ‰¹é‡å¤§å°ï¼Œè¯è¡¨å¤§å°) outputs.append(Y) return torch.cat(outputs, dim=0), (H,) #çºµå‘å åŠ ï¼Œå¢åŠ è¡Œæ•°ï¼Œåˆ—æ•°ä¸å˜ï¼Œç»´åº¦ä¸å˜ å®šä¹‰æ¨¡å‹çš„ç±» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 class RNNModelScratch: #@save \"\"\"ä»é›¶å¼€å§‹å®ç°çš„å¾ªç¯ç¥ç»ç½‘ç»œæ¨¡å‹\"\"\" def __init__(self, vocab_size, num_hiddens, device, get_params, init_state, forward_fn): self.vocab_size, self.num_hiddens = vocab_size, num_hiddens self.params = get_params(vocab_size, num_hiddens, device) self.init_state, self.forward_fn = init_state, forward_fn def __call__(self, X, state): X = F.one_hot(X.T, self.vocab_size).type(torch.float32) return self.forward_fn(X, state, self.params) def begin_state(self, batch_size, device): return self.init_state(batch_size, self.num_hiddens, device) ç¤ºä¾‹è¾“å‡º 1 2 3 4 5 6 7 8 9 10 11 12 13 num_hiddens = 512 net = RNNModelScratch(len(vocab), num_hiddens, d2l.try_gpu(), get_params, init_rnn_state, rnn) state = net.begin_state(X.shape[0], d2l.try_gpu()) # æ‰¹é‡åŒ…å«çš„åºåˆ—æ•°ä¸º2ï¼Œåºåˆ—é•¿åº¦ä¸º5 X = torch.arange(10).reshape((2, 5)) Y, new_state = net(X.to(d2l.try_gpu()), state) Y.shape # torch.Size([10, 28]) new_state[0].shape #æ‰¹é‡å†…æ¯ä¸ªå­åºåˆ—æœ€åä¸€ä¸ªæ—¶é—´æ­¥çš„éšçŠ¶æ€ # torch.Size([2, 512]) 5.4 é¢„æµ‹ prefixï¼šåŒ…å«è‹¥å¹²è¯å…ƒçš„åˆå§‹æ–‡æœ¬ num_predsï¼šå¾€åé¢„æµ‹å¤šå°‘ä¸ªè¯å…ƒ åœ¨é¢„æµ‹è¿‡ç¨‹ä¸­ï¼Œé¦–å…ˆé€ä¸ªéå†ç»™å®šçš„åˆå§‹è¯å…ƒï¼Œä½†ä¸åšé¢„æµ‹ï¼Œä»…ç”¨äºæ›´æ–°éšçŠ¶æ€ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 def predict_ch8(prefix, num_preds, net, vocab, device): #@save \"\"\"åœ¨prefixåé¢ç”Ÿæˆæ–°å­—ç¬¦\"\"\" # batch_size=1è¡¨ç¤ºå•æ‰¹é‡é€ä¸ªé¢„æµ‹ state = net.begin_state(batch_size=1, device=device) # é¦–å…ˆå°†prefixçš„ç¬¬ä¸€ä¸ªè¯å…ƒåŠ å…¥åˆ°outputsä¸­ outputs = [vocab[prefix[0]]] # å–outputsé‡Œæœ€æ–°çš„ä¸€ä¸ªè¯å…ƒï¼Œä½œä¸ºé¢„æµ‹ä¸‹ä¸€ä¸ªè¯å…ƒçš„è¾“å…¥ get_input = lambda: torch.tensor([outputs[-1]], device=device).reshape((1, 1)) for y in prefix[1:]: # é¢„çƒ­æœŸ _, state = net(get_input(), state) outputs.append(vocab[y]) #ä¼ å…¥çœŸå®å€¼ for _ in range(num_preds): # é¢„æµ‹num_predsæ­¥ y, state = net(get_input(), state) outputs.append(int(y.argmax(dim=1).reshape(1))) #ä¼ å…¥é¢„æµ‹å€¼ return ''.join([vocab.idx_to_token[i] for i in outputs]) ç¤ºä¾‹ 1 2 predict_ch8('time traveller ', 10, net, vocab, d2l.try_gpu()) # 'time traveller xejnnnnnnn' 5.5 æ¢¯åº¦å‰ªè£ å¯¹äºé•¿åº¦ä¸ºTçš„åºåˆ—ï¼Œè®­ç»ƒæ—¶ä¼šæ‰§è¡ŒTæ¬¡çŸ©é˜µä¹˜æ³•ï¼Œæ¥è¿›è¡Œåå‘ä¼ æ’­ã€æ›´æ–°æ¢¯åº¦ã€‚ è¿™å¯¹äºè¾ƒé•¿çš„åºåˆ—ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ¢¯åº¦çˆ†ç‚¸ï¼Œæ¨¡å‹æ— æ³•æ”¶æ•›ã€‚ æ­¤æ—¶ï¼Œå¯ä»¥é€šè¿‡æ¢¯åº¦å‰ªè£ï¼Œå°†å‚æ•°çš„æ¢¯åº¦çš„èŒƒæ•°è®¾ç½®ä¸€ä¸ªä¸Šé™Î¸ï¼ˆä¸æ”¹å˜æ–¹å‘ï¼‰ã€‚ 1 2 3 4 5 6 7 8 9 10 11 def grad_clipping(net, theta): #@save \"\"\"è£å‰ªæ¢¯åº¦\"\"\" if isinstance(net, nn.Module): params = [p for p in net.parameters() if p.requires_grad] else: params = net.params norm = torch.sqrt(sum(torch.sum((p.grad ** 2)) for p in params)) #è‹¥èŒƒæ•°é•¿åº¦å¤§äºÎ¸ï¼Œå°±è®¾ç½®å…¶å€¼ä¸ºÎ¸ if norm \u003e theta: for param in params: param.grad[:] *= theta / norm 5.6 è®­ç»ƒ åœ¨3.2å°èŠ‚ä¸­ï¼Œå­¦ä¹ äº†ä¸¤ç§å°æ‰¹é‡åºåˆ—æ ·æœ¬è¿­ä»£æ–¹æ³•ï¼šï¼ˆ1ï¼‰é¡ºåºåˆ†åŒºï¼›ï¼ˆ2ï¼‰éšæœºæŠ½æ · å¯¹äºé¡ºåºåˆ†åŒºï¼Œç›¸é‚»ä¸¤ä¸ªbatch iterationä¸­ï¼Œå¯¹åº”çš„ç¬¬iä¸ªå­åºåˆ—çš„ä½åºä¹Ÿæ˜¯ç›¸é‚»çš„ã€‚ éšçŠ¶æ€ä»…éœ€è¦åœ¨åˆšå¼€å§‹æ—¶åˆå§‹åŒ–ä¸€æ¬¡ã€‚åœ¨åé¢çš„å¤šè½®å°æ‰¹é‡è®­ç»ƒæ—¶ï¼Œå¯ä»¥ç»§æ‰¿ã€‚ ä¸ºå‡å°‘è®¡ç®—é‡ï¼Œåœ¨å¤„ç†æ¯ä¸ªæ‰¹é‡æ•°æ®å‰ï¼Œå¯¹éšçŠ¶æ€å‚æ•°æ¢¯åº¦åˆ†ç¦»ã€‚ å¯¹äºéšæœºæŠ½æ ·ï¼Œç›¸é‚»ä¸¤ä¸ªbatch iterationçš„åºåˆ—æ ·æœ¬æ— ç¡®å®šå…³ç³»ï¼ˆæ›´å¸¸ç”¨äº›ï¼‰ éšçŠ¶æ€åœ¨æ¯ä¸ªbatch iterationæ—¶ï¼Œéƒ½éœ€è¦éšæœºåˆå§‹åŒ–ï¼ˆå…¶æƒé‡å‚æ•°æ˜¯æŒç»­æ›´æ–°çš„ï¼‰ã€‚ å¦‚ä¸‹ä¸ºè®­ç»ƒä¸€ä¸ªepochçš„ä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 #@save def train_epoch_ch8(net, train_iter, loss, updater, device, use_random_iter): \"\"\"è®­ç»ƒç½‘ç»œä¸€ä¸ªè¿­ä»£å‘¨æœŸï¼ˆå®šä¹‰è§ç¬¬8ç« ï¼‰\"\"\" state, timer = None, d2l.Timer() metric = d2l.Accumulator(2) # è®­ç»ƒæŸå¤±ä¹‹å’Œ,è¯å…ƒæ•°é‡ for X, Y in train_iter: if state is None or use_random_iter: # åœ¨ç¬¬ä¸€æ¬¡è¿­ä»£æˆ–ä½¿ç”¨éšæœºæŠ½æ ·æ—¶åˆå§‹åŒ–state state = net.begin_state(batch_size=X.shape[0], device=device) else: if isinstance(net, nn.Module) and not isinstance(state, tuple): # stateå¯¹äºnn.GRUæ˜¯ä¸ªå¼ é‡ state.detach_() else: # stateå¯¹äºnn.LSTMæˆ–å¯¹äºæˆ‘ä»¬ä»é›¶å¼€å§‹å®ç°çš„æ¨¡å‹æ˜¯ä¸ªå¼ é‡ for s in state: s.detach_() y = Y.T.reshape(-1) X, y = X.to(device), y.to(device) y_hat, state = net(X, state) l = loss(y_hat, y.long()).mean() # yè½¬ä¸ºé•¿æ•´å‹(64ä½æ•´æ•°) if isinstance(updater, torch.optim.Optimizer): updater.zero_grad() l.backward() grad_clipping(net, 1) updater.step() else: l.backward() grad_clipping(net, 1) # å› ä¸ºå·²ç»è°ƒç”¨äº†meanå‡½æ•° updater(batch_size=1) metric.add(l * y.numel(), y.numel()) return math.exp(metric[0] / metric[1]), metric[1] / timer.stop() å¦‚ä¸‹ä¸ºè®­ç»ƒçš„æœ€ç»ˆå½¢å¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 #@save def train_ch8(net, train_iter, vocab, lr, num_epochs, device, use_random_iter=False): \"\"\"è®­ç»ƒæ¨¡å‹ï¼ˆå®šä¹‰è§ç¬¬8ç« ï¼‰\"\"\" loss = nn.CrossEntropyLoss() animator = d2l.Animator(xlabel='epoch', ylabel='perplexity', legend=['train'], xlim=[10, num_epochs]) # åˆå§‹åŒ– if isinstance(net, nn.Module): updater = torch.optim.SGD(net.parameters(), lr) else: updater = lambda batch_size: d2l.sgd(net.params, lr, batch_size) predict = lambda prefix: predict_ch8(prefix, 50, net, vocab, device) # è®­ç»ƒå’Œé¢„æµ‹ for epoch in range(num_epochs): ppl, speed = train_epoch_ch8( net, train_iter, loss, updater, device, use_random_iter) if (epoch + 1) % 10 == 0: print(predict('time traveller')) animator.add(epoch + 1, [ppl]) print(f'å›°æƒ‘åº¦ {ppl:.1f}, {speed:.1f} è¯å…ƒ/ç§’ {str(device)}') print(predict('time traveller')) print(predict('traveller')) å®é™…è®­ç»ƒ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 ## è®­ç»ƒ--é¡ºåºåˆ†åŒºï¼ˆä¸‹å›¾å·¦ï¼‰ num_epochs, lr = 500, 1 train_ch8(net, train_iter, vocab, lr, num_epochs, d2l.try_gpu()) # å›°æƒ‘åº¦ 1.0, 38769.2 è¯å…ƒ/ç§’ cuda:0 # time travelleryou can show black is white by argument said filby # travelleryou can show black is white by argument said filby ## è®­ç»ƒ--éšæœºæŠ½æ ·ï¼ˆä¸‹å›¾å³ï¼‰ net = RNNModelScratch(len(vocab), num_hiddens, d2l.try_gpu(), get_params, init_rnn_state, rnn) train_ch8(net, train_iter, vocab, lr, num_epochs, d2l.try_gpu(), use_random_iter=True) # å›°æƒ‘åº¦ 1.5, 37930.8 è¯å…ƒ/ç§’ cuda:0 # time travellerit s against reason said filbywas allaing the time # travellerit s against reason said filbywas allaing the time 6. RNNçš„ç®€æ´å®ç° å‡†å¤‡æ•°æ® 1 2 3 4 5 6 7 import torch from torch import nn from torch.nn import functional as F from d2l import torch as d2l batch_size, num_steps = 32, 35 train_iter, vocab = d2l.load_data_time_machine(batch_size, num_steps) 6.1 å®šä¹‰æ¨¡å‹ åŸºäºtorchçš„nn.RNNï¼Œå®šä¹‰ä¸€ä¸ªå…·æœ‰256ä¸ªéšè—å•å…ƒçš„å•éšè—å±‚ï¼Œå…¶ä¸æ¶‰åŠè¾“å‡ºå±‚çš„è®¡ç®— 1 2 num_hiddens = 256 rnn_layer = nn.RNN(len(vocab), num_hiddens) åˆå§‹åŒ–éšçŠ¶æ€ï¼Œå½¢çŠ¶ä¸ºï¼ˆéšè—å±‚æ•°ï¼Œæ‰¹é‡å¤§å°ï¼Œéšè—å•å…ƒæ•°ï¼‰ 1 2 3 state = torch.zeros((1, batch_size, num_hiddens)) state.shape # torch.Size([1, 32, 256]) æ¨¡æ‹Ÿè®¡ç®—ï¼Œæ›´æ–°éšçŠ¶æ€ å¦‚ä¸‹çš„Yè¡¨ç¤ºï¼Œæ‰€æœ‰æ‰¹é‡çš„å­åºåˆ—çš„æœ€åä¸€å±‚çš„éšçŠ¶æ€ï¼ˆä¸€èˆ¬åé¢éœ€è¦å†æ¥MLPé¢„æµ‹Otè¾“å‡ºï¼‰ state_newè¡¨ç¤ºæ‰€æœ‰æ‰¹é‡çš„å­åºåˆ—çš„æœ€åä¸€æ­¥çš„éšçŠ¶æ€ 1 2 3 4 5 6 7 X = torch.rand(size=(num_steps, batch_size, len(vocab))) Y, state_new = rnn_layer(X, state) Y.shape, state_new.shape # (torch.Size([35, 32, 256]), torch.Size([1, 32, 256])) # 35ä¸ºåºåˆ—é•¿åº¦ # 32ä¸ºæ‰¹é‡å¤§å° # 256 éšè—å±‚å•å…ƒæ•° å®šä¹‰ä¸€ä¸ªå®Œæ•´çš„RNNModelç±» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 #@save class RNNModel(nn.Module): \"\"\"å¾ªç¯ç¥ç»ç½‘ç»œæ¨¡å‹\"\"\" def __init__(self, rnn_layer, vocab_size, **kwargs): super(RNNModel, self).__init__(**kwargs) self.rnn = rnn_layer self.vocab_size = vocab_size self.num_hiddens = self.rnn.hidden_size # å¦‚æœRNNæ˜¯åŒå‘çš„ï¼ˆä¹‹åå°†ä»‹ç»ï¼‰ï¼Œnum_directionsåº”è¯¥æ˜¯2ï¼Œå¦åˆ™åº”è¯¥æ˜¯1 if not self.rnn.bidirectional: self.num_directions = 1 self.linear = nn.Linear(self.num_hiddens, self.vocab_size) else: self.num_directions = 2 self.linear = nn.Linear(self.num_hiddens * 2, self.vocab_size) def forward(self, inputs, state): X = F.one_hot(inputs.T.long(), self.vocab_size) X = X.to(torch.float32) Y, state = self.rnn(X, state) # å…¨è¿æ¥å±‚é¦–å…ˆå°†Yçš„å½¢çŠ¶æ”¹ä¸º(æ—¶é—´æ­¥æ•°*æ‰¹é‡å¤§å°,éšè—å•å…ƒæ•°) # å®ƒçš„è¾“å‡ºå½¢çŠ¶æ˜¯(æ—¶é—´æ­¥æ•°*æ‰¹é‡å¤§å°,è¯è¡¨å¤§å°)ã€‚ output = self.linear(Y.reshape((-1, Y.shape[-1]))) return output, state def begin_state(self, device, batch_size=1): if not isinstance(self.rnn, nn.LSTM): # nn.GRUä»¥å¼ é‡ä½œä¸ºéšçŠ¶æ€ return torch.zeros((self.num_directions * self.rnn.num_layers, batch_size, self.num_hiddens), device=device) else: # nn.LSTMä»¥å…ƒç»„ä½œä¸ºéšçŠ¶æ€ return (torch.zeros(( self.num_directions * self.rnn.num_layers, batch_size, self.num_hiddens), device=device), torch.zeros(( self.num_directions * self.rnn.num_layers, batch_size, self.num_hiddens), device=device)) 6.2 è®­ç»ƒä¸é¢„æµ‹ è®­ç»ƒå‡½æ•°ä»å‚è€ƒ5.6å°èŠ‚ å®ä¾‹åŒ–æ¨¡å‹ 1 2 3 4 5 device = d2l.try_gpu() net = RNNModel(rnn_layer, vocab_size=len(vocab)) net = net.to(device) d2l.predict_ch8('time traveller', 10, net, vocab, device) # 'time travellerpppwllllll' è®­ç»ƒæ¨¡å‹ 1 2 3 4 5 num_epochs, lr = 500, 1 d2l.train_ch8(net, train_iter, vocab, lr, num_epochs, device) # perplexity 1.3, 255236.1 tokens/sec on cuda:0 # time traveller but now you be in aly has we mave the gratienttan # travellerit s ala to be accupted is an absolute procimind a ",
  "wordCount" : "7871",
  "inLanguage": "en",
  "datePublished": "2024-08-11T00:00:00Z",
  "dateModified": "2024-08-11T00:00:00Z",
  "author":[{
    "@type": "Person",
    "name": "Lishensuo"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://lishensuo.github.io/en/posts/bioinfo/711d2l-%E7%AC%AC%E5%85%AB%E7%AB%A0%E5%BE%AA%E7%8E%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Li's Bioinfo-Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://lishensuo.github.io/img/Q.gif"
    }
  }
}
</script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://lishensuo.github.io/en/" accesskey="h" title="Li&#39;s Bioinfo-Blog (Alt + H)">Li&#39;s Bioinfo-Blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                </ul>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://lishensuo.github.io/en/" title="ä¸»é¡µ">
                    <span>ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://lishensuo.github.io/en/posts" title="åˆ†ç±»">
                    <span>åˆ†ç±»</span>
                </a>
            </li>
            <li>
                <a href="https://lishensuo.github.io/en/tags" title="æ ‡ç­¾">
                    <span>æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://lishensuo.github.io/en/archives/" title="å½’æ¡£">
                    <span>å½’æ¡£</span>
                </a>
            </li>
            <li>
                <a href="https://lishensuo.github.io/en/about" title="å…³äº">
                    <span>å…³äº</span>
                </a>
            </li>
            <li>
                <a href="https://lishensuo.github.io/en/search" title="æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>æœç´¢</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://lishensuo.github.io/en/">Home</a>&nbsp;Â»&nbsp;<a href="https://lishensuo.github.io/en/posts/">åˆ†ç±»</a>&nbsp;Â»&nbsp;<a href="https://lishensuo.github.io/en/posts/bioinfo/">ğŸ“– ç”Ÿä¿¡æ•°æ®åˆ†æ--åˆ†ææµç¨‹ï¼Œå·¥å…·åŒ…ç­‰</a></div>
    <h1 class="post-title">
      D2L--ç¬¬å…«ç« å¾ªç¯ç¥ç»ç½‘ç»œ
    </h1>
    <div class="post-meta">













Create:&amp;nbsp;&lt;span title=&#39;2024-08-11 00:00:00 &#43;0000 UTC&#39;&gt;2024-08-11&lt;/span&gt;&amp;nbsp;|&amp;nbsp;Update:&amp;nbsp;2024-08-11&amp;nbsp;|&amp;nbsp;Words:&amp;nbsp;7871&amp;nbsp;|&amp;nbsp;16 min&amp;nbsp;|&amp;nbsp;Lishensuo

|  Viewers: <span id="busuanzi_value_page_pv"></span> 
	  
    </div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">Table of Contents</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#1-%e5%ba%8f%e5%88%97%e6%a8%a1%e5%9e%8b" aria-label="1. åºåˆ—æ¨¡å‹">1. åºåˆ—æ¨¡å‹</a><ul>
                            
                    <li>
                        <a href="#11-%e8%87%aa%e5%9b%9e%e5%bd%92%e6%a8%a1%e5%9e%8b" aria-label="1.1 è‡ªå›å½’æ¨¡å‹">1.1 è‡ªå›å½’æ¨¡å‹</a></li>
                    <li>
                        <a href="#12-%e8%ae%ad%e7%bb%83" aria-label="1.2 è®­ç»ƒ">1.2 è®­ç»ƒ</a></li>
                    <li>
                        <a href="#13-%e9%a2%84%e6%b5%8b" aria-label="1.3 é¢„æµ‹">1.3 é¢„æµ‹</a></li></ul>
                    </li>
                    <li>
                        <a href="#2-%e6%96%87%e6%9c%ac%e9%a2%84%e5%a4%84%e7%90%86" aria-label="2 æ–‡æœ¬é¢„å¤„ç†">2 æ–‡æœ¬é¢„å¤„ç†</a><ul>
                            
                    <li>
                        <a href="#21-%e8%af%bb%e5%8f%96%e6%95%b0%e6%8d%ae%e9%9b%86" aria-label="2.1 è¯»å–æ•°æ®é›†">2.1 è¯»å–æ•°æ®é›†</a></li>
                    <li>
                        <a href="#22-%e8%af%8d%e5%85%83%e5%8c%96" aria-label="2.2 è¯å…ƒåŒ–">2.2 è¯å…ƒåŒ–</a></li>
                    <li>
                        <a href="#23-%e8%af%8d%e8%a1%a8" aria-label="2.3 è¯è¡¨">2.3 è¯è¡¨</a></li>
                    <li>
                        <a href="#24-%e6%95%b4%e5%90%88%e6%89%80%e6%9c%89%e5%8a%9f%e8%83%bd" aria-label="2.4 æ•´åˆæ‰€æœ‰åŠŸèƒ½">2.4 æ•´åˆæ‰€æœ‰åŠŸèƒ½</a></li></ul>
                    </li>
                    <li>
                        <a href="#3-%e8%af%ad%e8%a8%80%e6%a8%a1%e5%9e%8b%e5%92%8c%e6%95%b0%e6%8d%ae%e9%9b%86" aria-label="3. è¯­è¨€æ¨¡å‹å’Œæ•°æ®é›†">3. è¯­è¨€æ¨¡å‹å’Œæ•°æ®é›†</a><ul>
                            
                    <li>
                        <a href="#31-%e8%87%aa%e7%84%b6%e8%af%ad%e8%a8%80%e7%bb%9f%e8%ae%a1" aria-label="3.1 è‡ªç„¶è¯­è¨€ç»Ÿè®¡">3.1 è‡ªç„¶è¯­è¨€ç»Ÿè®¡</a></li>
                    <li>
                        <a href="#32-%e8%af%bb%e5%8f%96%e9%95%bf%e5%ba%8f%e5%88%97%e6%95%b0%e6%8d%ae" aria-label="3.2 è¯»å–é•¿åºåˆ—æ•°æ®">3.2 è¯»å–é•¿åºåˆ—æ•°æ®</a></li></ul>
                    </li>
                    <li>
                        <a href="#4-%e5%be%aa%e7%8e%af%e7%a5%9e%e7%bb%8f%e7%bd%91%e7%bb%9c" aria-label="4. å¾ªç¯ç¥ç»ç½‘ç»œ">4. å¾ªç¯ç¥ç»ç½‘ç»œ</a><ul>
                            
                    <li>
                        <a href="#41-%e6%97%a0%e9%9a%90%e7%8a%b6%e6%80%81%e7%9a%84%e7%a5%9e%e7%bb%8f%e7%bd%91%e7%bb%9c" aria-label="4.1 æ— éšçŠ¶æ€çš„ç¥ç»ç½‘ç»œ">4.1 æ— éšçŠ¶æ€çš„ç¥ç»ç½‘ç»œ</a></li>
                    <li>
                        <a href="#42-%e6%9c%89%e9%9a%90%e7%8a%b6%e6%80%81%e7%9a%84%e7%a5%9e%e7%bb%8f%e7%bd%91%e7%bb%9c" aria-label="4.2 æœ‰éšçŠ¶æ€çš„ç¥ç»ç½‘ç»œ">4.2 æœ‰éšçŠ¶æ€çš„ç¥ç»ç½‘ç»œ</a></li>
                    <li>
                        <a href="#43-%e5%9f%ba%e4%ba%8ernn%e7%9a%84%e5%ad%97%e7%ac%a6%e7%ba%a7%e8%af%ad%e8%a8%80%e6%a8%a1%e5%9e%8b" aria-label="4.3 åŸºäºRNNçš„å­—ç¬¦çº§è¯­è¨€æ¨¡å‹">4.3 åŸºäºRNNçš„å­—ç¬¦çº§è¯­è¨€æ¨¡å‹</a></li>
                    <li>
                        <a href="#44-%e5%9b%b0%e6%83%91%e5%ba%a6" aria-label="4.4 å›°æƒ‘åº¦">4.4 å›°æƒ‘åº¦</a></li></ul>
                    </li>
                    <li>
                        <a href="#5-rnn%e7%9a%84%e4%bb%8e%e9%9b%b6%e5%ae%9e%e7%8e%b0" aria-label="5. RNNçš„ä»é›¶å®ç°">5. RNNçš„ä»é›¶å®ç°</a><ul>
                            
                    <li>
                        <a href="#51-%e7%8b%ac%e7%83%ad%e7%bc%96%e7%a0%81" aria-label="5.1 ç‹¬çƒ­ç¼–ç ">5.1 ç‹¬çƒ­ç¼–ç </a></li>
                    <li>
                        <a href="#52-%e5%88%9d%e5%a7%8b%e5%8c%96%e6%a8%a1%e5%9e%8b%e5%8f%82%e6%95%b0" aria-label="5.2 åˆå§‹åŒ–æ¨¡å‹å‚æ•°">5.2 åˆå§‹åŒ–æ¨¡å‹å‚æ•°</a></li>
                    <li>
                        <a href="#53-rnn%e6%a8%a1%e5%9e%8b" aria-label="5.3 RNNæ¨¡å‹">5.3 RNNæ¨¡å‹</a></li>
                    <li>
                        <a href="#54-%e9%a2%84%e6%b5%8b" aria-label="5.4 é¢„æµ‹">5.4 é¢„æµ‹</a></li>
                    <li>
                        <a href="#55-%e6%a2%af%e5%ba%a6%e5%89%aa%e8%a3%81" aria-label="5.5 æ¢¯åº¦å‰ªè£">5.5 æ¢¯åº¦å‰ªè£</a></li>
                    <li>
                        <a href="#56-%e8%ae%ad%e7%bb%83" aria-label="5.6 è®­ç»ƒ">5.6 è®­ç»ƒ</a></li></ul>
                    </li>
                    <li>
                        <a href="#6-rnn%e7%9a%84%e7%ae%80%e6%b4%81%e5%ae%9e%e7%8e%b0" aria-label="6. RNNçš„ç®€æ´å®ç°">6. RNNçš„ç®€æ´å®ç°</a><ul>
                            
                    <li>
                        <a href="#61-%e5%ae%9a%e4%b9%89%e6%a8%a1%e5%9e%8b" aria-label="6.1 å®šä¹‰æ¨¡å‹">6.1 å®šä¹‰æ¨¡å‹</a></li>
                    <li>
                        <a href="#62-%e8%ae%ad%e7%bb%83%e4%b8%8e%e9%a2%84%e6%b5%8b" aria-label="6.2 è®­ç»ƒä¸é¢„æµ‹">6.2 è®­ç»ƒä¸é¢„æµ‹</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>


  <div class="post-content"><h1 id="1-åºåˆ—æ¨¡å‹">1. åºåˆ—æ¨¡å‹<a hidden class="anchor" aria-hidden="true" href="#1-åºåˆ—æ¨¡å‹">#</a></h1>
<h2 id="11-è‡ªå›å½’æ¨¡å‹">1.1 è‡ªå›å½’æ¨¡å‹<a hidden class="anchor" aria-hidden="true" href="#11-è‡ªå›å½’æ¨¡å‹">#</a></h2>
<p>ï¼ˆ1ï¼‰<strong>è‡ªå›å½’æ¨¡å‹</strong>ï¼šå¯¹äºä¸€ä¸ªåŒ…å«Tä¸ª&rsquo;æ—¶é—´&rsquo;èŠ‚ç‚¹çš„è¾“å…¥åºåˆ—ï¼Œè‹¥é¢„æµ‹å…¶ä¸­çš„ç¬¬tä¸ªæ•°æ®ï¼Œåˆ™ä¾èµ–äºè¯¥èŠ‚ç‚¹å‰é¢çš„è§‚å¯Ÿæ•°æ®</p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/lishensuo/images2/main/img01/image-20240806194905905.png" alt="image-20240806194905905"  />
</p>
<ul>
<li>åŸºäºæ­¤ï¼Œå¯¹äºæ•´ä¸ªåºåˆ—çš„ä¼°è®¡å€¼ï¼Œå¯ä»¥è¡¨ç¤ºä¸ºï¼š</li>
</ul>
<p><img loading="lazy" src="https://raw.githubusercontent.com/lishensuo/images2/main/img01/image-20240806195042014.png" alt="image-20240806195042014"  />
</p>
<ul>
<li>ç„¶è€Œè¿™å¯¹äºé•¿åºåˆ—åˆ™è®¡ç®—é‡è¿‡å¤§ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¯¥èŠ‚ç‚¹å‰é¢çš„Ï„ä¸ªæ ·æœ¬å»ºæ¨¡ï¼Œæ§åˆ¶æ¨¡å‹å‚æ•°çš„æ•°é‡ã€‚
<ul>
<li>å¦‚æœåºåˆ—å¯ä»¥æŒ‰è¿™ç§æ–¹å¼è®¡ç®—ï¼Œåˆ™è®¤ä¸ºå…¶æ»¡è¶³é©¬å°”ç§‘å¤«æ¡ä»¶ã€‚</li>
<li>å½“Ï„=1ï¼ˆæ ¹æ®å‰ä¸€ä¸ªèŠ‚ç‚¹æ¨æµ‹åä¸€ä¸ªèŠ‚ç‚¹ï¼‰æ—¶ï¼Œåºåˆ—ä¼°è®¡å¯ä»¥å†™æˆå¦‚ä¸‹å½¢å¼ã€‚</li>
</ul>
</li>
</ul>
<p><img loading="lazy" src="https://raw.githubusercontent.com/lishensuo/images2/main/img01/image-20240806201637200.png" alt="image-20240806201637200"  />
</p>
<blockquote>
<p>Tipsï¼šç§°ä¸ºè‡ªå›å½’çš„åŸå› æ˜¯è¾“å…¥ä¸è¾“å‡ºé¢„æµ‹åŒä¸€ç±»å‹çš„æ•°æ®ã€‚</p></blockquote>
<p>ï¼ˆ2ï¼‰<strong>éšå˜é‡è‡ªå›å½’æ¨¡å‹</strong> é€šè¿‡ä¸€ä¸ªéšè—(latent):çš„å˜é‡æ¨æµ‹Xtçš„å€¼ã€‚è€Œè¯¥éšè—å˜é‡æ¥è‡ªäºä¸Šä¸€çŠ¶æ€çš„éšå˜é‡ä»¥åŠå½“å‰Xt-1èŠ‚ç‚¹çš„å€¼ã€‚ï¼ˆRNN, Recurrent Neural Network)çš„æ€æƒ³ï¼‰</p>
<p><img loading="lazy" src="C:%5cUsers%5cxiaoxin%5cAppData%5cRoaming%5cTypora%5ctypora-user-images%5cimage-20240806171721063.png" alt="image-20240806171721063"  />
</p>
<h2 id="12-è®­ç»ƒ">1.2 è®­ç»ƒ<a hidden class="anchor" aria-hidden="true" href="#12-è®­ç»ƒ">#</a></h2>
<p>å¦‚ä¸‹å°†æ¼”ç¤ºå¦‚ä½•æ ¹æ®æ­£å¼¦å‡½æ•°çš„æ ·æœ¬ç‚¹ï¼Œå»ºç«‹Ï„=4çš„è‡ªå›å½’æ¨¡å‹</p>
<ul>
<li>ç¬¬ä¸€æ­¥ï¼šæ¨¡æ‹Ÿæ­£å¼¦å‡½æ•°çš„æ•°æ®ï¼Œxè½´ä»0åˆ°1000</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>%matplotlib inline
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> torch <span style="color:#fff;font-weight:bold">import</span> nn
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> d2l <span style="color:#fff;font-weight:bold">import</span> torch <span style="color:#fff;font-weight:bold">as</span> d2l
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>T = <span style="color:#ff0;font-weight:bold">1000</span>  <span style="color:#007f7f"># æ€»å…±äº§ç”Ÿ1000ä¸ªç‚¹</span>
</span></span><span style="display:flex;"><span>time = torch.arange(<span style="color:#ff0;font-weight:bold">1</span>, T + <span style="color:#ff0;font-weight:bold">1</span>, dtype=torch.float32)
</span></span><span style="display:flex;"><span>x = torch.sin(<span style="color:#ff0;font-weight:bold">0.01</span> * time) + torch.normal(<span style="color:#ff0;font-weight:bold">0</span>, <span style="color:#ff0;font-weight:bold">0.2</span>, (T,)) <span style="color:#007f7f">#æ·»åŠ ä¸€ç‚¹å™ªéŸ³</span>
</span></span><span style="display:flex;"><span>d2l.plot(time, [x], <span style="color:#0ff;font-weight:bold">&#39;time&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;x&#39;</span>, xlim=[<span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">1000</span>], figsize=(<span style="color:#ff0;font-weight:bold">6</span>, <span style="color:#ff0;font-weight:bold">3</span>))
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://raw.githubusercontent.com/lishensuo/images2/main/img01/image-20240806205930245.png" alt="image-20240806205930245"  />
</p>
<ul>
<li>ç¬¬äºŒæ­¥ï¼šç”Ÿæˆç‰¹å¾ä¸æ ‡ç­¾æ•°æ®ï¼ˆå‰4ä¸ªæ ·æœ¬ä½œä¸ºè¾“å…¥ï¼Œç¬¬5ä¸ªæ ·æœ¬ä½œä¸ºé¢„æµ‹ï¼‰</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>tau = <span style="color:#ff0;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>features = torch.zeros((T - tau, tau)) <span style="color:#007f7f">#tauåˆ—</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(tau): <span style="color:#007f7f">#é€åˆ—å¡«å……ï¼Œæ¯æ¬¡é”™å¼€ä¸€ä¸ªå…ƒç´ </span>
</span></span><span style="display:flex;"><span>    features[:, i] = x[i: T - tau + i]
</span></span><span style="display:flex;"><span>labels = x[tau:].reshape((-<span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">1</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>features[:<span style="color:#ff0;font-weight:bold">4</span>,:], labels[:<span style="color:#ff0;font-weight:bold">4</span>]
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># (tensor([[-0.1026, -0.2982,  0.1424,  0.0798],</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#          [-0.2982,  0.1424,  0.0798,  0.1033],</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#          [ 0.1424,  0.0798,  0.1033,  0.0814],</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#          [ 0.0798,  0.1033,  0.0814, -0.3063]]),</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#  tensor([[ 0.1033],</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#          [ 0.0814],</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#          [-0.3063],</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#          [ 0.1354]]))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>batch_size, n_train = <span style="color:#ff0;font-weight:bold">16</span>, <span style="color:#ff0;font-weight:bold">600</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># åªæœ‰å‰n_trainä¸ªæ ·æœ¬ç”¨äºè®­ç»ƒ</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># æ‰¹é‡æ•°æ®è¿­ä»£</span>
</span></span><span style="display:flex;"><span>train_iter = d2l.load_array((features[:n_train], labels[:n_train]),
</span></span><span style="display:flex;"><span>                            batch_size, is_train=<span style="color:#fff;font-weight:bold">True</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ç¬¬ä¸‰æ­¥ï¼šå»ºç«‹æ¨¡å‹</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f"># åˆå§‹åŒ–ç½‘ç»œæƒé‡çš„å‡½æ•°</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> init_weights(m):
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">type</span>(m) == nn.Linear:
</span></span><span style="display:flex;"><span>        nn.init.xavier_uniform_(m.weight)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># ä¸€ä¸ªç®€å•çš„å¤šå±‚æ„ŸçŸ¥æœº</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> get_net():
</span></span><span style="display:flex;"><span>    net = nn.Sequential(nn.Linear(<span style="color:#ff0;font-weight:bold">4</span>, <span style="color:#ff0;font-weight:bold">10</span>),
</span></span><span style="display:flex;"><span>                        nn.ReLU(),
</span></span><span style="display:flex;"><span>                        nn.Linear(<span style="color:#ff0;font-weight:bold">10</span>, <span style="color:#ff0;font-weight:bold">1</span>))
</span></span><span style="display:flex;"><span>    net.apply(init_weights)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> net
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># å¹³æ–¹æŸå¤±ï¼Œä¸åšèšåˆæ“ä½œ</span>
</span></span><span style="display:flex;"><span>loss = nn.MSELoss(reduction=<span style="color:#0ff;font-weight:bold">&#39;none&#39;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ç¬¬å››æ­¥ï¼šè®­ç»ƒæ¨¡å‹</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> train(net, train_iter, loss, epochs, lr):
</span></span><span style="display:flex;"><span>    trainer = torch.optim.Adam(net.parameters(), lr) <span style="color:#007f7f">#ä¼˜åŒ–ç®—æ³•</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> epoch in <span style="color:#fff;font-weight:bold">range</span>(epochs):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> X, y in train_iter:
</span></span><span style="display:flex;"><span>            trainer.zero_grad()
</span></span><span style="display:flex;"><span>            l = loss(net(X), y)
</span></span><span style="display:flex;"><span>            l.sum().backward()
</span></span><span style="display:flex;"><span>            trainer.step()
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#39;epoch </span><span style="color:#0ff;font-weight:bold">{</span>epoch + <span style="color:#ff0;font-weight:bold">1</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">, &#39;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#39;loss: </span><span style="color:#0ff;font-weight:bold">{</span>d2l.evaluate_loss(net, train_iter, loss)<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>net = get_net()
</span></span><span style="display:flex;"><span>train(net, train_iter, loss, <span style="color:#ff0;font-weight:bold">5</span>, <span style="color:#ff0;font-weight:bold">0.01</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="13-é¢„æµ‹">1.3 é¢„æµ‹<a hidden class="anchor" aria-hidden="true" href="#13-é¢„æµ‹">#</a></h2>
<ul>
<li>é¢„æµ‹æ–¹å¼1ï¼šç‰¹å¾æ•°æ®å…¨éƒ¨æ¥è‡ªå·²çŸ¥æ•°æ®</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>onestep_preds = net(features)
</span></span><span style="display:flex;"><span>d2l.plot([time, time[tau:]],
</span></span><span style="display:flex;"><span>         [x.detach().numpy(), onestep_preds.detach().numpy()], <span style="color:#0ff;font-weight:bold">&#39;time&#39;</span>,
</span></span><span style="display:flex;"><span>         <span style="color:#0ff;font-weight:bold">&#39;x&#39;</span>, legend=[<span style="color:#0ff;font-weight:bold">&#39;data&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;1-step preds&#39;</span>], xlim=[<span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">1000</span>],
</span></span><span style="display:flex;"><span>         figsize=(<span style="color:#ff0;font-weight:bold">6</span>, <span style="color:#ff0;font-weight:bold">3</span>))
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># ä¸‹å›¾å·¦</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>é¢„æµ‹æ–¹å¼2ï¼šå‰604ä¸ªæ ·æœ¬æ¥è®­ç»ƒé›†çš„å·²çŸ¥æ•°æ®ã€‚å†åé¢é¢„æµ‹æ—¶ï¼Œæ¯æ¬¡å°†æ–°é¢„æµ‹çš„æ ·æœ¬ä½œä¸ºè¾“å…¥é¢„æµ‹ä¸‹ä¸€ä¸ªè¾“å‡ºã€‚</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>multistep_preds = torch.zeros(T) <span style="color:#007f7f">#åˆå§‹åŒ–å…¨0</span>
</span></span><span style="display:flex;"><span>multistep_preds[: n_train + tau] = x[: n_train + tau] <span style="color:#007f7f">#å‰é¢çš„è®­ç»ƒé›†æ•°æ®å·²çŸ¥ï¼Œä¸åšé¢„æµ‹</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(n_train + tau, T):
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># å°†æ–°é¢„æµ‹çš„ç»“æœåŠ å…¥ç‰¹å¾ä¸­ï¼Œä½œä¸ºä¸‹ä¸€æ¬¡é¢„æµ‹çš„è¾“å…¥</span>
</span></span><span style="display:flex;"><span>    multistep_preds[i] = net(
</span></span><span style="display:flex;"><span>        multistep_preds[i - tau:i].reshape((<span style="color:#ff0;font-weight:bold">1</span>, -<span style="color:#ff0;font-weight:bold">1</span>)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>d2l.plot([time, time[tau:], time[n_train + tau:]],
</span></span><span style="display:flex;"><span>         [x.detach().numpy(), onestep_preds.detach().numpy(),
</span></span><span style="display:flex;"><span>          multistep_preds[n_train + tau:].detach().numpy()], <span style="color:#0ff;font-weight:bold">&#39;time&#39;</span>,
</span></span><span style="display:flex;"><span>         <span style="color:#0ff;font-weight:bold">&#39;x&#39;</span>, legend=[<span style="color:#0ff;font-weight:bold">&#39;data&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;1-step preds&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;multistep preds&#39;</span>],
</span></span><span style="display:flex;"><span>         xlim=[<span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">1000</span>], figsize=(<span style="color:#ff0;font-weight:bold">6</span>, <span style="color:#ff0;font-weight:bold">3</span>))
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># ä¸‹å›¾å³</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://raw.githubusercontent.com/lishensuo/images2/main/img01/image-20240806211506715.png" alt="image-20240806211506715"  />
</p>
<ul>
<li>å¦‚ä¸Šå¯ä»¥çœ‹å‡ºï¼š
<ul>
<li>åœ¨å•æ­¥é¢„æµ‹ï¼ˆè¾“å…¥å‡ä¸ºå®é™…è§‚æµ‹æ•°æ®ï¼‰æ—¶ï¼Œæ¨¡å‹æ•ˆæœä¸é”™ï¼›</li>
<li>è€Œåœ¨é¢„æµ‹å¤šæ­¥ï¼ˆå°†æœ€è¿‘çš„é¢„æµ‹ä½œä¸ºä¸‹ä¸€æ­¥è¾“å…¥ï¼‰æ—¶ï¼Œå³æ›´è¿œçš„é¢„æµ‹æ—¶ï¼Œæ¨¡å‹æ•ˆæœä¸å°½å¦‚äººæ„ã€‚</li>
</ul>
</li>
</ul>
<img src="https://raw.githubusercontent.com/lishensuo/images2/main/img01/76fd30983b088e2540cd4e2b1c9aa6e0.png" alt="skforecastï¼šä¸€æ¬¾è§£å†³æ—¶åºé¢„æµ‹çš„ç¥åº“-CSDNåšå®¢" style="zoom:50%;" />
<h1 id="2-æ–‡æœ¬é¢„å¤„ç†">2 æ–‡æœ¬é¢„å¤„ç†<a hidden class="anchor" aria-hidden="true" href="#2-æ–‡æœ¬é¢„å¤„ç†">#</a></h1>
<p>ä¸€ç¯‡æ–‡ç« å¯ä»¥è§†ä¸ºä¸€ä¸²å•è¯çš„åºåˆ—ï¼Œéœ€è¦è¿›è¡Œå¿…è¦çš„é¢„å¤„ç†æ“ä½œæ­¥éª¤ï¼š</p>
<p>ï¼ˆ1ï¼‰å°†æ–‡æœ¬ä½œä¸ºå­—ç¬¦ä¸²è¿›è¡ŒåŠ è½½ï¼›</p>
<p>ï¼ˆ2ï¼‰å°†å­—ç¬¦ä¸²æ‹†åˆ†ä¸ºè¯å…ƒï¼ˆå•è¯æˆ–å­—ç¬¦ï¼‰ï¼›</p>
<p>ï¼ˆ3ï¼‰å»ºç«‹ä¸€ä¸ªè¯è¡¨ï¼Œå°†è¯å…ƒæ˜ å°„åˆ°æ•°å­—ç´¢å¼•ï¼›</p>
<p>ï¼ˆ4ï¼‰å°†æ–‡æœ¬è½¬æ¢ä¸ºæ•°å­—ç´¢å¼•åºåˆ—ã€‚</p>
<h2 id="21-è¯»å–æ•°æ®é›†">2.1 è¯»å–æ•°æ®é›†<a hidden class="anchor" aria-hidden="true" href="#21-è¯»å–æ•°æ®é›†">#</a></h2>
<ul>
<li>ç¤ºä¾‹æ•°æ®ï¼šæ—¶å…‰æœºå™¨ï¼ˆThe Time Machineï¼‰å°è¯´</li>
<li>å¦‚ä¸‹æ“ä½œï¼ŒæŒ‰è¡Œè¯»å–å…¨éƒ¨å°è¯´æ–‡æœ¬ã€‚ç»“æœä¸ºlistï¼Œå…¶ä¸­æ¯ä¸ªå…ƒç´ è¡¨ç¤ºä¸€è¡Œçš„æ–‡æœ¬ã€‚</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f">#@save</span>
</span></span><span style="display:flex;"><span>d2l.DATA_HUB[<span style="color:#0ff;font-weight:bold">&#39;time_machine&#39;</span>] = (d2l.DATA_URL + <span style="color:#0ff;font-weight:bold">&#39;timemachine.txt&#39;</span>,
</span></span><span style="display:flex;"><span>                                <span style="color:#0ff;font-weight:bold">&#39;090b5e7e70c295757f55df93cb0a180b9691891a&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> read_time_machine():  <span style="color:#007f7f">#@save</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;å°†æ—¶é—´æœºå™¨æ•°æ®é›†åŠ è½½åˆ°æ–‡æœ¬è¡Œçš„åˆ—è¡¨ä¸­&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">with</span> <span style="color:#fff;font-weight:bold">open</span>(d2l.download(<span style="color:#0ff;font-weight:bold">&#39;time_machine&#39;</span>), <span style="color:#0ff;font-weight:bold">&#39;r&#39;</span>) <span style="color:#fff;font-weight:bold">as</span> f:
</span></span><span style="display:flex;"><span>        lines = f.readlines()
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> [re.sub(<span style="color:#0ff;font-weight:bold">&#39;[^A-Za-z]+&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39; &#39;</span>, line).strip().lower() <span style="color:#fff;font-weight:bold">for</span> line in lines]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>lines = read_time_machine() <span style="color:#007f7f"># list</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#39;# æ–‡æœ¬æ€»è¡Œæ•°: </span><span style="color:#0ff;font-weight:bold">{</span><span style="color:#fff;font-weight:bold">len</span>(lines)<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># æ–‡æœ¬æ€»è¡Œæ•°: 3221</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">print</span>(lines[<span style="color:#ff0;font-weight:bold">0</span>])
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># the time machine by h g wells</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">print</span>(lines[<span style="color:#ff0;font-weight:bold">10</span>])
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># twinkled and his usually pale face was flushed and animated the</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="22-è¯å…ƒåŒ–">2.2 è¯å…ƒåŒ–<a hidden class="anchor" aria-hidden="true" href="#22-è¯å…ƒåŒ–">#</a></h2>
<ul>
<li>è¯å…ƒ(token)ï¼Œé€šå¸¸æŒ‡ä¸€ä¸ªå•è¯æˆ–å­—ç¬¦</li>
<li>å¦‚ä¸‹æ“ä½œå°†æ¯ä¸€è¡Œä»¥è¯å…ƒä¸ºå•ä½ï¼Œæ‹†åˆ†ä¸ºä¸€ä¸ªlistï¼Œç»“æœè¿”å›ä¸€ä¸ªlist of list</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> tokenize(lines, token=<span style="color:#0ff;font-weight:bold">&#39;word&#39;</span>):  <span style="color:#007f7f">#@save</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;å°†æ–‡æœ¬è¡Œæ‹†åˆ†ä¸ºå•è¯æˆ–å­—ç¬¦è¯å…ƒ&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> token == <span style="color:#0ff;font-weight:bold">&#39;word&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> [line.split() <span style="color:#fff;font-weight:bold">for</span> line in lines]
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">elif</span> token == <span style="color:#0ff;font-weight:bold">&#39;char&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> [<span style="color:#fff;font-weight:bold">list</span>(line) <span style="color:#fff;font-weight:bold">for</span> line in lines]
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;é”™è¯¯ï¼šæœªçŸ¥è¯å…ƒç±»å‹ï¼š&#39;</span> + token)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tokens = tokenize(lines) <span style="color:#007f7f">#list of list, å†…éƒ¨listçš„å…ƒç´ å³ä¸ºè¯å…ƒ</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">print</span>(tokens[<span style="color:#ff0;font-weight:bold">0</span>])
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># [&#39;the&#39;, &#39;time&#39;, &#39;machine&#39;, &#39;by&#39;, &#39;h&#39;, &#39;g&#39;, &#39;wells&#39;]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="23-è¯è¡¨">2.3 è¯è¡¨<a hidden class="anchor" aria-hidden="true" href="#23-è¯è¡¨">#</a></h2>
<ul>
<li>è¯å…ƒçš„ç±»å‹æ˜¯å­—ç¬¦ä¸²ï¼Œè€Œæ¨¡å‹éœ€è¦çš„æ˜¯æ•°å­—ï¼›</li>
<li><strong>è¯è¡¨</strong>(Vocabulary)ï¼šç±»ä¼¼äºPythonä¸­çš„å­—å…¸ï¼Œå°†è¾“å…¥çš„è¯å…ƒè½¬æ¢ä¸ºæ•°å­—ç´¢å¼•ï¼›</li>
<li><strong>è¯­æ–™åº“</strong>(Corpus)ï¼šå¯¹æ‰€æœ‰æ–‡æœ¬ä¸­å”¯ä¸€è¯å…ƒçš„ç»Ÿè®¡ç»“æœï¼ŒæŒ‰é¢‘ç‡é™åºæ’ã€‚
<ul>
<li>å¯¹äºä½é¢‘ç‡å‡ºç°çš„è¯å…ƒï¼Œå¯è®¾ç½®ä¸€å®šæ ‡å‡†çš„é˜ˆå€¼è¿‡æ»¤ï¼›</li>
<li>å¯¹äºè¯­æ–™åº“ä¸­ä¸å­˜åœ¨ï¼Œæˆ–è€…å·²è¿‡æ»¤çš„è¯å…ƒï¼Œå°†è¢«æ˜ å°„åˆ°æœªçŸ¥è¯å…ƒ&rsquo;&lt;unk&gt;&rsquo;, å…¶æ•°å­—ç´¢å¼•è®°ä¸º0</li>
</ul>
</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> Vocab:  <span style="color:#007f7f">#@save</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;æ–‡æœ¬è¯è¡¨&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> __init__(<span style="color:#fff;font-weight:bold">self</span>, tokens=<span style="color:#fff;font-weight:bold">None</span>, min_freq=<span style="color:#ff0;font-weight:bold">0</span>, reserved_tokens=<span style="color:#fff;font-weight:bold">None</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> tokens is <span style="color:#fff;font-weight:bold">None</span>:
</span></span><span style="display:flex;"><span>            tokens = []
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> reserved_tokens is <span style="color:#fff;font-weight:bold">None</span>:
</span></span><span style="display:flex;"><span>            reserved_tokens = []
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># æŒ‰å‡ºç°é¢‘ç‡æ’åº</span>
</span></span><span style="display:flex;"><span>        counter = count_corpus(tokens)
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># counter.items() e.g. [(&#39;word1&#39;, 5), (&#39;word2&#39;, 3), (&#39;word3&#39;, 8)] </span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">self</span>._token_freqs = <span style="color:#fff;font-weight:bold">sorted</span>(counter.items(), key=<span style="color:#fff;font-weight:bold">lambda</span> x: x[<span style="color:#ff0;font-weight:bold">1</span>],
</span></span><span style="display:flex;"><span>                                   reverse=<span style="color:#fff;font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># æœªçŸ¥è¯å…ƒçš„ç´¢å¼•ä¸º0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">self</span>.idx_to_token = [<span style="color:#0ff;font-weight:bold">&#39;&lt;unk&gt;&#39;</span>] + reserved_tokens
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">self</span>.token_to_idx = {token: idx
</span></span><span style="display:flex;"><span>                             <span style="color:#fff;font-weight:bold">for</span> idx, token in <span style="color:#fff;font-weight:bold">enumerate</span>(<span style="color:#fff;font-weight:bold">self</span>.idx_to_token)}
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> token, freq in <span style="color:#fff;font-weight:bold">self</span>._token_freqs:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> freq &lt; min_freq:
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> token not in <span style="color:#fff;font-weight:bold">self</span>.token_to_idx:
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">self</span>.idx_to_token.append(token)
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">self</span>.token_to_idx[token] = <span style="color:#fff;font-weight:bold">len</span>(<span style="color:#fff;font-weight:bold">self</span>.idx_to_token) - <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> __len__(<span style="color:#fff;font-weight:bold">self</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">len</span>(<span style="color:#fff;font-weight:bold">self</span>.idx_to_token)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f"># å¦‚æœä¼ å…¥å•ä¸ªè¯å…ƒï¼Œåˆ™è¿”å›å…¶ç´¢å¼•ï¼›å¦‚æœä¼ å…¥è¯å…ƒåˆ—è¡¨ï¼Œåˆ™è¿”å›å¯¹åº”çš„ç´¢å¼•åˆ—è¡¨ã€‚</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> __getitem__(<span style="color:#fff;font-weight:bold">self</span>, tokens):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> not <span style="color:#fff;font-weight:bold">isinstance</span>(tokens, (<span style="color:#fff;font-weight:bold">list</span>, <span style="color:#fff;font-weight:bold">tuple</span>)):
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">self</span>.token_to_idx.get(tokens, <span style="color:#fff;font-weight:bold">self</span>.unk)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> [<span style="color:#fff;font-weight:bold">self</span>.__getitem__(token) <span style="color:#fff;font-weight:bold">for</span> token in tokens]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># æ ¹æ®è¾“å…¥çš„ç´¢å¼•æˆ–ç´¢å¼•åˆ—è¡¨è¿”å›å¯¹åº”çš„è¯å…ƒã€‚</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> to_tokens(<span style="color:#fff;font-weight:bold">self</span>, indices):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> not <span style="color:#fff;font-weight:bold">isinstance</span>(indices, (<span style="color:#fff;font-weight:bold">list</span>, <span style="color:#fff;font-weight:bold">tuple</span>)):
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">self</span>.idx_to_token[indices]
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> [<span style="color:#fff;font-weight:bold">self</span>.idx_to_token[index] <span style="color:#fff;font-weight:bold">for</span> index in indices]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @property
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> unk(<span style="color:#fff;font-weight:bold">self</span>):  <span style="color:#007f7f"># æœªçŸ¥è¯å…ƒçš„ç´¢å¼•ä¸º0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @property
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> token_freqs(<span style="color:#fff;font-weight:bold">self</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">self</span>._token_freqs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> count_corpus(tokens):  <span style="color:#007f7f">#@save</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;ç»Ÿè®¡è¯å…ƒçš„é¢‘ç‡&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># è¿™é‡Œçš„tokensæ˜¯1Dåˆ—è¡¨æˆ–2Dåˆ—è¡¨</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">len</span>(tokens) == <span style="color:#ff0;font-weight:bold">0</span> or <span style="color:#fff;font-weight:bold">isinstance</span>(tokens[<span style="color:#ff0;font-weight:bold">0</span>], <span style="color:#fff;font-weight:bold">list</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># å°†è¯å…ƒlist of liståˆ—è¡¨å±•å¹³æˆä¸€ä¸ªåˆ—è¡¨</span>
</span></span><span style="display:flex;"><span>        tokens = [token <span style="color:#fff;font-weight:bold">for</span> line in tokens <span style="color:#fff;font-weight:bold">for</span> token in line]
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> collections.Counter(tokens)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vocab = Vocab(tokens)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">list</span>(vocab.token_to_idx.items())[:<span style="color:#ff0;font-weight:bold">5</span>]
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># [(&#39;&lt;unk&gt;&#39;, 0), (&#39;the&#39;, 1), (&#39;i&#39;, 2), (&#39;and&#39;, 3), (&#39;of&#39;, 4)]</span>
</span></span><span style="display:flex;"><span>vocab.token_freqs[:<span style="color:#ff0;font-weight:bold">5</span>]
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># [(&#39;the&#39;, 2261), (&#39;i&#39;, 1267), (&#39;and&#39;, 1245), (&#39;of&#39;, 1155), (&#39;a&#39;, 816)]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="24-æ•´åˆæ‰€æœ‰åŠŸèƒ½">2.4 æ•´åˆæ‰€æœ‰åŠŸèƒ½<a hidden class="anchor" aria-hidden="true" href="#24-æ•´åˆæ‰€æœ‰åŠŸèƒ½">#</a></h2>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> load_corpus_time_machine(max_tokens=-<span style="color:#ff0;font-weight:bold">1</span>):  <span style="color:#007f7f">#@save</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;è¿”å›æ—¶å…‰æœºå™¨æ•°æ®é›†çš„è¯å…ƒç´¢å¼•åˆ—è¡¨å’Œè¯è¡¨&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    lines = read_time_machine()
</span></span><span style="display:flex;"><span>    tokens = tokenize(lines, <span style="color:#0ff;font-weight:bold">&#39;char&#39;</span>) <span style="color:#007f7f">#è¯å…ƒä¸ºå­—ç¬¦</span>
</span></span><span style="display:flex;"><span>    vocab = Vocab(tokens)
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># å› ä¸ºæ—¶å…‰æœºå™¨æ•°æ®é›†ä¸­çš„æ¯ä¸ªæ–‡æœ¬è¡Œä¸ä¸€å®šæ˜¯ä¸€ä¸ªå¥å­æˆ–ä¸€ä¸ªæ®µè½ï¼Œ</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># æ‰€ä»¥å°†æ‰€æœ‰æ–‡æœ¬è¡Œå±•å¹³åˆ°ä¸€ä¸ªåˆ—è¡¨ä¸­</span>
</span></span><span style="display:flex;"><span>    corpus = [vocab[token] <span style="color:#fff;font-weight:bold">for</span> line in tokens <span style="color:#fff;font-weight:bold">for</span> token in line]
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> max_tokens &gt; <span style="color:#ff0;font-weight:bold">0</span>:
</span></span><span style="display:flex;"><span>        corpus = corpus[:max_tokens]
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> corpus, vocab
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># corpus å…¨éƒ¨æ–‡æœ¬çš„è¯å…ƒ</span>
</span></span><span style="display:flex;"><span>corpus, vocab = load_corpus_time_machine()
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">len</span>(corpus), <span style="color:#fff;font-weight:bold">len</span>(vocab)
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># (170580, 28)</span>
</span></span><span style="display:flex;"><span>corpus[:<span style="color:#ff0;font-weight:bold">5</span>]
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># [3, 9, 2, 1, 3]</span>
</span></span><span style="display:flex;"><span>vocab.token_freqs[:<span style="color:#ff0;font-weight:bold">5</span>]
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># [(&#39; &#39;, 29927), (&#39;e&#39;, 17838), (&#39;t&#39;, 13515), (&#39;a&#39;, 11704), (&#39;i&#39;, 10138)]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="3-è¯­è¨€æ¨¡å‹å’Œæ•°æ®é›†">3. è¯­è¨€æ¨¡å‹å’Œæ•°æ®é›†<a hidden class="anchor" aria-hidden="true" href="#3-è¯­è¨€æ¨¡å‹å’Œæ•°æ®é›†">#</a></h1>
<h2 id="31-è‡ªç„¶è¯­è¨€ç»Ÿè®¡">3.1 è‡ªç„¶è¯­è¨€ç»Ÿè®¡<a hidden class="anchor" aria-hidden="true" href="#31-è‡ªç„¶è¯­è¨€ç»Ÿè®¡">#</a></h2>
<ul>
<li>å•ä¸ªè¯å…ƒç»Ÿè®¡ï¼ˆä¸€å…ƒè¯­æ³•ï¼‰</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> random
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> d2l <span style="color:#fff;font-weight:bold">import</span> torch <span style="color:#fff;font-weight:bold">as</span> d2l
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tokens = d2l.tokenize(d2l.read_time_machine())
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># å°†list of listè½¬ä¸ºlist</span>
</span></span><span style="display:flex;"><span>corpus = [token <span style="color:#fff;font-weight:bold">for</span> line in tokens <span style="color:#fff;font-weight:bold">for</span> token in line]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vocab = d2l.Vocab(corpus)
</span></span><span style="display:flex;"><span>vocab.token_freqs[:<span style="color:#ff0;font-weight:bold">10</span>]
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># [(&#39;the&#39;, 2261), (&#39;i&#39;, 1267), (&#39;and&#39;, 1245)]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ä¸¤ä¸ªè¿ç»­è¯å…ƒç»Ÿè®¡ï¼ˆäºŒå…ƒè¯­æ³•ï¼‰</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>bigram_tokens = [pair <span style="color:#fff;font-weight:bold">for</span> pair in <span style="color:#fff;font-weight:bold">zip</span>(corpus[:-<span style="color:#ff0;font-weight:bold">1</span>], corpus[<span style="color:#ff0;font-weight:bold">1</span>:])]
</span></span><span style="display:flex;"><span>bigram_tokens[:<span style="color:#ff0;font-weight:bold">3</span>]
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># [(&#39;the&#39;, &#39;time&#39;), (&#39;time&#39;, &#39;machine&#39;), (&#39;machine&#39;, &#39;by&#39;)]</span>
</span></span><span style="display:flex;"><span>bigram_vocab = d2l.Vocab(bigram_tokens)
</span></span><span style="display:flex;"><span>bigram_vocab.token_freqs[:<span style="color:#ff0;font-weight:bold">3</span>]
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># [((&#39;of&#39;, &#39;the&#39;), 309), ((&#39;in&#39;, &#39;the&#39;), 169), ((&#39;i&#39;, &#39;had&#39;), 130)]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ä¸‰ä¸ªè¿ç»­è¯å…ƒç»Ÿè®¡ï¼ˆä¸‰å…ƒè¯­æ³•ï¼‰</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>trigram_tokens = [triple <span style="color:#fff;font-weight:bold">for</span> triple in <span style="color:#fff;font-weight:bold">zip</span>(
</span></span><span style="display:flex;"><span>    corpus[:-<span style="color:#ff0;font-weight:bold">2</span>], corpus[<span style="color:#ff0;font-weight:bold">1</span>:-<span style="color:#ff0;font-weight:bold">1</span>], corpus[<span style="color:#ff0;font-weight:bold">2</span>:])]
</span></span><span style="display:flex;"><span>trigram_vocab = d2l.Vocab(trigram_tokens)
</span></span><span style="display:flex;"><span>trigram_vocab.token_freqs[:<span style="color:#ff0;font-weight:bold">3</span>]
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># [((&#39;the&#39;, &#39;time&#39;, &#39;traveller&#39;), 59),</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#  ((&#39;the&#39;, &#39;time&#39;, &#39;machine&#39;), 30),</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#  ((&#39;the&#39;, &#39;medical&#39;, &#39;man&#39;), 24)]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>æ ¹æ®ä¸‹å›¾çš„é¢‘ç‡åˆ†å¸ƒå¯è§†åŒ–ï¼Œå¯ä»¥çœ‹å‡ºï¼š
<ul>
<li>ä¸‰è€…å‡ä¸åŒç¨‹åº¦ä¸Šéµå¾ªé½<a href="https://zh.wikipedia.org/zh-cn/%E9%BD%8A%E5%A4%AB%E5%AE%9A%E5%BE%8B">æ™®å¤«å®šå¾‹</a>ï¼Œå‘ˆç°è¾ƒä¸ºæ˜¾è‘—çš„è¡°å‡</li>
<li>å°‘æ•°é«˜é¢‘è¯å äº†å…¨éƒ¨è¯­æ–™åº“çš„å¤§å¤šæ•°ï¼Œå¤§éƒ¨åˆ†å¯èƒ½å½¢å¼çš„nå…ƒç»„å¾ˆå°‘å‡ºç°</li>
</ul>
</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>freqs = [freq <span style="color:#fff;font-weight:bold">for</span> token, freq in vocab.token_freqs]
</span></span><span style="display:flex;"><span>bigram_freqs = [freq <span style="color:#fff;font-weight:bold">for</span> token, freq in bigram_vocab.token_freqs]
</span></span><span style="display:flex;"><span>trigram_freqs = [freq <span style="color:#fff;font-weight:bold">for</span> token, freq in trigram_vocab.token_freqs]
</span></span><span style="display:flex;"><span>d2l.plot([freqs, bigram_freqs, trigram_freqs], xlabel=<span style="color:#0ff;font-weight:bold">&#39;token: x&#39;</span>,
</span></span><span style="display:flex;"><span>         ylabel=<span style="color:#0ff;font-weight:bold">&#39;frequency: n(x)&#39;</span>, xscale=<span style="color:#0ff;font-weight:bold">&#39;log&#39;</span>, yscale=<span style="color:#0ff;font-weight:bold">&#39;log&#39;</span>,
</span></span><span style="display:flex;"><span>         legend=[<span style="color:#0ff;font-weight:bold">&#39;unigram&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;bigram&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;trigram&#39;</span>])
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://zh-v2.d2l.ai/_images/output_language-models-and-dataset_789d14_66_0.svg" alt="../_images/output_language-models-and-dataset_789d14_66_0.svg"  />
</p>
<h2 id="32-è¯»å–é•¿åºåˆ—æ•°æ®">3.2 è¯»å–é•¿åºåˆ—æ•°æ®<a hidden class="anchor" aria-hidden="true" href="#32-è¯»å–é•¿åºåˆ—æ•°æ®">#</a></h2>
<p>å¦‚å‰æ‰€è¿°ï¼Œåœ¨å¤„ç†é•¿åºåˆ—æ—¶ï¼Œé€šå¸¸ä»…è€ƒè™‘å¾…é¢„æµ‹æ•°æ®å‰çš„è‹¥å¹²èŠ‚ç‚¹çš„è§‚æµ‹æ•°æ®ã€‚</p>
<ul>
<li>
<p>batch_sizeï¼šæ¯ä¸ªå°æ‰¹é‡åŒæ—¶å¤„ç†çš„å­åºåˆ—æ ·æœ¬æ•°ç›®ï¼›</p>
</li>
<li>
<p>num_stepsï¼šæ¯ä¸ªå­åºåˆ—ä¸­é¢„å®šä¹‰çš„æ—¶é—´æ­¥æ•°ã€‚</p>
</li>
<li>
<p>åœ¨å°æ‰¹é‡é‡‡æ ·æ—¶ï¼Œç”±å¦‚ä¸‹ä¸¤ç§æ–¹å¼ï¼ˆå­åºåˆ—çš„æ—¶é—´æ­¥æ•°éƒ½ä¸é‡å ï¼‰</p>
</li>
<li>
<p>éšæœºåç§»é‡ï¼šä»ä¸€ä¸ªéšæœºèµ·å§‹ç‚¹å¼€å§‹æˆªå–åºåˆ—ï¼Œå¢åŠ æ¯ä¸ªepochè¿­ä»£çš„éšæœºæ€§</p>
</li>
</ul>
<p><strong>ï¼ˆ1ï¼‰éšæœºæŠ½æ ·</strong></p>
<ul>
<li>æ¯ä¸ªæ‰¹é‡æ ·æœ¬ä¹‹é—´çš„èµ·å§‹æ—¶é—´æ­¥æ•°æ— é¡ºåºå…³ç³»
<ul>
<li>e.g. ç¬¬ä¸€ä¸ªå°æ‰¹é‡çš„ç¬¬ä¸€ä¸ªåºåˆ—ä¸ç¬¬äºŒä¸ªå°æ‰¹é‡çš„ç¬¬ä¸€ä¸ªåºåˆ—æ— ç›¸é‚»çš„é¡ºåºå…³ç³»</li>
</ul>
</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> seq_data_iter_random(corpus, batch_size, num_steps):  <span style="color:#007f7f">#@save</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;ä½¿ç”¨éšæœºæŠ½æ ·ç”Ÿæˆä¸€ä¸ªå°æ‰¹é‡å­åºåˆ—&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># ä»éšæœºåç§»é‡å¼€å§‹å¯¹åºåˆ—è¿›è¡Œåˆ†åŒº(éšæœºä¸¢å¼ƒå¼€å¤´çš„å‡ ä¸ªä½ç½®æ•°æ®)ï¼ŒéšæœºèŒƒå›´åŒ…æ‹¬num_steps-1</span>
</span></span><span style="display:flex;"><span>    corpus = corpus[random.randint(<span style="color:#ff0;font-weight:bold">0</span>, num_steps - <span style="color:#ff0;font-weight:bold">1</span>):]
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># è®¡ç®—å¯ä»¥ç”Ÿæˆå¤šå°‘ä¸ªä¸é‡å çš„å­åºåˆ—(å‡å»1ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬éœ€è¦è€ƒè™‘æ ‡ç­¾)</span>
</span></span><span style="display:flex;"><span>    num_subseqs = (<span style="color:#fff;font-weight:bold">len</span>(corpus) - <span style="color:#ff0;font-weight:bold">1</span>) // num_steps
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># æ¯ä¸ªå­åºåˆ—çš„èµ·å§‹ç´¢å¼•</span>
</span></span><span style="display:flex;"><span>    initial_indices = <span style="color:#fff;font-weight:bold">list</span>(<span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">0</span>, num_subseqs * num_steps, num_steps))
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># æ‰“ä¹±åˆå§‹ç´¢å¼•</span>
</span></span><span style="display:flex;"><span>    random.shuffle(initial_indices)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> data(pos):
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># è¿”å›ä»posä½ç½®å¼€å§‹çš„é•¿åº¦ä¸ºnum_stepsçš„åºåˆ—</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> corpus[pos: pos + num_steps]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">#æ ¹æ®æ¯ä¸ªå°æ‰¹é‡åŒ…å«çš„å­åºåˆ—æ•°ï¼Œè®¡ç®—æœ‰å¤šå°‘ä¸ªæ‰¹é‡</span>
</span></span><span style="display:flex;"><span>    num_batches = num_subseqs // batch_size
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">0</span>, batch_size * num_batches, batch_size):
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># åœ¨è¿™é‡Œï¼Œæ¯ä¸ªæ‰¹é‡å†…æ‰€æœ‰å­åºåˆ—çš„èµ·å§‹ç´¢å¼•</span>
</span></span><span style="display:flex;"><span>        initial_indices_per_batch = initial_indices[i: i + batch_size]
</span></span><span style="display:flex;"><span>        X = [data(j) <span style="color:#fff;font-weight:bold">for</span> j in initial_indices_per_batch]
</span></span><span style="display:flex;"><span>        Y = [data(j + <span style="color:#ff0;font-weight:bold">1</span>) <span style="color:#fff;font-weight:bold">for</span> j in initial_indices_per_batch]
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">yield</span> torch.tensor(X), torch.tensor(Y)
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ç¤ºä¾‹</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>random_iter = seq_data_iter_random(<span style="color:#fff;font-weight:bold">list</span>(<span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">35</span>)), batch_size=<span style="color:#ff0;font-weight:bold">2</span>, num_steps=<span style="color:#ff0;font-weight:bold">5</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">next</span>(<span style="color:#fff;font-weight:bold">iter</span>(random_iter))
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># (tensor([[24, 25, 26, 27, 28],</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#          [14, 15, 16, 17, 18]]),</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#  tensor([[25, 26, 27, 28, 29],</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#          [15, 16, 17, 18, 19]]))</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">next</span>(<span style="color:#fff;font-weight:bold">iter</span>(random_iter))
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># (tensor([[ 9, 10, 11, 12, 13],</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#          [ 4,  5,  6,  7,  8]]),</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#  tensor([[10, 11, 12, 13, 14],</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#          [ 5,  6,  7,  8,  9]]))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ï¼ˆ2ï¼‰é¡ºåºåˆ†åŒº</p>
<ul>
<li>ä¿è¯ä¸¤ä¸ªç›¸é‚»çš„å°æ‰¹é‡ä¸­çš„å­åºåˆ—åœ¨åŸå§‹åºåˆ—ä¸Šä¹Ÿæ˜¯ç›¸é‚»çš„ã€‚</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> seq_data_iter_sequential(corpus, batch_size, num_steps):  <span style="color:#007f7f">#@save</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;ä½¿ç”¨é¡ºåºåˆ†åŒºç”Ÿæˆä¸€ä¸ªå°æ‰¹é‡å­åºåˆ—&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># ä»éšæœºåç§»é‡å¼€å§‹åˆ’åˆ†åºåˆ—</span>
</span></span><span style="display:flex;"><span>    offset = random.randint(<span style="color:#ff0;font-weight:bold">0</span>, num_steps)
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># ç¡®ä¿å¯ä»¥è¢«æ•´é™¤çš„tokensè¯å…ƒæ•°é‡</span>
</span></span><span style="display:flex;"><span>    num_tokens = ((<span style="color:#fff;font-weight:bold">len</span>(corpus) - offset - <span style="color:#ff0;font-weight:bold">1</span>) // batch_size) * batch_size
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># æ‰€æœ‰ä½œä¸ºç‰¹å¾çš„è¾“å…¥åºåˆ—</span>
</span></span><span style="display:flex;"><span>    Xs = torch.tensor(corpus[offset: offset + num_tokens])
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># æ‰€æœ‰çš„æ ‡ç­¾å€¼</span>
</span></span><span style="display:flex;"><span>    Ys = torch.tensor(corpus[offset + <span style="color:#ff0;font-weight:bold">1</span>: offset + <span style="color:#ff0;font-weight:bold">1</span> + num_tokens])
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># è¡Œæ•°è¡¨ç¤ºæ¯ä¸ªæ‰¹é‡åŒ…å«çš„å­åºåˆ—æ•°</span>
</span></span><span style="display:flex;"><span>    Xs, Ys = Xs.reshape(batch_size, -<span style="color:#ff0;font-weight:bold">1</span>), Ys.reshape(batch_size, -<span style="color:#ff0;font-weight:bold">1</span>)
</span></span><span style="display:flex;"><span>    num_batches = Xs.shape[<span style="color:#ff0;font-weight:bold">1</span>] // num_steps
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">0</span>, num_steps * num_batches, num_steps):
</span></span><span style="display:flex;"><span>        X = Xs[:, i: i + num_steps]
</span></span><span style="display:flex;"><span>        Y = Ys[:, i: i + num_steps]
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">yield</span> X, Y
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ç¤ºä¾‹</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>iter_seq = seq_data_iter_sequential(<span style="color:#fff;font-weight:bold">list</span>(<span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">35</span>)), batch_size=<span style="color:#ff0;font-weight:bold">2</span>, num_steps=<span style="color:#ff0;font-weight:bold">5</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">next</span>(<span style="color:#fff;font-weight:bold">iter</span>(iter_seq))
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># (tensor([[ 2,  3,  4,  5,  6],</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#          [18, 19, 20, 21, 22]]),</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#  tensor([[ 3,  4,  5,  6,  7],</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#          [19, 20, 21, 22, 23]]))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">next</span>(<span style="color:#fff;font-weight:bold">iter</span>(iter_seq))
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># (tensor([[ 7,  8,  9, 10, 11],</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#          [23, 24, 25, 26, 27]]),</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#  tensor([[ 8,  9, 10, 11, 12],</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#          [24, 25, 26, 27, 28]]))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Tipsï¼šæ— è®ºä¸Šè¿°å“ªä¸€ç§æ–¹å¼ï¼Œç”Ÿæˆçš„åºåˆ—æ ·æœ¬æ•°æ®éƒ½æ˜¯ä¸é‡å çš„ã€‚</p></blockquote>
<p><strong>æ•´åˆä¸Šè¿°è¿­ä»£æ–¹æ³•</strong></p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f"># å®šä¹‰ä¸€ä¸ªç±»ï¼Œç”Ÿæˆæ•°æ®è¿­ä»£å™¨</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> SeqDataLoader:  <span style="color:#007f7f">#@save</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;åŠ è½½åºåˆ—æ•°æ®çš„è¿­ä»£å™¨&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> __init__(<span style="color:#fff;font-weight:bold">self</span>, batch_size, num_steps, use_random_iter, max_tokens):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> use_random_iter:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">self</span>.data_iter_fn = d2l.seq_data_iter_random
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">self</span>.data_iter_fn = d2l.seq_data_iter_sequential
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># è¿”å›æ‰€æœ‰æ–‡æ¡£çš„è¯å…ƒç´¢å¼•åˆ—è¡¨ï¼Œä»¥åŠè¯è¡¨vocab</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">self</span>.corpus, <span style="color:#fff;font-weight:bold">self</span>.vocab = d2l.load_corpus_time_machine(max_tokens)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">self</span>.batch_size, <span style="color:#fff;font-weight:bold">self</span>.num_steps = batch_size, num_steps
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> __iter__(<span style="color:#fff;font-weight:bold">self</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">self</span>.data_iter_fn(<span style="color:#fff;font-weight:bold">self</span>.corpus, <span style="color:#fff;font-weight:bold">self</span>.batch_size, <span style="color:#fff;font-weight:bold">self</span>.num_steps)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># ç»¼åˆè¯è¡¨ä¸æ•°æ®è¿­ä»£å™¨</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> load_data_time_machine(batch_size, num_steps,  <span style="color:#007f7f">#@save</span>
</span></span><span style="display:flex;"><span>                           use_random_iter=<span style="color:#fff;font-weight:bold">False</span>, max_tokens=<span style="color:#ff0;font-weight:bold">10000</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;è¿”å›æ—¶å…‰æœºå™¨æ•°æ®é›†çš„è¿­ä»£å™¨å’Œè¯è¡¨&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    data_iter = SeqDataLoader(
</span></span><span style="display:flex;"><span>        batch_size, num_steps, use_random_iter, max_tokens)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> data_iter, data_iter.vocab
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="4-å¾ªç¯ç¥ç»ç½‘ç»œ">4. å¾ªç¯ç¥ç»ç½‘ç»œ<a hidden class="anchor" aria-hidden="true" href="#4-å¾ªç¯ç¥ç»ç½‘ç»œ">#</a></h1>
<ul>
<li>å¾ªç¯ç¥ç»ç½‘ç»œæ˜¯å…·æœ‰<strong>éšçŠ¶æ€</strong>çš„ç¥ç»ç½‘ç»œï¼›</li>
<li>éšçŠ¶æ€ä¸éšè—å±‚çš„æ¦‚å¿µæˆªç„¶ä¸åŒ
<ul>
<li>éšè—å±‚æ˜¯æŒ‡åœ¨ä»è¾“å…¥åˆ°è¾“å‡ºçš„è·¯å¾„ä¸Šï¼Œéšè—çš„å±‚ï¼›</li>
<li>éšçŠ¶æ€å¯ä»¥ç†è§£ä¸ºRNNä¸­çš„è®°å¿†å•å…ƒï¼Œå®ƒä¿å­˜äº†åºåˆ—ä¸­å…ˆå‰æ—¶é—´æ­¥çš„ä¿¡æ¯ï¼Œå¹¶ä¼ é€’ç»™åç»­çš„æ—¶é—´æ­¥ã€‚</li>
</ul>
</li>
</ul>
<h2 id="41-æ— éšçŠ¶æ€çš„ç¥ç»ç½‘ç»œ">4.1 æ— éšçŠ¶æ€çš„ç¥ç»ç½‘ç»œ<a hidden class="anchor" aria-hidden="true" href="#41-æ— éšçŠ¶æ€çš„ç¥ç»ç½‘ç»œ">#</a></h2>
<p>ä»¥ç®€å•çš„å•éšè—å±‚MLPä¸ºä¾‹ï¼š</p>
<ul>
<li>è¾“å…¥<strong>X</strong>ï¼Œéšè—å±‚è¾“å‡º<strong>H</strong>ï¼Œéšè—å±‚æƒé‡å‚æ•°<strong>W</strong>xhï¼Œåç½®å‚æ•°<strong>b</strong></li>
<li>è¾“å‡ºå±‚<strong>O</strong>ï¼Œæƒé‡å‚æ•°<strong>W</strong>hqï¼Œåç½®å‚æ•°<strong>b</strong></li>
</ul>
<p><img loading="lazy" src="https://raw.githubusercontent.com/lishensuo/images2/main/img01/image-20240807135451800.png" alt="image-20240807135451800"  />
</p>
<h2 id="42-æœ‰éšçŠ¶æ€çš„ç¥ç»ç½‘ç»œ">4.2 æœ‰éšçŠ¶æ€çš„ç¥ç»ç½‘ç»œ<a hidden class="anchor" aria-hidden="true" href="#42-æœ‰éšçŠ¶æ€çš„ç¥ç»ç½‘ç»œ">#</a></h2>
<p>å¯¹äºä¸€ä¸ªç‰¹å®šæ—¶é—´æ­¥é•¿çš„åºåˆ—ï¼š</p>
<ul>
<li><strong>X</strong>tæ­¥çš„è¾“å‡º(<strong>O</strong>tï¼Œè¡¨ç¤ºå¯¹äº<strong>X</strong>t+1çš„é¢„æµ‹)ï¼Œå–å†³äºå½“å‰æ—¶é—´åºåˆ—çš„éšçŠ¶æ€<strong>H</strong>tï¼›</li>
<li>è€Œå½“å‰çš„éšçŠ¶æ€<strong>H</strong>tç”±å½“å‰æ—¶é—´æ­¥çš„è¾“å…¥<strong>X</strong>tä¸å‰ä¸€ä¸ªæ—¶é—´æ­¥çš„éšçŠ¶æ€<strong>H</strong>t-1å…±åŒè®¡ç®—å¾—å‡ºã€‚</li>
</ul>
<p><img loading="lazy" src="https://raw.githubusercontent.com/lishensuo/images2/main/img01/image-20240807140351095.png" alt="image-20240807140351095"  />
</p>
<ul>
<li>å¯¹äºè¾“å…¥çš„å°æ‰¹é‡æ•°æ®ï¼Œç”±nä¸ªé•¿åº¦ä¸ºTçš„åºåˆ—æ ·æœ¬ç»„æˆã€‚è‹¥æ ·æœ¬ç‰¹å¾é•¿åº¦ä¸ºdæ—¶ï¼Œåˆ™æ¯æ¬¡è®­ç»ƒè¾“å…¥æ•°æ®ä¸º <strong>X</strong>tï¼šnÃ—d</li>
<li>åŸºäº<strong>X</strong>tçš„è¾“å…¥ï¼Œå‚ä¸<strong>H</strong>tè®¡ç®—çš„æƒé‡å‚æ•°ä¸º<strong>W</strong>xhï¼›åŸºäº<strong>H</strong>t-1éšçŠ¶æ€ï¼Œå‚ä¸<strong>H</strong>tè®¡ç®—çš„æƒé‡å‚æ•°ä¸º<strong>W</strong>hhï¼Œæ­¤å¤–è¿˜æœ‰åç½®ï¼›</li>
<li>ä»<strong>H</strong>téšçŠ¶æ€ï¼Œæœ€ç»ˆè®¡ç®—<strong>O</strong>tçš„æƒé‡å‚æ•°ä¸º<strong>W</strong>hqï¼Œä»¥åŠåç½®ã€‚</li>
</ul>
<p><img loading="lazy" src="https://raw.githubusercontent.com/lishensuo/images2/main/img01/image-20240807143437717.png" alt="image-20240807143437717"  />
</p>
<blockquote>
<p>ï¼ˆ1ï¼‰å¦‚ä¸Šå¯ä»¥çœ‹å‡ºï¼Œæœ‰éšçŠ¶æ€çš„ç¥ç»ç½‘ç»œä»å…¬å¼ä¸Šæ¥çœ‹ï¼Œä¸å•éšè—å±‚çš„ç¥ç»ç½‘ç»œéå¸¸ç±»ä¼¼ã€‚åªæ˜¯å¤šäº†ä¸€é¡¹<strong>W</strong>xhå‚æ•°çš„è®¡ç®—è¿‡ç¨‹ã€‚</p>
<p>ï¼ˆ2ï¼‰åœ¨åŒä¸€æ‰¹é‡çš„ä¸åŒæ—¶é—´èŠ‚ç‚¹è¿­ä»£æ—¶ï¼Œä»ç„¶æ˜¯ä¸Šè¿°è¿™äº›æ¨¡å‹å‚æ•°ã€‚å³æ¨¡å‹å‚æ•°çš„å¼€é”€ä¸ä¼šéšç€æ—¶é—´æ­¥çš„å¢åŠ è€Œå¢åŠ ã€‚</p></blockquote>
<ul>
<li>å¦‚ä¸‹ï¼Œæ¼”ç¤ºåŒæ—¶å¯¹ç‰¹å®šä¸€ä¸ªæ‰¹é‡å†…å¤šä¸ªå­åºåˆ—çš„ç¬¬iä¸ªè¯å…ƒçš„éšçŠ¶æ€è®¡ç®—ï¼š
<ul>
<li>è¾“å…¥çš„æ‰¹é‡åŒ…å«3æ¡å­åºåˆ—ï¼Œæ¯æ¡å­åºåˆ—ä¸­å•ä¸ªè¯å…ƒçš„ç‰¹å¾é•¿åº¦ä¸º1ï¼›</li>
<li>éšçŠ¶æ€çš„ç¥ç»å…ƒä¸ªæ•°è®¾ç½®ä¸º4ã€‚</li>
</ul>
</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> d2l <span style="color:#fff;font-weight:bold">import</span> torch <span style="color:#fff;font-weight:bold">as</span> d2l
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>X, W_xh = torch.normal(<span style="color:#ff0;font-weight:bold">0</span>, <span style="color:#ff0;font-weight:bold">1</span>, (<span style="color:#ff0;font-weight:bold">3</span>, <span style="color:#ff0;font-weight:bold">1</span>)), torch.normal(<span style="color:#ff0;font-weight:bold">0</span>, <span style="color:#ff0;font-weight:bold">1</span>, (<span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">4</span>))
</span></span><span style="display:flex;"><span>H, W_hh = torch.normal(<span style="color:#ff0;font-weight:bold">0</span>, <span style="color:#ff0;font-weight:bold">1</span>, (<span style="color:#ff0;font-weight:bold">3</span>, <span style="color:#ff0;font-weight:bold">4</span>)), torch.normal(<span style="color:#ff0;font-weight:bold">0</span>, <span style="color:#ff0;font-weight:bold">1</span>, (<span style="color:#ff0;font-weight:bold">4</span>, <span style="color:#ff0;font-weight:bold">4</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>torch.matmul(X, W_xh) + torch.matmul(H, W_hh)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="43-åŸºäºrnnçš„å­—ç¬¦çº§è¯­è¨€æ¨¡å‹">4.3 åŸºäºRNNçš„å­—ç¬¦çº§è¯­è¨€æ¨¡å‹<a hidden class="anchor" aria-hidden="true" href="#43-åŸºäºrnnçš„å­—ç¬¦çº§è¯­è¨€æ¨¡å‹">#</a></h2>
<ul>
<li>åœ¨å­—ç¬¦çº§è¯­è¨€æ¨¡å‹ä¸­ï¼Œæ–‡æœ¬è¯å…ƒä¸ºå­—ç¬¦è€Œä¸æ˜¯å•è¯ï¼›</li>
<li>å¦‚ä¸‹å¯ä»¥ç†è§£ä¸ºå°æ‰¹é‡å¤§å°ä¸º1ï¼Œæ–‡æœ¬åºåˆ—ä¸º&rsquo;machine'</li>
</ul>
<p><img loading="lazy" src="https://raw.githubusercontent.com/lishensuo/images2/main/img01/image-20240807145613774.png" alt="image-20240807145613774"  />
</p>
<h2 id="44-å›°æƒ‘åº¦">4.4 å›°æƒ‘åº¦<a hidden class="anchor" aria-hidden="true" href="#44-å›°æƒ‘åº¦">#</a></h2>
<ul>
<li>è¯­è¨€æ¨¡å‹å¤§éƒ¨åˆ†æƒ…å†µä¸‹å¯ä»¥ç†è§£ä¸º<strong>åˆ†ç±»</strong>é—®é¢˜ï¼Œå¯ä»¥åˆ©ç”¨<strong>äº¤å‰ç†µ</strong>è®¡ç®—æ¨¡å‹è¾“å…¥ä¸æ ‡ç­¾ä¹‹é—´çš„å·®å¼‚ï¼›</li>
<li>æ¨¡å‹æ€§èƒ½(æŸå¤±)å¯æ ¹æ®ä¸€ä¸ªåºåˆ—ä¸­æ‰€æœ‰è¯å…ƒ(n)çš„å¹³å‡äº¤å‰ç†µæŸå¤±æ¥è¡¡é‡ï¼›</li>
<li>å®é™…å»ºæ¨¡æ—¶ï¼Œè‡ªç„¶è¯­è¨€å¤„ç†çš„ç§‘å­¦å®¶æ›´å–œæ¬¢ä½¿ç”¨<strong>å›°æƒ‘åº¦</strong>(Perplexity)æŒ‡æ ‡ã€‚æœ¬è´¨ä¸Šåªæ˜¯å¯¹ä¸Šè¿°è¿›è¡Œ<a href="https://zh.wikipedia.org/zh-cn/%E6%8C%87%E6%95%B0%E5%87%BD%E6%95%B0">expæŒ‡æ•°è¿ç®—</a>ã€‚</li>
<li>è¯¥æŒ‡æ ‡å¯ä»¥ç†è§£ä¸ºå¯¹ä¸‹ä¸€ä¸ªè¯å…ƒçš„å®é™…é€‰æ‹©æ•°çš„è°ƒå’Œå¹³å‡æ•°ã€‚
<ul>
<li>å›°æƒ‘åº¦è¶Šä½ï¼Œè¯´æ˜æ¨¡å‹çš„é¢„æµ‹æ•ˆæœè¶Šå¥½ã€‚æœ€å¥½çš„æƒ…å†µä¸º1ï¼Œå³å®Œç¾åœ°ä¼°è®¡äº†æ ‡ç­¾è¯å…ƒï¼›</li>
<li>å¦‚æœå›°æƒ‘åº¦ä¸º k<em>k</em>ï¼Œé‚£ä¹ˆå¯ä»¥ç†è§£ä¸ºæ¨¡å‹é¢„æµ‹ä¸‹ä¸€ä¸ªè¯æ—¶çš„å€™é€‰è¯æ•°é‡å¤§è‡´ä¸º kã€‚</li>
</ul>
</li>
</ul>
<p><img loading="lazy" src="https://raw.githubusercontent.com/lishensuo/images2/main/img01/image-20240807151122573.png" alt="image-20240807151122573"  />
</p>
<h1 id="5-rnnçš„ä»é›¶å®ç°">5. RNNçš„ä»é›¶å®ç°<a hidden class="anchor" aria-hidden="true" href="#5-rnnçš„ä»é›¶å®ç°">#</a></h1>
<p>ä»é›¶å¼€å§‹åŸºäºRNNå®ç°å­—ç¬¦çº§è¯­è¨€æ¨¡å‹</p>
<ul>
<li>è¯»å–æ•°æ®é›†
<ul>
<li>batch_sizeè¡¨ç¤ºæ¯ä¸ªæ‰¹é‡åŒæ—¶è¯»å–/å¤„ç†å¤šå°‘æ¡å­åºåˆ—</li>
<li>num_stepsè¡¨ç¤ºæ¯æ¡å­åºåˆ—çš„é•¿åº¦</li>
</ul>
</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>%matplotlib inline
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> math
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> torch <span style="color:#fff;font-weight:bold">import</span> nn
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> torch.nn <span style="color:#fff;font-weight:bold">import</span> functional <span style="color:#fff;font-weight:bold">as</span> F
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> d2l <span style="color:#fff;font-weight:bold">import</span> torch <span style="color:#fff;font-weight:bold">as</span> d2l
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>batch_size, num_steps = <span style="color:#ff0;font-weight:bold">32</span>, <span style="color:#ff0;font-weight:bold">35</span>
</span></span><span style="display:flex;"><span>train_iter, vocab = d2l.load_data_time_machine(batch_size, num_steps)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="51-ç‹¬çƒ­ç¼–ç ">5.1 ç‹¬çƒ­ç¼–ç <a hidden class="anchor" aria-hidden="true" href="#51-ç‹¬çƒ­ç¼–ç ">#</a></h2>
<ul>
<li>æ¯ä¸ªè¯å…ƒç»è½¬æ¢åè¡¨ç¤ºä¸ºä¸€ä¸ªæ•°å­—ç´¢å¼•ï¼Œç„¶åç»ç‹¬çƒ­ç¼–ç è¡¨ç¤ºä¸ºç‰¹å¾å‘é‡ï¼›</li>
<li>è‹¥è¯è¡¨çš„å”¯ä¸€è¯å…ƒæœ‰Nä¸ª(<code>len(vocab)</code>)ï¼Œåˆ™è¯å…ƒç´¢å¼•èŒƒå›´æ˜¯ 0~N-1ï¼Œå…¶ç‰¹å¾å‘é‡é•¿åº¦ä¸ºN</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>F.one_hot(torch.tensor([<span style="color:#ff0;font-weight:bold">0</span>, <span style="color:#ff0;font-weight:bold">2</span>]), <span style="color:#fff;font-weight:bold">len</span>(vocab)).shape
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># torch.Size([2, 28])</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ç‰¹å¾ç¼–ç å‰ï¼Œå°æ‰¹é‡è¾“å…¥å½¢çŠ¶ä¸ºäºŒç»´å¼ é‡ï¼ˆæ‰¹é‡å¤§å°ï¼Œæ—¶é—´æ­¥æ•°/åºåˆ—é•¿åº¦ï¼‰</li>
<li>ç¼–ç ååˆ™ä¸º3ç»´å¼ é‡ï¼Œéœ€è¦å†è°ƒæ•´ä¸‹ç»´åº¦çš„é¡ºåºï¼Œæ–¹ä¾¿åç»­æ“ä½œã€‚ï¼ˆæ—¶é—´æ­¥æ•°/åºåˆ—é•¿åº¦ï¼Œæ‰¹é‡å¤§å°ï¼Œè¯è¡¨å¤§å°/ç‰¹å¾é•¿åº¦ï¼‰</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f"># æ‰¹é‡å¤§å°ä¸º2ï¼Œåºåˆ—é•¿åº¦ä¸º5</span>
</span></span><span style="display:flex;"><span>X = torch.arange(<span style="color:#ff0;font-weight:bold">10</span>).reshape((<span style="color:#ff0;font-weight:bold">2</span>, <span style="color:#ff0;font-weight:bold">5</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#X.Tè½¬ç½®æ“ä½œï¼Œå°†åºåˆ—é•¿åº¦ç»´æ•°æ”¾åœ¨å‰é¢ä¹‹åï¼Œå†è¿›è¡Œç‹¬çƒ­ç¼–ç </span>
</span></span><span style="display:flex;"><span>F.one_hot(X.T, <span style="color:#ff0;font-weight:bold">28</span>).shape 
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># torch.Size([5, 2, 28])</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="52-åˆå§‹åŒ–æ¨¡å‹å‚æ•°">5.2 åˆå§‹åŒ–æ¨¡å‹å‚æ•°<a hidden class="anchor" aria-hidden="true" href="#52-åˆå§‹åŒ–æ¨¡å‹å‚æ•°">#</a></h2>
<ul>
<li>RNNæ¨¡å‹å‚æ•°å¯å‚è€ƒ4.2éƒ¨åˆ†ä»‹ç»ï¼Œä¸»è¦åˆ†ä¸ºéšçŠ¶æ€å‚æ•°ä¸è¾“å‡ºå±‚å‚æ•°</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> get_params(vocab_size, num_hiddens, device):
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># è¾“å…¥ä¸è¾“å‡ºçš„è¯å…ƒçš„ç‰¹å¾å‘é‡é•¿åº¦ç›¸åŒ</span>
</span></span><span style="display:flex;"><span>    num_inputs = num_outputs = vocab_size
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> normal(shape):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> torch.randn(size=shape, device=device) * <span style="color:#ff0;font-weight:bold">0.01</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># éšè—å±‚å‚æ•°</span>
</span></span><span style="display:flex;"><span>    W_xh = normal((num_inputs, num_hiddens))
</span></span><span style="display:flex;"><span>    W_hh = normal((num_hiddens, num_hiddens))
</span></span><span style="display:flex;"><span>    b_h = torch.zeros(num_hiddens, device=device)
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># è¾“å‡ºå±‚å‚æ•°ï¼Œnum_outputsç­‰äºè¯å…ƒç±»åˆ«æ•°</span>
</span></span><span style="display:flex;"><span>    W_hq = normal((num_hiddens, num_outputs))
</span></span><span style="display:flex;"><span>    b_q = torch.zeros(num_outputs, device=device)
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># é™„åŠ æ¢¯åº¦</span>
</span></span><span style="display:flex;"><span>    params = [W_xh, W_hh, b_h, W_hq, b_q]
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> param in params:
</span></span><span style="display:flex;"><span>        param.requires_grad_(<span style="color:#fff;font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> params
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="53-rnnæ¨¡å‹">5.3 RNNæ¨¡å‹<a hidden class="anchor" aria-hidden="true" href="#53-rnnæ¨¡å‹">#</a></h2>
<ul>
<li>åˆå§‹åŒ–éšçŠ¶æ€ï¼Œå½¢çŠ¶ä¸ºï¼ˆæ‰¹é‡å¤§å°ï¼Œéšè—å•å…ƒæ•°ï¼‰</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> init_rnn_state(batch_size, num_hiddens, device):
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> (torch.zeros((batch_size, num_hiddens), device=device), )
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># è¿™é‡Œè¿”å›å…ƒç»„ï¼Œå› ä¸ºåé¢ç« èŠ‚çš„éšçŠ¶æ€ä¼šæœ‰å¤šä¸ªå˜é‡ï¼ˆLSTMï¼‰</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>å®šä¹‰å‰å‘ä¼ æ’­å‡½æ•°ï¼Œè¿”å›ä¸€è½®batchçš„é¢„æµ‹ç»“æœï¼ˆæ‰¹é‡å¤§å°Ã—åºåˆ—é•¿åº¦ï¼Œè¯è¡¨å¤§å°ï¼‰ï¼Œä»¥åŠæ›´æ–°çš„éšçŠ¶æ€
<ul>
<li>è¾“å…¥inputsä¸ºä¸Šè¿°5.1æ‰€ä»‹ç»çš„ä¸‰ç»´å¼ é‡</li>
</ul>
</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> rnn(inputs, state, params):
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># inputsçš„å½¢çŠ¶ï¼š(æ—¶é—´æ­¥æ•°é‡ï¼Œæ‰¹é‡å¤§å°ï¼Œè¯è¡¨å¤§å°)</span>
</span></span><span style="display:flex;"><span>    W_xh, W_hh, b_h, W_hq, b_q = params
</span></span><span style="display:flex;"><span>    H, = state
</span></span><span style="display:flex;"><span>    outputs = []
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># é€æ—¶é—´æ­¥è¿­ä»£ï¼šXçš„å½¢çŠ¶ä¸º(æ‰¹é‡å¤§å°ï¼Œè¯è¡¨å¤§å°)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> X in inputs:
</span></span><span style="display:flex;"><span>        H = torch.tanh(torch.mm(X, W_xh) + torch.mm(H, W_hh) + b_h)
</span></span><span style="display:flex;"><span>        Y = torch.mm(H, W_hq) + b_q
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># Yå½¢çŠ¶ï¼š(æ‰¹é‡å¤§å°ï¼Œè¯è¡¨å¤§å°)</span>
</span></span><span style="display:flex;"><span>        outputs.append(Y)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> torch.cat(outputs, dim=<span style="color:#ff0;font-weight:bold">0</span>), (H,) 
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#çºµå‘å åŠ ï¼Œå¢åŠ è¡Œæ•°ï¼Œåˆ—æ•°ä¸å˜ï¼Œç»´åº¦ä¸å˜</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>å®šä¹‰æ¨¡å‹çš„ç±»</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> RNNModelScratch: <span style="color:#007f7f">#@save</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;ä»é›¶å¼€å§‹å®ç°çš„å¾ªç¯ç¥ç»ç½‘ç»œæ¨¡å‹&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> __init__(<span style="color:#fff;font-weight:bold">self</span>, vocab_size, num_hiddens, device,
</span></span><span style="display:flex;"><span>                 get_params, init_state, forward_fn):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">self</span>.vocab_size, <span style="color:#fff;font-weight:bold">self</span>.num_hiddens = vocab_size, num_hiddens
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">self</span>.params = get_params(vocab_size, num_hiddens, device)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">self</span>.init_state, <span style="color:#fff;font-weight:bold">self</span>.forward_fn = init_state, forward_fn
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> __call__(<span style="color:#fff;font-weight:bold">self</span>, X, state):
</span></span><span style="display:flex;"><span>        X = F.one_hot(X.T, <span style="color:#fff;font-weight:bold">self</span>.vocab_size).type(torch.float32)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">self</span>.forward_fn(X, state, <span style="color:#fff;font-weight:bold">self</span>.params)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> begin_state(<span style="color:#fff;font-weight:bold">self</span>, batch_size, device):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">self</span>.init_state(batch_size, <span style="color:#fff;font-weight:bold">self</span>.num_hiddens, device)
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ç¤ºä¾‹è¾“å‡º</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>num_hiddens = <span style="color:#ff0;font-weight:bold">512</span>
</span></span><span style="display:flex;"><span>net = RNNModelScratch(<span style="color:#fff;font-weight:bold">len</span>(vocab), num_hiddens, d2l.try_gpu(), get_params,
</span></span><span style="display:flex;"><span>                      init_rnn_state, rnn)
</span></span><span style="display:flex;"><span>state = net.begin_state(X.shape[<span style="color:#ff0;font-weight:bold">0</span>], d2l.try_gpu())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># æ‰¹é‡åŒ…å«çš„åºåˆ—æ•°ä¸º2ï¼Œåºåˆ—é•¿åº¦ä¸º5</span>
</span></span><span style="display:flex;"><span>X = torch.arange(<span style="color:#ff0;font-weight:bold">10</span>).reshape((<span style="color:#ff0;font-weight:bold">2</span>, <span style="color:#ff0;font-weight:bold">5</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Y, new_state = net(X.to(d2l.try_gpu()), state)
</span></span><span style="display:flex;"><span>Y.shape
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># torch.Size([10, 28])</span>
</span></span><span style="display:flex;"><span>new_state[<span style="color:#ff0;font-weight:bold">0</span>].shape <span style="color:#007f7f">#æ‰¹é‡å†…æ¯ä¸ªå­åºåˆ—æœ€åä¸€ä¸ªæ—¶é—´æ­¥çš„éšçŠ¶æ€</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># torch.Size([2, 512])</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="54-é¢„æµ‹">5.4 é¢„æµ‹<a hidden class="anchor" aria-hidden="true" href="#54-é¢„æµ‹">#</a></h2>
<ul>
<li>prefixï¼šåŒ…å«è‹¥å¹²è¯å…ƒçš„åˆå§‹æ–‡æœ¬</li>
<li>num_predsï¼šå¾€åé¢„æµ‹å¤šå°‘ä¸ªè¯å…ƒ</li>
<li>åœ¨é¢„æµ‹è¿‡ç¨‹ä¸­ï¼Œé¦–å…ˆé€ä¸ªéå†ç»™å®šçš„åˆå§‹è¯å…ƒï¼Œä½†ä¸åšé¢„æµ‹ï¼Œä»…ç”¨äºæ›´æ–°éšçŠ¶æ€ã€‚</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> predict_ch8(prefix, num_preds, net, vocab, device):  <span style="color:#007f7f">#@save</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;åœ¨prefixåé¢ç”Ÿæˆæ–°å­—ç¬¦&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># batch_size=1è¡¨ç¤ºå•æ‰¹é‡é€ä¸ªé¢„æµ‹</span>
</span></span><span style="display:flex;"><span>    state = net.begin_state(batch_size=<span style="color:#ff0;font-weight:bold">1</span>, device=device)
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># é¦–å…ˆå°†prefixçš„ç¬¬ä¸€ä¸ªè¯å…ƒåŠ å…¥åˆ°outputsä¸­</span>
</span></span><span style="display:flex;"><span>    outputs = [vocab[prefix[<span style="color:#ff0;font-weight:bold">0</span>]]]
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># å–outputsé‡Œæœ€æ–°çš„ä¸€ä¸ªè¯å…ƒï¼Œä½œä¸ºé¢„æµ‹ä¸‹ä¸€ä¸ªè¯å…ƒçš„è¾“å…¥</span>
</span></span><span style="display:flex;"><span>    get_input = <span style="color:#fff;font-weight:bold">lambda</span>: torch.tensor([outputs[-<span style="color:#ff0;font-weight:bold">1</span>]], device=device).reshape((<span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">1</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> y in prefix[<span style="color:#ff0;font-weight:bold">1</span>:]:  <span style="color:#007f7f"># é¢„çƒ­æœŸ</span>
</span></span><span style="display:flex;"><span>        _, state = net(get_input(), state)
</span></span><span style="display:flex;"><span>        outputs.append(vocab[y]) <span style="color:#007f7f">#ä¼ å…¥çœŸå®å€¼</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> _ in <span style="color:#fff;font-weight:bold">range</span>(num_preds):  <span style="color:#007f7f"># é¢„æµ‹num_predsæ­¥</span>
</span></span><span style="display:flex;"><span>        y, state = net(get_input(), state)
</span></span><span style="display:flex;"><span>        outputs.append(<span style="color:#fff;font-weight:bold">int</span>(y.argmax(dim=<span style="color:#ff0;font-weight:bold">1</span>).reshape(<span style="color:#ff0;font-weight:bold">1</span>))) <span style="color:#007f7f">#ä¼ å…¥é¢„æµ‹å€¼</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#39;&#39;</span>.join([vocab.idx_to_token[i] <span style="color:#fff;font-weight:bold">for</span> i in outputs])
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ç¤ºä¾‹</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>predict_ch8(<span style="color:#0ff;font-weight:bold">&#39;time traveller &#39;</span>, <span style="color:#ff0;font-weight:bold">10</span>, net, vocab, d2l.try_gpu())
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># &#39;time traveller xejnnnnnnn&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="55-æ¢¯åº¦å‰ªè£">5.5 æ¢¯åº¦å‰ªè£<a hidden class="anchor" aria-hidden="true" href="#55-æ¢¯åº¦å‰ªè£">#</a></h2>
<ul>
<li>å¯¹äºé•¿åº¦ä¸ºTçš„åºåˆ—ï¼Œè®­ç»ƒæ—¶ä¼šæ‰§è¡ŒTæ¬¡çŸ©é˜µä¹˜æ³•ï¼Œæ¥è¿›è¡Œåå‘ä¼ æ’­ã€æ›´æ–°æ¢¯åº¦ã€‚</li>
<li>è¿™å¯¹äºè¾ƒé•¿çš„åºåˆ—ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ¢¯åº¦çˆ†ç‚¸ï¼Œæ¨¡å‹æ— æ³•æ”¶æ•›ã€‚</li>
<li>æ­¤æ—¶ï¼Œå¯ä»¥é€šè¿‡æ¢¯åº¦å‰ªè£ï¼Œå°†å‚æ•°çš„æ¢¯åº¦çš„èŒƒæ•°è®¾ç½®ä¸€ä¸ªä¸Šé™Î¸ï¼ˆä¸æ”¹å˜æ–¹å‘ï¼‰ã€‚</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> grad_clipping(net, theta):  <span style="color:#007f7f">#@save</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;è£å‰ªæ¢¯åº¦&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">isinstance</span>(net, nn.Module):
</span></span><span style="display:flex;"><span>        params = [p <span style="color:#fff;font-weight:bold">for</span> p in net.parameters() <span style="color:#fff;font-weight:bold">if</span> p.requires_grad]
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>        params = net.params
</span></span><span style="display:flex;"><span>    norm = torch.sqrt(<span style="color:#fff;font-weight:bold">sum</span>(torch.sum((p.grad ** <span style="color:#ff0;font-weight:bold">2</span>)) <span style="color:#fff;font-weight:bold">for</span> p in params))
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">#è‹¥èŒƒæ•°é•¿åº¦å¤§äºÎ¸ï¼Œå°±è®¾ç½®å…¶å€¼ä¸ºÎ¸</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> norm &gt; theta:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> param in params:
</span></span><span style="display:flex;"><span>            param.grad[:] *= theta / norm
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="56-è®­ç»ƒ">5.6 è®­ç»ƒ<a hidden class="anchor" aria-hidden="true" href="#56-è®­ç»ƒ">#</a></h2>
<ul>
<li>åœ¨3.2å°èŠ‚ä¸­ï¼Œå­¦ä¹ äº†ä¸¤ç§å°æ‰¹é‡åºåˆ—æ ·æœ¬è¿­ä»£æ–¹æ³•ï¼šï¼ˆ1ï¼‰é¡ºåºåˆ†åŒºï¼›ï¼ˆ2ï¼‰éšæœºæŠ½æ ·</li>
<li>å¯¹äºé¡ºåºåˆ†åŒºï¼Œç›¸é‚»ä¸¤ä¸ªbatch iterationä¸­ï¼Œå¯¹åº”çš„ç¬¬iä¸ªå­åºåˆ—çš„ä½åºä¹Ÿæ˜¯ç›¸é‚»çš„ã€‚
<ul>
<li>éšçŠ¶æ€ä»…éœ€è¦åœ¨åˆšå¼€å§‹æ—¶åˆå§‹åŒ–ä¸€æ¬¡ã€‚åœ¨åé¢çš„å¤šè½®å°æ‰¹é‡è®­ç»ƒæ—¶ï¼Œå¯ä»¥ç»§æ‰¿ã€‚</li>
<li>ä¸ºå‡å°‘è®¡ç®—é‡ï¼Œåœ¨å¤„ç†æ¯ä¸ªæ‰¹é‡æ•°æ®å‰ï¼Œå¯¹éšçŠ¶æ€å‚æ•°æ¢¯åº¦åˆ†ç¦»ã€‚</li>
</ul>
</li>
<li>å¯¹äºéšæœºæŠ½æ ·ï¼Œç›¸é‚»ä¸¤ä¸ªbatch iterationçš„åºåˆ—æ ·æœ¬æ— ç¡®å®šå…³ç³»ï¼ˆæ›´å¸¸ç”¨äº›ï¼‰
<ul>
<li>éšçŠ¶æ€åœ¨æ¯ä¸ªbatch iterationæ—¶ï¼Œéƒ½éœ€è¦éšæœºåˆå§‹åŒ–ï¼ˆå…¶æƒé‡å‚æ•°æ˜¯æŒç»­æ›´æ–°çš„ï¼‰ã€‚</li>
</ul>
</li>
<li>å¦‚ä¸‹ä¸ºè®­ç»ƒä¸€ä¸ªepochçš„ä»£ç </li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f">#@save</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> train_epoch_ch8(net, train_iter, loss, updater, device, use_random_iter):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;è®­ç»ƒç½‘ç»œä¸€ä¸ªè¿­ä»£å‘¨æœŸï¼ˆå®šä¹‰è§ç¬¬8ç« ï¼‰&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    state, timer = <span style="color:#fff;font-weight:bold">None</span>, d2l.Timer()
</span></span><span style="display:flex;"><span>    metric = d2l.Accumulator(<span style="color:#ff0;font-weight:bold">2</span>)  <span style="color:#007f7f"># è®­ç»ƒæŸå¤±ä¹‹å’Œ,è¯å…ƒæ•°é‡</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> X, Y in train_iter:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> state is <span style="color:#fff;font-weight:bold">None</span> or use_random_iter:
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># åœ¨ç¬¬ä¸€æ¬¡è¿­ä»£æˆ–ä½¿ç”¨éšæœºæŠ½æ ·æ—¶åˆå§‹åŒ–state</span>
</span></span><span style="display:flex;"><span>            state = net.begin_state(batch_size=X.shape[<span style="color:#ff0;font-weight:bold">0</span>], device=device)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">isinstance</span>(net, nn.Module) and not <span style="color:#fff;font-weight:bold">isinstance</span>(state, <span style="color:#fff;font-weight:bold">tuple</span>):
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f"># stateå¯¹äºnn.GRUæ˜¯ä¸ªå¼ é‡</span>
</span></span><span style="display:flex;"><span>                state.detach_()
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f"># stateå¯¹äºnn.LSTMæˆ–å¯¹äºæˆ‘ä»¬ä»é›¶å¼€å§‹å®ç°çš„æ¨¡å‹æ˜¯ä¸ªå¼ é‡</span>
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">for</span> s in state:
</span></span><span style="display:flex;"><span>                    s.detach_()
</span></span><span style="display:flex;"><span>        y = Y.T.reshape(-<span style="color:#ff0;font-weight:bold">1</span>)
</span></span><span style="display:flex;"><span>        X, y = X.to(device), y.to(device)
</span></span><span style="display:flex;"><span>        y_hat, state = net(X, state)
</span></span><span style="display:flex;"><span>        l = loss(y_hat, y.long()).mean() <span style="color:#007f7f"># yè½¬ä¸ºé•¿æ•´å‹(64ä½æ•´æ•°)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">isinstance</span>(updater, torch.optim.Optimizer):
</span></span><span style="display:flex;"><span>            updater.zero_grad()
</span></span><span style="display:flex;"><span>            l.backward()
</span></span><span style="display:flex;"><span>            grad_clipping(net, <span style="color:#ff0;font-weight:bold">1</span>)
</span></span><span style="display:flex;"><span>            updater.step()
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>            l.backward()
</span></span><span style="display:flex;"><span>            grad_clipping(net, <span style="color:#ff0;font-weight:bold">1</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># å› ä¸ºå·²ç»è°ƒç”¨äº†meanå‡½æ•°</span>
</span></span><span style="display:flex;"><span>            updater(batch_size=<span style="color:#ff0;font-weight:bold">1</span>)
</span></span><span style="display:flex;"><span>        metric.add(l * y.numel(), y.numel())
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> math.exp(metric[<span style="color:#ff0;font-weight:bold">0</span>] / metric[<span style="color:#ff0;font-weight:bold">1</span>]), metric[<span style="color:#ff0;font-weight:bold">1</span>] / timer.stop()
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>å¦‚ä¸‹ä¸ºè®­ç»ƒçš„æœ€ç»ˆå½¢å¼</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f">#@save</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> train_ch8(net, train_iter, vocab, lr, num_epochs, device,
</span></span><span style="display:flex;"><span>              use_random_iter=<span style="color:#fff;font-weight:bold">False</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;è®­ç»ƒæ¨¡å‹ï¼ˆå®šä¹‰è§ç¬¬8ç« ï¼‰&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    loss = nn.CrossEntropyLoss()
</span></span><span style="display:flex;"><span>    animator = d2l.Animator(xlabel=<span style="color:#0ff;font-weight:bold">&#39;epoch&#39;</span>, ylabel=<span style="color:#0ff;font-weight:bold">&#39;perplexity&#39;</span>,
</span></span><span style="display:flex;"><span>                            legend=[<span style="color:#0ff;font-weight:bold">&#39;train&#39;</span>], xlim=[<span style="color:#ff0;font-weight:bold">10</span>, num_epochs])
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># åˆå§‹åŒ–</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">isinstance</span>(net, nn.Module):
</span></span><span style="display:flex;"><span>        updater = torch.optim.SGD(net.parameters(), lr)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>        updater = <span style="color:#fff;font-weight:bold">lambda</span> batch_size: d2l.sgd(net.params, lr, batch_size)
</span></span><span style="display:flex;"><span>    predict = <span style="color:#fff;font-weight:bold">lambda</span> prefix: predict_ch8(prefix, <span style="color:#ff0;font-weight:bold">50</span>, net, vocab, device)
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># è®­ç»ƒå’Œé¢„æµ‹</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> epoch in <span style="color:#fff;font-weight:bold">range</span>(num_epochs):
</span></span><span style="display:flex;"><span>        ppl, speed = train_epoch_ch8(
</span></span><span style="display:flex;"><span>            net, train_iter, loss, updater, device, use_random_iter)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (epoch + <span style="color:#ff0;font-weight:bold">1</span>) % <span style="color:#ff0;font-weight:bold">10</span> == <span style="color:#ff0;font-weight:bold">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">print</span>(predict(<span style="color:#0ff;font-weight:bold">&#39;time traveller&#39;</span>))
</span></span><span style="display:flex;"><span>            animator.add(epoch + <span style="color:#ff0;font-weight:bold">1</span>, [ppl])
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#39;å›°æƒ‘åº¦ </span><span style="color:#0ff;font-weight:bold">{</span>ppl<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.1f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">, </span><span style="color:#0ff;font-weight:bold">{</span>speed<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.1f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold"> è¯å…ƒ/ç§’ </span><span style="color:#0ff;font-weight:bold">{</span><span style="color:#fff;font-weight:bold">str</span>(device)<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(predict(<span style="color:#0ff;font-weight:bold">&#39;time traveller&#39;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(predict(<span style="color:#0ff;font-weight:bold">&#39;traveller&#39;</span>))
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>å®é™…è®­ç»ƒ</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f">## è®­ç»ƒ--é¡ºåºåˆ†åŒºï¼ˆä¸‹å›¾å·¦ï¼‰</span>
</span></span><span style="display:flex;"><span>num_epochs, lr = <span style="color:#ff0;font-weight:bold">500</span>, <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>train_ch8(net, train_iter, vocab, lr, num_epochs, d2l.try_gpu())
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># å›°æƒ‘åº¦ 1.0, 38769.2 è¯å…ƒ/ç§’ cuda:0</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># time travelleryou can show black is white by argument said filby</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># travelleryou can show black is white by argument said filby</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">## è®­ç»ƒ--éšæœºæŠ½æ ·ï¼ˆä¸‹å›¾å³ï¼‰</span>
</span></span><span style="display:flex;"><span>net = RNNModelScratch(<span style="color:#fff;font-weight:bold">len</span>(vocab), num_hiddens, d2l.try_gpu(), get_params,
</span></span><span style="display:flex;"><span>                      init_rnn_state, rnn)
</span></span><span style="display:flex;"><span>train_ch8(net, train_iter, vocab, lr, num_epochs, d2l.try_gpu(),
</span></span><span style="display:flex;"><span>          use_random_iter=<span style="color:#fff;font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># å›°æƒ‘åº¦ 1.5, 37930.8 è¯å…ƒ/ç§’ cuda:0</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># time travellerit s against reason said filbywas allaing the time</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># travellerit s against reason said filbywas allaing the time</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://raw.githubusercontent.com/lishensuo/images2/main/img01/image-20240807190952553.png" alt="image-20240807190952553"  />
</p>
<h1 id="6-rnnçš„ç®€æ´å®ç°">6. RNNçš„ç®€æ´å®ç°<a hidden class="anchor" aria-hidden="true" href="#6-rnnçš„ç®€æ´å®ç°">#</a></h1>
<ul>
<li>å‡†å¤‡æ•°æ®</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> torch <span style="color:#fff;font-weight:bold">import</span> nn
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> torch.nn <span style="color:#fff;font-weight:bold">import</span> functional <span style="color:#fff;font-weight:bold">as</span> F
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> d2l <span style="color:#fff;font-weight:bold">import</span> torch <span style="color:#fff;font-weight:bold">as</span> d2l
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>batch_size, num_steps = <span style="color:#ff0;font-weight:bold">32</span>, <span style="color:#ff0;font-weight:bold">35</span>
</span></span><span style="display:flex;"><span>train_iter, vocab = d2l.load_data_time_machine(batch_size, num_steps)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="61-å®šä¹‰æ¨¡å‹">6.1 å®šä¹‰æ¨¡å‹<a hidden class="anchor" aria-hidden="true" href="#61-å®šä¹‰æ¨¡å‹">#</a></h2>
<ul>
<li>åŸºäºtorchçš„<code>nn.RNN</code>ï¼Œå®šä¹‰ä¸€ä¸ªå…·æœ‰256ä¸ªéšè—å•å…ƒçš„å•éšè—å±‚ï¼Œå…¶ä¸æ¶‰åŠè¾“å‡ºå±‚çš„è®¡ç®—</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>num_hiddens = <span style="color:#ff0;font-weight:bold">256</span>
</span></span><span style="display:flex;"><span>rnn_layer = nn.RNN(<span style="color:#fff;font-weight:bold">len</span>(vocab), num_hiddens)
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>åˆå§‹åŒ–éšçŠ¶æ€ï¼Œå½¢çŠ¶ä¸ºï¼ˆéšè—å±‚æ•°ï¼Œæ‰¹é‡å¤§å°ï¼Œéšè—å•å…ƒæ•°ï¼‰</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>state = torch.zeros((<span style="color:#ff0;font-weight:bold">1</span>, batch_size, num_hiddens))
</span></span><span style="display:flex;"><span>state.shape
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># torch.Size([1, 32, 256])</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>æ¨¡æ‹Ÿè®¡ç®—ï¼Œæ›´æ–°éšçŠ¶æ€
<ul>
<li>å¦‚ä¸‹çš„Yè¡¨ç¤ºï¼Œæ‰€æœ‰æ‰¹é‡çš„å­åºåˆ—çš„æœ€åä¸€å±‚çš„éšçŠ¶æ€ï¼ˆä¸€èˆ¬åé¢éœ€è¦å†æ¥MLPé¢„æµ‹<strong>O</strong>tè¾“å‡ºï¼‰</li>
<li>state_newè¡¨ç¤ºæ‰€æœ‰æ‰¹é‡çš„å­åºåˆ—çš„æœ€åä¸€æ­¥çš„éšçŠ¶æ€</li>
</ul>
</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>X = torch.rand(size=(num_steps, batch_size, <span style="color:#fff;font-weight:bold">len</span>(vocab)))
</span></span><span style="display:flex;"><span>Y, state_new = rnn_layer(X, state)
</span></span><span style="display:flex;"><span>Y.shape, state_new.shape
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># (torch.Size([35, 32, 256]), torch.Size([1, 32, 256]))</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 35ä¸ºåºåˆ—é•¿åº¦</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 32ä¸ºæ‰¹é‡å¤§å°</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 256 éšè—å±‚å•å…ƒæ•°</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>å®šä¹‰ä¸€ä¸ªå®Œæ•´çš„RNNModelç±»</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f">#@save</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> RNNModel(nn.Module):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;å¾ªç¯ç¥ç»ç½‘ç»œæ¨¡å‹&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> __init__(<span style="color:#fff;font-weight:bold">self</span>, rnn_layer, vocab_size, **kwargs):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">super</span>(RNNModel, <span style="color:#fff;font-weight:bold">self</span>).__init__(**kwargs)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">self</span>.rnn = rnn_layer
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">self</span>.vocab_size = vocab_size
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">self</span>.num_hiddens = <span style="color:#fff;font-weight:bold">self</span>.rnn.hidden_size
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># å¦‚æœRNNæ˜¯åŒå‘çš„ï¼ˆä¹‹åå°†ä»‹ç»ï¼‰ï¼Œnum_directionsåº”è¯¥æ˜¯2ï¼Œå¦åˆ™åº”è¯¥æ˜¯1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> not <span style="color:#fff;font-weight:bold">self</span>.rnn.bidirectional:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">self</span>.num_directions = <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">self</span>.linear = nn.Linear(<span style="color:#fff;font-weight:bold">self</span>.num_hiddens, <span style="color:#fff;font-weight:bold">self</span>.vocab_size)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">self</span>.num_directions = <span style="color:#ff0;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">self</span>.linear = nn.Linear(<span style="color:#fff;font-weight:bold">self</span>.num_hiddens * <span style="color:#ff0;font-weight:bold">2</span>, <span style="color:#fff;font-weight:bold">self</span>.vocab_size)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> forward(<span style="color:#fff;font-weight:bold">self</span>, inputs, state):
</span></span><span style="display:flex;"><span>        X = F.one_hot(inputs.T.long(), <span style="color:#fff;font-weight:bold">self</span>.vocab_size)
</span></span><span style="display:flex;"><span>        X = X.to(torch.float32)
</span></span><span style="display:flex;"><span>        Y, state = <span style="color:#fff;font-weight:bold">self</span>.rnn(X, state)
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># å…¨è¿æ¥å±‚é¦–å…ˆå°†Yçš„å½¢çŠ¶æ”¹ä¸º(æ—¶é—´æ­¥æ•°*æ‰¹é‡å¤§å°,éšè—å•å…ƒæ•°)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># å®ƒçš„è¾“å‡ºå½¢çŠ¶æ˜¯(æ—¶é—´æ­¥æ•°*æ‰¹é‡å¤§å°,è¯è¡¨å¤§å°)ã€‚</span>
</span></span><span style="display:flex;"><span>        output = <span style="color:#fff;font-weight:bold">self</span>.linear(Y.reshape((-<span style="color:#ff0;font-weight:bold">1</span>, Y.shape[-<span style="color:#ff0;font-weight:bold">1</span>])))
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> output, state
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> begin_state(<span style="color:#fff;font-weight:bold">self</span>, device, batch_size=<span style="color:#ff0;font-weight:bold">1</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> not <span style="color:#fff;font-weight:bold">isinstance</span>(<span style="color:#fff;font-weight:bold">self</span>.rnn, nn.LSTM):
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># nn.GRUä»¥å¼ é‡ä½œä¸ºéšçŠ¶æ€</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span>  torch.zeros((<span style="color:#fff;font-weight:bold">self</span>.num_directions * <span style="color:#fff;font-weight:bold">self</span>.rnn.num_layers,
</span></span><span style="display:flex;"><span>                                 batch_size, <span style="color:#fff;font-weight:bold">self</span>.num_hiddens),
</span></span><span style="display:flex;"><span>                                device=device)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># nn.LSTMä»¥å…ƒç»„ä½œä¸ºéšçŠ¶æ€</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> (torch.zeros((
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">self</span>.num_directions * <span style="color:#fff;font-weight:bold">self</span>.rnn.num_layers,
</span></span><span style="display:flex;"><span>                batch_size, <span style="color:#fff;font-weight:bold">self</span>.num_hiddens), device=device),
</span></span><span style="display:flex;"><span>                    torch.zeros((
</span></span><span style="display:flex;"><span>                        <span style="color:#fff;font-weight:bold">self</span>.num_directions * <span style="color:#fff;font-weight:bold">self</span>.rnn.num_layers,
</span></span><span style="display:flex;"><span>                        batch_size, <span style="color:#fff;font-weight:bold">self</span>.num_hiddens), device=device))
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="62-è®­ç»ƒä¸é¢„æµ‹">6.2 è®­ç»ƒä¸é¢„æµ‹<a hidden class="anchor" aria-hidden="true" href="#62-è®­ç»ƒä¸é¢„æµ‹">#</a></h2>
<ul>
<li>è®­ç»ƒå‡½æ•°ä»å‚è€ƒ5.6å°èŠ‚</li>
<li>å®ä¾‹åŒ–æ¨¡å‹</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>device = d2l.try_gpu()
</span></span><span style="display:flex;"><span>net = RNNModel(rnn_layer, vocab_size=<span style="color:#fff;font-weight:bold">len</span>(vocab))
</span></span><span style="display:flex;"><span>net = net.to(device)
</span></span><span style="display:flex;"><span>d2l.predict_ch8(<span style="color:#0ff;font-weight:bold">&#39;time traveller&#39;</span>, <span style="color:#ff0;font-weight:bold">10</span>, net, vocab, device)
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># &#39;time travellerpppwllllll&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>è®­ç»ƒæ¨¡å‹</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>num_epochs, lr = <span style="color:#ff0;font-weight:bold">500</span>, <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>d2l.train_ch8(net, train_iter, vocab, lr, num_epochs, device)
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># perplexity 1.3, 255236.1 tokens/sec on cuda:0</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># time traveller but now you be in aly has we mave the gratienttan</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># travellerit s ala to be accupted is an absolute procimind a</span>
</span></span></code></pre></td></tr></table>
</div>
</div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://lishensuo.github.io/en/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">æ·±åº¦å­¦ä¹ </a></li>
      <li><a href="https://lishensuo.github.io/en/tags/d2l/">D2L</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://lishensuo.github.io/en/posts/bioinfo/710d2l-%E7%AC%AC%E4%B8%83%E7%AB%A0%E7%8E%B0%E4%BB%A3%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/">
    <span class="title">Â« Prev Page</span>
    <br>
    <span>D2L--ç¬¬ä¸ƒç« ç°ä»£å·ç§¯ç¥ç»ç½‘ç»œ</span>
  </a>
  <a class="next" href="https://lishensuo.github.io/en/posts/bioinfo/712d2l-%E7%AC%AC%E4%B9%9D%E7%AB%A0%E7%8E%B0%E4%BB%A3%E5%BE%AA%E7%8E%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/">
    <span class="title">Next Page Â»</span>
    <br>
    <span>D2L--ç¬¬ä¹ç« ç°ä»£å¾ªç¯ç¥ç»ç½‘ç»œ</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2025 <a href="https://lishensuo.github.io/en/">Li&#39;s Bioinfo-Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
		<br/>æ‚¨æ˜¯æœ¬ç«™ç¬¬ <span id="busuanzi_value_site_uv"></span> ä½è®¿é—®è€…ï¼Œæ€»æµè§ˆé‡ä¸º <span id="busuanzi_value_site_pv"></span> æ¬¡
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'copy';

        function copyingDone() {
            copybutton.innerText = 'copied!';
            setTimeout(() => {
                copybutton.innerText = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>

<script type="text/javascript"
async
src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
tex2jax: {
inlineMath: [['$','$'], ['\\(','\\)']],
displayMath: [['$$','$$'], ['\[\[','\]\]']],
processEscapes: true,
processEnvironments: true,
skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
TeX: { equationNumbers: { autoNumber: "AMS" },
extensions: ["AMSmath.js", "AMSsymbols.js"] }
}
});

MathJax.Hub.Queue(function() {



var all = MathJax.Hub.getAllJax(), i;
for(i = 0; i < all.length; i += 1) {
all[i].SourceElement().parentNode.className += ' has-jax';
}
});
</script>

<style>
code.has-jax {
font: inherit;
font-size: 100%;
background: inherit;
border: inherit;
color: #515151;
}
</style></body>
</html>
